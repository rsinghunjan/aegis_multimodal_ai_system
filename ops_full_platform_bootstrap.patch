*** Begin Patch
*** Add File:ops/full_platform_bootstrap.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Full platform bootstrap orchestrator
+# This script runs the recommended sequence to bring up the Aegis platform automation.
+# It calls smaller operator scripts already present in the repo. All sensitive values must
+# be supplied via environment variables or local tfvars; nothing is stored in git.
+#
+# Usage:
+#   export REPO="owner/repo"
+#   export EVIDENCE_BUCKET="aegis-evidence-123"
+#   export COSIGN_KMS_ARN="arn:aws:kms:..."
+#   export REKOR_URL="https://rekor.example.com"
+#   export MLFLOW_TRACKING_URI="https://mlflow.example.com"
+#   export AWS_ROLE_TO_ASSUME="arn:aws:iam::123:role/ci-oidc-role"
+#   export GITHUB_TOKEN="ghp_..."            # for in-cluster promoter secret (OPTIONAL)
+#   ./ops/full_platform_bootstrap.sh
+
+ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
+cd "${ROOT_DIR}"
+
+echo "Aegis full platform bootstrap starting..."
+
+echo
+echo "STEP 1: Infra & identity (IRSA) - apply terraform/irsa"
+echo "Make sure you have created terraform/irsa/my.tfvars locally (do NOT commit)."
+if [ -f terraform/irsa/my.tfvars ]; then
+  bash terraform/irsa/apply_irsa.sh terraform/irsa/my.tfvars
+else
+  echo "ERROR: terraform/irsa/my.tfvars not found. Copy and edit terraform/irsa/my.tfvars.example first."
+  exit 2
+fi
+
+echo
+echo "STEP 2: Annotate ServiceAccounts (IRSA)"
+if [ -f /tmp/irsa_outputs.json ]; then
+  bash terraform/irsa/irsa_annotate_sa.sh /tmp/irsa_outputs.json || true
+else
+  echo "Warning: /tmp/irsa_outputs.json not found; ensure terraform outputs were written and rerun irsa_annotate_sa.sh manually."
+fi
+
+echo
+echo "STEP 3: Secrets & keys â€” provision GitHub secrets and apply ExternalSecrets"
+# Validate environment variables required for provisioning GitHub secrets
+required_env=(REPO COSIGN_KMS_ARN REKOR_URL EVIDENCE_BUCKET MLFLOW_TRACKING_URI)
+for v in "${required_env[@]}"; do
+  if [ -z "${!v:-}" ]; then
+    echo "ERROR: Environment variable ${v} is not set. Export it and re-run this script."
+    exit 2
+  fi
+done
+
+export REPO
+export COSIGN_KMS_ARN
+export REKOR_URL
+export EVIDENCE_BUCKET
+export MLFLOW_TRACKING_URI
+export AWS_ROLE_TO_ASSUME=${AWS_ROLE_TO_ASSUME:-}
+
+bash ops/provision_github_and_k8s_secrets.sh
+
+echo
+echo "STEP 4: Registry & CI permissions - ensure Actions OIDC role exists"
+echo "If you created a GitHub OIDC role for Actions, ensure secrets.AWS_ROLE_TO_ASSUME is set in the repo and points to that role."
+echo "You can validate by running: gh secret view AWS_ROLE_TO_ASSUME --repo ${REPO}"
+
+echo
+echo "STEP 5: GitOps & ArgoCD - install ArgoCD and register GitOps application"
+echo "Installing ArgoCD (Helm) and creating Application manifest..."
+bash ops/install_argocd_helm.sh
+# Apply the Application manifest template; operator should replace placeholders before applying
+if grep -q "REPLACE_GITOPS_OWNER" argocd/application-gitops-staging.yaml; then
+  echo "Please edit argocd/application-gitops-staging.yaml to set REPLACE_GITOPS_OWNER/REPLACE_GITOPS_REPO then apply it:"
+  echo "  kubectl apply -f argocd/application-gitops-staging.yaml"
+else
+  kubectl apply -f argocd/application-gitops-staging.yaml
+fi
+
+echo
+echo "STEP 6: Networking & routing - install service mesh and metric-proxy"
+echo "Install Istio (demo) and deploy metric-proxy (adjust PROMETHEUS internal URL as needed)."
+bash ops/install_service_mesh_and_metric_proxy.sh "${PROMETHEUS_INTERNAL_URL:-REPLACE_PROMETHEUS_INTERNAL_URL}"
+
+echo
+echo "STEP 7: RBAC & policy - install Gatekeeper & enforce branch protection"
+bash ops/setup_gatekeeper_and_branch_protection.sh
+
+echo
+echo "STEP 8: Legal & governance - upload legal signoff (if provided) and enforce CI checks"
+if [ -n "${GITHUB_TOKEN:-}" ]; then
+  export GITHUB_TOKEN
+  if [ -f ops/legal_signoff.md ]; then
+    ./ops/upload_signed_legal_and_enable_checks.sh ops/legal_signoff.md
+  else
+    echo "No ops/legal_signoff.md found. Place the signed file at ops/legal_signoff.md and re-run upload."
+  fi
+else
+  echo "GITHUB_TOKEN not set; skipping in-cluster promoter secret creation and branch protection changes that require token."
+fi
+
+echo
+echo "STEP 9: Testing & tuning - run SLO tuning and verification"
+bash ops/tune_and_validate_slos.sh "${METRIC_PROXY_URL:-http://metric-proxy.aegis.svc.cluster.local:8080}" || true
+
+echo
+echo "STEP 10: Acceptance tests - run quick smoke tests"
+bash ops/run_acceptance_tests.sh "${SMOKE_TEST_IMAGE:-REPLACE_IMAGE}" || true
+
+echo
+echo "Bootstrap complete. Inspect logs above for any manual follow-ups. Remember to NOT commit any secrets or tfvars to git."
+
*** End Patch
*** Begin Patch
*** Add File:ops/deploy_argocd_and_application.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Deploy ArgoCD (Helm) and then apply the gitops Application manifest
+#
+if ! command -v helm >/dev/null 2>&1; then
+  echo "helm not found; please install Helm CLI"
+  exit 2
+fi
+
+echo "Install ArgoCD via Helm..."
+bash ops/install_argocd_helm.sh
+
+echo "Applying ArgoCD Application manifest (edit placeholders first if present)..."
+if grep -q "REPLACE_GITOPS_OWNER" argocd/application-gitops-staging.yaml; then
+  echo "Please edit argocd/application-gitops-staging.yaml to set REPLACE_GITOPS_OWNER/REPLACE_GITOPS_REPO."
+  echo "Once edited, run: kubectl apply -f argocd/application-gitops-staging.yaml"
+else
+  kubectl apply -f argocd/application-gitops-staging.yaml
+fi
+
+echo "ArgoCD installed & Application applied (if placeholders were replaced)."
+
*** End Patch
*** Begin Patch
*** Add File:ops/deploy_mesh_and_metric_proxy.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Install service mesh (Istio demo via istioctl wrapper) and deploy metric-proxy
+PROM_URL=${1:-REPLACE_PROMETHEUS_INTERNAL_URL}
+
+echo "Installing Istio..."
+bash istio/install_istio.sh || true
+
+echo "Deploying metric-proxy config and deployment..."
+kubectl apply -f ops/metric-proxy-configmap.yaml
+kubectl apply -f ops/metric-proxy-deployment.yaml
+
+echo "Patching metric-proxy with PROMETHEUS_URL=${PROM_URL}"
+kubectl -n aegis patch deployment metric-proxy --patch "{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"proxy\",\"env\":[{\"name\":\"PROMETHEUS_URL\",\"value\":\"${PROM_URL}\"}]}]}}}}"
+
+echo "Labeling namespace 'aegis' for sidecar injection"
+kubectl label namespace aegis istio-injection=enabled --overwrite || true
+
+echo "Mesh & metric-proxy deployed. Ensure Prometheus is reachable from namespace aegis at ${PROM_URL}."
+
*** End Patch
*** Begin Patch
*** Add File:ops/enforce_policy_and_branch_protection.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Install Gatekeeper and apply constraints; set branch protection in GitHub to require CI & approvals.
+#
+REPO=${REPO:-REPLACE_GITHUB_REPOSITORY}
+BRANCH=${TARGET_BRANCH:-main}
+
+echo "Installing Gatekeeper..."
+bash ops/install_gatekeeper.sh
+
+echo "Applying Gatekeeper constraints (k8s/gatekeeper/constraint_qpu_approved.yaml)"
+kubectl apply -f k8s/gatekeeper/constraint_qpu_approved.yaml || true
+
+echo "Setting GitHub branch protection on ${REPO}:${BRANCH}"
+if [ -z "${GITHUB_TOKEN:-}" ]; then
+  echo "GITHUB_TOKEN not set; cannot configure branch protection via API. Please set and re-run this script if you want automation."
+  exit 0
+fi
+
+required_contexts=('ci_train_validate_register' 'image_build_cosign' 'sanitizer')
+# Convert bash array to JSON array
+json_contexts=$(printf '"%s",' "${required_contexts[@]}")
+json_contexts="[${json_contexts%,}]"
+
+gh api --method PUT /repos/${REPO}/branches/${BRANCH}/protection -f required_status_checks.strict=true -f "required_status_checks.contexts=${json_contexts}" -f enforce_admins=true -f required_pull_request_reviews.required_approving_review_count=1
+
+echo "Branch protection configured for ${REPO}:${BRANCH}."
+
*** End Patch
*** Begin Patch
*** Add File:ops/verify_full_setup.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Quick verification script to check key components are present after bootstrap.
+#
+echo "1) Check ArgoCD server pods"
+kubectl -n argocd get pods || true
+
+echo "2) Check Argo Workflows controller"
+kubectl -n argo get pods || true
+
+echo "3) Check metric-proxy service"
+kubectl -n aegis get svc metric-proxy || true
+
+echo "4) Check Gatekeeper pods"
+kubectl -n gatekeeper-system get pods || true
+
+echo "5) Check ExternalSecrets (if operator installed)"
+kubectl -n aegis get externalsecret || true
+
+echo "6) Check promoter deployment"
+kubectl -n aegis get deployment gitops-promoter || true
+
+echo "7) Check SLO configmap"
+kubectl -n aegis get configmap aegis-slo-config -o yaml || true
+
+echo "8) Check GitHub Secrets (sample)"
+for s in COSIGN_KMS_ARN REKOR_URL EVIDENCE_BUCKET MLFLOW_TRACKING_URI; do
+  if gh secret view "${s}" --repo "${REPO:-REPLACE_GITHUB_REPOSITORY}" >/dev/null 2>&1; then
+    echo "  GitHub secret ${s}: OK"
+  else
+    echo "  GitHub secret ${s}: MISSING (set it via gh secret set ...)"
+  fi
+done
+
+echo "Verification complete. Any 'MISSING' items indicate follow-up steps required."
+
*** End Patch
*** Begin Patch
*** Add File:docs/bootstrap_quickstart.md
+# Aegis Platform Bootstrap Quickstart
+
+This quickstart documents the order of operations to bring up the Aegis platform automation end-to-end.
+All commands are intended for an operator workstation with kubectl, awscli, gh, helm and terraform access.
+
+1) Prepare local terraform variables (do NOT commit):
+   cp terraform/irsa/my.tfvars.example terraform/irsa/my.tfvars
+   # Edit terraform/irsa/my.tfvars to replace REPLACE_* tokens
+
+2) Export required env vars for secrets provisioning:
+   export REPO="owner/repo"
+   export EVIDENCE_BUCKET="aegis-evidence-123"
+   export COSIGN_KMS_ARN="arn:aws:kms:..."
+   export REKOR_URL="https://rekor.example.com"
+   export MLFLOW_TRACKING_URI="https://mlflow.example.com"
+   export AWS_ROLE_TO_ASSUME="arn:aws:iam::123:role/ci-oidc-role"
+   export GITHUB_TOKEN="ghp_..."   # optional for in-cluster promoter secret creation
+
+3) Run the bootstrap orchestrator:
+   ./ops/full_platform_bootstrap.sh
+
+4) After bootstrap, verify:
+   ./ops/verify_full_setup.sh
+
+5) Run acceptance tests and tune SLOs:
+   ./ops/run_acceptance_tests.sh "REGISTRY/aegis-quantum:TAG"
+   ./ops/tune_and_validate_slos.sh "http://metric-proxy.aegis.svc.cluster.local:8080" 0.5 0.02
+
+Security & governance reminders:
+- Do not commit terraform/my.tfvars or any secret values.
+- Use ExternalSecrets to bring secrets into the cluster; prefer AWS Secrets Manager or HashiCorp Vault.
+- Keep COSIGN_KMS_ARN and REKOR_URL in GitHub Secrets and limit who can modify them.
+
*** End Patch
*** End Patch
