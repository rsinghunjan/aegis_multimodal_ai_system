*** Begin Patch
*** Add File: scripts/orchestrate_cloud_identity_and_backup_setup.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# orchestrate_cloud_identity_and_backup_setup.sh
+# Top-level orchestrator to set up identity, attach least-privilege policies,
+# wire Helm Milvus backup values and optionally create a PR with the changes.
+#
+# This script is intended to be run by an operator with CLI credentials for each cloud
+# and git / gh configured if creating a PR.
+#
+# Usage:
+#   ./scripts/orchestrate_cloud_identity_and_backup_setup.sh --repo owner/name --branch mybranch \
+#     --aws-bucket my-bucket --aws-kms arn:aws:kms:... --aws-role my-irsa-role \
+#     --azure-vault myvault --azure-key mykey --azure-principal-id <objectId> --azure-storage mystorage --azure-container backups \
+#     --alibaba-bucket my-oss --alibaba-kms cn-hangzhou/abcd --alibaba-oidc https://oidc.example --alibaba-annotation aliyun.aliyuncs.com/ram-role --alibaba-role aegis-ram-role \
+#     [--dry-run] [--create-pr yes|no]
+#
+REPO=""
+BRANCH_PREFIX="aegis/hardening"
+BRANCH=""
+PR_TITLE=""
+DRY_RUN=false
+CREATE_PR="no"
+
+# AWS inputs
+AWS_BUCKET=""
+AWS_KMS_ARN=""
+AWS_ROLE_NAME=""
+
+# Azure inputs
+AZ_VAULT=""
+AZ_KEY=""
+AZ_PRINCIPAL_ID=""
+AZ_STORAGE_ACCOUNT=""
+AZ_STORAGE_CONTAINER=""
+AZ_RESOURCE_GROUP=""
+AZ_NAMESPACE="aegis"
+AZ_KSA="milvus-backup-sa"
+AZ_POD_IDENTITY_VARIANT="aad-pod-identity-v1"
+
+# Alibaba inputs
+ALIYUN_BUCKET=""
+ALIYUN_KMS=""
+ALIYUN_OIDC=""
+ALIYUN_ANNOTATION=""
+ALIYUN_ROLE=""
+
+usage() {
+  cat <<EOF
+Usage: $0 [flags]
+  --repo owner/name
+  --branch-prefix PREFIX
+  --branch BRANCH
+  --pr-title "Title"
+  --dry-run
+  --create-pr yes|no
+
+  Cloud specific flags:
+    --aws-bucket BUCKET --aws-kms KMS_ARN --aws-role ROLE_NAME
+    --azure-vault VAULT --azure-key KEY --azure-principal-id ID --azure-storage ACCOUNT --azure-container CONTAINER --azure-rg RG
+    --alibaba-bucket BUCKET --alibaba-kms KMS_ID --alibaba-oidc OIDC_URL --alibaba-annotation ANNOTATION_KEY --alibaba-role ROLE_NAME
+
+EOF
+}
+
+while [ $# -gt 0 ]; do
+  case "$1" in
+    --repo) REPO="$2"; shift 2;;
+    --branch-prefix) BRANCH_PREFIX="$2"; shift 2;;
+    --branch) BRANCH="$2"; shift 2;;
+    --pr-title) PR_TITLE="$2"; shift 2;;
+    --dry-run) DRY_RUN=true; shift;;
+    --create-pr) CREATE_PR="$2"; shift 2;;
+    --aws-bucket) AWS_BUCKET="$2"; shift 2;;
+    --aws-kms) AWS_KMS_ARN="$2"; shift 2;;
+    --aws-role) AWS_ROLE_NAME="$2"; shift 2;;
+    --azure-vault) AZ_VAULT="$2"; shift 2;;
+    --azure-key) AZ_KEY="$2"; shift 2;;
+    --azure-principal-id) AZ_PRINCIPAL_ID="$2"; shift 2;;
+    --azure-storage) AZ_STORAGE_ACCOUNT="$2"; shift 2;;
+    --azure-container) AZ_STORAGE_CONTAINER="$2"; shift 2;;
+    --azure-rg) AZ_RESOURCE_GROUP="$2"; shift 2;;
+    --azure-namespace) AZ_NAMESPACE="$2"; shift 2;;
+    --azure-ksa) AZ_KSA="$2"; shift 2;;
+    --azure-variant) AZ_POD_IDENTITY_VARIANT="$2"; shift 2;;
+    --alibaba-bucket) ALIYUN_BUCKET="$2"; shift 2;;
+    --alibaba-kms) ALIYUN_KMS="$2"; shift 2;;
+    --alibaba-oidc) ALIYUN_OIDC="$2"; shift 2;;
+    --alibaba-annotation) ALIYUN_ANNOTATION="$2"; shift 2;;
+    --alibaba-role) ALIYUN_ROLE="$2"; shift 2;;
+    -h|--help) usage; exit 0;;
+    *) echo "Unknown arg $1"; usage; exit 2;;
+  esac
+done
+
+set -x
+
+if [ -z "$REPO" ]; then
+  echo "Repository not provided. Use --repo owner/name"
+  exit 2
+fi
+
+BRANCH="${BRANCH:-${BRANCH_PREFIX}/$(date -u +%Y%m%dT%H%M%SZ)}"
+PR_TITLE="${PR_TITLE:-hardening: attach least-privilege policies & wire backups}"
+
+echo "DRY_RUN=$DRY_RUN, CREATE_PR=$CREATE_PR"
+
+# Create workdir
+WORKDIR="$(mktemp -d)"
+pushd "$WORKDIR"
+
+git clone "https://github.com/${REPO}.git" repo || { echo "failed to clone repo"; exit 1; }
+cd repo
+git checkout -b "$BRANCH"
+
+# AWS: generate and commit policy JSONs & attach script parameters
+if [ -n "$AWS_BUCKET" ] && [ -n "$AWS_KMS_ARN" ] && [ -n "$AWS_ROLE_NAME" ]; then
+  mkdir -p infra/iam/aws/generated
+  sed "s|YOUR_MILVUS_BACKUP_BUCKET|${AWS_BUCKET}|g; s|arn:aws:kms:REGION:ACCOUNT_ID:key/REPLACE_ME_KEY_ID|${AWS_KMS_ARN}|g" ../../infra/iam/aws/managed_policies/s3_backup_policy_prod_strict.json > infra/iam/aws/generated/s3_backup_policy.json || true
+  sed "s|arn:aws:kms:REGION:ACCOUNT_ID:key/REPLACE_ME_KEY_ID|${AWS_KMS_ARN}|g" ../../infra/iam/aws/managed_policies/kms_policy_prod_strict.json > infra/iam/aws/generated/kms_policy.json || true
+  git add infra/iam/aws/generated
+  git commit -m "chore(aws): generate least-privilege S3+KMS policies for ${AWS_BUCKET}" || true
+fi
+
+# Azure: produce config snippet to call KeyVault script
+if [ -n "$AZ_VAULT" ] && [ -n "$AZ_KEY" ] && [ -n "$AZ_PRINCIPAL_ID" ] && [ -n "$AZ_STORAGE_ACCOUNT" ]; then
+  mkdir -p infra/iam/azure
+  cat > infra/iam/azure/assign_keyvault_and_storage_setup.sh <<'EOF'
+#!/usr/bin/env bash
+# wrapper to call repository script
+scripts/configure_keyvault_and_storage_cmk.sh --vault '%%VAULT%%' --key-name '%%KEY%%' --principal-id '%%PRINCIPAL%%' --storage-account '%%STORAGE%%' --resource-group '%%RG%%'
+EOF
+  sed -i "s|%%VAULT%%|${AZ_VAULT}|g" infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  sed -i "s|%%KEY%%|${AZ_KEY}|g" infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  sed -i "s|%%PRINCIPAL%%|${AZ_PRINCIPAL_ID}|g" infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  sed -i "s|%%STORAGE%%|${AZ_STORAGE_ACCOUNT}|g" infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  sed -i "s|%%RG%%|${AZ_RESOURCE_GROUP}|g" infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  chmod +x infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  git add infra/iam/azure/assign_keyvault_and_storage_setup.sh
+  git commit -m "chore(azure): add wrapper to assign Key Vault & configure storage CMK" || true
+fi
+
+# Alibaba: generate RAM policy and milvus values
+if [ -n "$ALIYUN_BUCKET" ] && [ -n "$ALIYUN_KMS" ] && [ -n "$ALIYUN_OIDC" ] && [ -n "$ALIYUN_ROLE" ]; then
+  mkdir -p infra/iam/alibaba/generated
+  sed "s|{{OSS_BUCKET}}|${ALIYUN_BUCKET}|g; s|{{KMS_KEY_ID}}|${ALIYUN_KMS}|g" ../../infra/iam/alibaba/ram_policy_template.json.template > infra/iam/alibaba/generated/ram_policy.json
+  git add infra/iam/alibaba/generated
+  git commit -m "chore(alibaba): generate RAM policy for ${ALIYUN_BUCKET}" || true
+
+  # update milvus values with provided bucket and KMS
+  python3 ../../scripts/update_milvus_alibaba_values.py --bucket "${ALIYUN_BUCKET}" --endpoint "${ALIYUN_OIDC#https://}" --region "cn-region" --kms-key-id "${ALIYUN_KMS}" || true
+  git add infra/overrides/alibaba/milvus-values-ack.yaml || true
+  git commit -m "chore(alibaba): set milvus values for OSS bucket ${ALIYUN_BUCKET}" || true
+fi
+
+if [ "$DRY_RUN" = "true" ]; then
+  echo "DRY RUN mode - not pushing changes"
+  popd
+  rm -rf "$WORKDIR"
+  exit 0
+fi
+
+if [ "$CREATE_PR" = "yes" ]; then
+  git push --set-upstream origin "$BRANCH"
+  gh pr create --title "${PR_TITLE}" --body "Automated hardening: attach least-privilege policies and wire backups" --base main --head "$BRANCH" || true
+  echo "PR created"
+else
+  git push --set-upstream origin "$BRANCH"
+  echo "Branch pushed: $BRANCH (no PR created)"
+fi
+
+popd
+rm -rf "$WORKDIR"
+echo "Orchestration completed."
+
*** End Patch
*** Begin Patch
*** Add File: scripts/apply_least_privilege_policies.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# apply_least_privilege_policies.sh
+# Apply least-privilege policies for AWS / Azure / Alibaba as requested.
+#
+# Usage examples:
+#  ./scripts/apply_least_privilege_policies.sh --aws --bucket my-bucket --kms arn:aws:kms:... --role my-irsa-role
+#  ./scripts/apply_least](#)
î€€
