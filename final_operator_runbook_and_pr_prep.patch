*** Begin Patch
*** Add File:docs/operator_runbook.md
+# Aegis Operator Runbook — Finalize Production Hardening
+
+Purpose
+- This runbook gives SRE / platform operators a single, copy/pasteable sequence to finalize Aegis into a hardened, production posture. Replace placeholders (shown in ALL_CAPS) before running.
+
+Prerequisites
+- kubectl configured and able to access the target cluster (kubectl context: KUBECTL_CONTEXT)
+- AWS CLI configured with an operator IAM user (permissions: SecretsManager, S3, CloudTrail, KMS, IAM as needed)
+- gh CLI installed and authenticated (repo: GITHUB_REPOSITORY)
+- cosign installed locally (for spot checks)
+- Helm installed
+- jq, bash, docker (for local checks)
+
+Required inputs (values to substitute / provide):
+- GITHUB_REPOSITORY=owner/repo
+- GHCR_ORG=ghcr.io/yourorg
+- IMAGE_TAG=latest
+- TF_OUT=/path/to/aegis_tf_output.json (Terraform output JSON with cosign_kms_arn, evidence_bucket, rekor_url, etc.)
+- IRSA_MAP_FILE=/path/to/irsa_map.tsv (TSV: namespace<TAB>serviceaccount<TAB>role-arn)
+- REPLACE_MAP_FILE=/path/to/replace_map.tsv (TSV: pattern<TAB>replacement for demo refs)
+- KUBECTL_CONTEXT=your-kube-context (optional)
+- EVIDENCE_BUCKET=your-evidence-bucket
+- REKOR_URL=https://rekor.server (optional)
+
+High-level steps (one-liner)
+1. Annotate SAs for IRSA → 2. Build & sign images → 3. Wire images into overlays & deploy → 4. Apply HA Helm values → 5. Run DR drill & review RTO → 6. Deploy cert-manager + TLS + MCPx auth + Gatekeeper → 7. Generate baselines & tune Prometheus → 8. Replace demo refs & run smoke tests → 9. Manual audit & acceptance checks
+
+Detailed step-by-step (copy/paste)
+
+Step 0 — Set environment variables
+export GITHUB_REPOSITORY="owner/repo"
+export GHCR_ORG="ghcr.io/yourorg"
+export IMAGE_TAG="latest"
+export TF_OUT="/tmp/aegis_tf_output.json"
+export IRSA_MAP_FILE="/path/to/irsa_map.tsv"
+export REPLACE_MAP_FILE="/path/to/replace_map.tsv"
+export KUBECTL_CONTEXT="your-kube-context"   # Optional
+export EVIDENCE_BUCKET="aegis-evidence-12345"
+export REKOR_URL="https://rekor.server"      # Optional
+
+Step 1 — Verify TF outputs & populate GitHub secrets
+# Make sure TF_OUT exists (produced by Terraform apply)
+jq . "$TF_OUT"
+
+# Populate GitHub secrets and verify ExternalSecrets sync
+KUBECTL_CTX_ARG=""
+if [ -n "${KUBECTL_CONTEXT:-}" ]; then KUBECTL_CTX_ARG="--kubectl-context $KUBECTL_CONTEXT"; fi
+./ops/populate_and_verify_secrets_irsa.sh "$TF_OUT" "${KUBECTL_CONTEXT:-}"
+
+Step 2 — Annotate ServiceAccounts (IRSA)
+# Ensure your IRSA mapping file lines like:
+# security\tcosign-signer\tarn:aws:iam::123456789012:role/aegis-cosign-irsa-role
+./ops/annotate_serviceaccounts.sh "$IRSA_MAP_FILE" $KUBECTL_CTX_ARG
+kubectl $KUBECTL_CTX_ARG -n security get sa cosign-signer -o yaml
+
+Step 3 — Trigger image build + verify signatures
+./ops/run_build_and_verify.sh "$IMAGE_TAG"
+# If it completes successfully, images are in $GHCR_ORG/*:$IMAGE_TAG and cosign/rekor verify passed
+
+Step 4 — Wire images into kustomize overlays and deploy
+./ops/wire_images_into_kustomize.sh --registry "$GHCR_ORG" --tag "$IMAGE_TAG" --overlay k8s/overlays/staging
+./ops/apply_kustomize_and_deploy.sh k8s/overlays/staging $KUBECTL_CTX_ARG
+kubectl $KUBECTL_CTX_ARG -n aegis get pods -o wide
+
+Step 5 — Deploy HA charts (Postgres/Milvus/Redis)
+# Review k8s/ha/production_values.yaml before running
+./ops/deploy_ha_helm.sh
+# Monitor rollouts:
+kubectl $KUBECTL_CTX_ARG -n aegis rollout status deploy/aegis-postgres
+kubectl $KUBECTL_CTX_ARG -n aegis rollout status sts/aegis-milvus
+
+Step 6 — Run DR drill & capture report
+./ops/run_dr_and_review.sh "$TF_OUT" /tmp/dr_final_report.json
+cat /tmp/dr_final_report.json
+# Review keys: postrestore_completed, milvus_status, and RTO seconds from previous scripts
+
+Step 7 — Security hardening (cert-manager, TLS ingress, MCPx auth, Gatekeeper)
+./ops/deploy_security_hardening.sh
+kubectl $KUBECTL_CTX_ARG -n cert-manager get pods
+kubectl $KUBECTL_CTX_ARG -n aegis get ingress
+
+Step 8 — Tighten IAM (manual review)
+./ops/tighten_iam_apply_hint.sh
+# Apply policy only after manual review:
+# aws iam create-policy --policy-name aegis-least-privilege --policy-document file://iam/least_privilege_full.json
+# then attach to IRSA roles per your security review
+
+Step 9 — Monitoring baselines & tuned rules
+SAMPLE_S3="s3://${EVIDENCE_BUCKET}/monitoring/baseline_sample.parquet"
+./ops/run_monitoring_tuning.sh "$SAMPLE_S3"
+# Validate Prometheus UI: tuned_prometheus_rules.yaml applied; check firing alerts and disable/adjust noisy rules
+
+Step 10 — Demo replacement & parallel inference smoke test
+./ops/replace_demo_and_smoke.sh "$REPLACE_MAP_FILE" "https://kserve.aegis.example.com/v1/models/aegis-model:predict"
+
+Step 11 — Acceptance checks (audit)
+# Verify images/signatures in registry and Rekor
+cosign verify --rekor-server ${REKOR_URL:-} "${GHCR_ORG}/aegis-spark:${IMAGE_TAG}"
+# Verify Gatekeeper rejects unsigned pods (try to deploy a test unsigned Deployment)
+kubectl $KUBECTL_CTX_ARG -n aegis apply -f tests/unsigned-deployment.yaml || true
+
+If everything passes
+- Record the DR report (store in evidence bucket and MLflow run / ticket)
+- Tag the release in git and update release notes
+- Schedule a post-mortem & monitoring review in 24–72 hours
+
+Rollback procedures
+- If a deployment causes incidents, use:
+  kubectl -n aegis rollout undo deployment/<name>
+- Restore Postgres from backup using the DR scripts (see scripts/dr)
+
+Notes
+- Many steps require manual IAM updates — do not automate IAM attachments without peer review.
+- Replace placeholder URLs and ARNs before running.
+- Keep the TF output JSON secure and rotate secrets as needed after runs.
+
*** End Patch
*** Begin Patch
*** Add File:ops/create_pr_wiring_images.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Prepare and open a PR that wires GHCR/ECR image names into kustomize/Helm overlays.
+#
+# Usage:
+#   ./ops/create_pr_wiring_images.sh --repo owner/repo --branch feature/wire-images --registry ghcr.io/yourorg --tag latest
+#
+while [[ $# -gt 0 ]]; do
+  case $1 in
+    --repo) REPO="$2"; shift 2;;
+    --branch) BRANCH="$2"; shift 2;;
+    --registry) REGISTRY="$2"; shift 2;;
+    --tag) TAG="$2"; shift 2;;
+    *) echo "Unknown arg $1"; exit 2;;
+  esac
+done
+
+: "${REPO:?--repo required}"
+: "${BRANCH:=wire-images}"
+: "${REGISTRY:?--registry required}"
+: "${TAG:=latest}"
+
+TMPDIR=$(mktemp -d)
+echo "Cloning repo $REPO into $TMPDIR"
+git clone "https://github.com/${REPO}.git" "$TMPDIR"
+cd "$TMPDIR"
+git checkout -b "$BRANCH"
+
+echo "Applying image wiring (sed replacements in k8s overlays)"
+# Use the same logic as ops/wire_images_into_kustomize.sh but operate on the cloned repo
+find . -path "./k8s/overlays/*" -type f -name "*.yaml" -o -name "*.yml" | while read -r f; do
+  sed -i.bak -E "s|ghcr.io/yourorg/([a-zA-Z0-9_\\-]+):?latest|${REGISTRY}/\\1:${TAG}|g" "$f" || true
+done
+
+git add -A
+git commit -m "chore: wire images to ${REGISTRY}:${TAG} for overlays"
+git push origin "$BRANCH"
+
+echo "Opening PR against main"
+gh pr create --repo "$REPO" --base main --head "$BRANCH" --title "chore: wire images to ${REGISTRY}:${TAG}" --body "Automated PR wiring images for staging/production overlays. Verify and merge."
+
+echo "PR created. Monitor CI for build/sign and merge when ready."
+
*** End Patch
*** Begin Patch
*** Add File:docs/interactive_hardening_guide.md
+# Interactive Hardening Guide — Walkthrough and How to Interpret Outputs
+
+This guide helps an operator run the orchestration script interactively and interpret the main outputs and checks.
+
+1) Gather TF output details
+- The Terraform JSON (TF_OUT) should include:
+  - cosign_kms_arn
+  - evidence_bucket
+  - rekor_url
+  - db_secret_arn (if used)
+  - iam role ARNs (if exported)
+
+Command:
+jq . /tmp/aegis_tf_output.json
+
+2) Run IRSA & secrets verification
+- Command:
+./ops/populate_and_verify_secrets_irsa.sh /tmp/aegis_tf_output.json YOUR_KUBE_CONTEXT
+- Expected: GitHub secrets set (COSIGN_KMS_ARN, REKOR_URL, EVIDENCE_BUCKET). k8s Secrets: aegis-cosign, aegis-rekor, aegis-db-creds present.
+- If missing: check ExternalSecrets controller logs:
+kubectl -n external-secrets logs deploy/external-secrets || kubectl -n security logs deploy/external-secrets
+
+3) Annotate ServiceAccounts
+- Run:
+./ops/annotate_serviceaccounts.sh irsa_map.tsv --kubectl-context YOUR_KUBE_CONTEXT
+- Verify:
+kubectl -n security get sa cosign-signer -o yaml
+- Look for annotation: eks.amazonaws.com/role-arn: arn:aws:iam::123:role/role-name
+
+4) Trigger image build and verify signatures
+- Trigger using:
+./ops/run_build_and_verify.sh latest
+- Check GitHub Actions run status via:
+gh run list --repo OWNER/REPO --workflow build_and_push_all_images.yml
+- After success: run cosign verify locally to spot-check:
+cosign verify --rekor-server https://rekor.server ghcr.io/yourorg/aegis-spark:latest
+- If verification fails: inspect action logs and Rekor entries; verify COSIGN_KMS_ARN in GitHub secrets.
+
+5) Apply overlays and confirm pods
+- Wire images locally (or create PR via ops/create_pr_wiring_images.sh)
+- Apply:
+./ops/apply_kustomize_and_deploy.sh k8s/overlays/staging --kubectl-context YOUR_KUBE_CONTEXT
+- Verify pods:
+kubectl -n aegis get pods -o wide
+- If pods CrashLoopBackOff: kubectl -n aegis logs <pod> and check events: kubectl -n aegis describe pod <pod>
+
+6) DR drill outputs to examine
+- DR script writes /tmp/dr_report.json containing:
+  - start, postrestore_completed, milvus_status
+- Key metrics:
+  - RTO (time difference between start and postrestore_completed)
+  - milvus_status: ok / not_ready / not_deployed
+- If RTO > target: increase PVC sizes, faster restore paths, or pre-warm instances.
+
+7) Security hardening checks
+- Cert-manager installed:
+kubectl -n cert-manager get pods
+- Ingress TLS:
+kubectl -n aegis get ingress
+- MCPx logger auth:
+kubectl -n aegis get deploy mcpx-logger
+kubectl -n aegis describe cm mcpx-nginx-config
+- Gatekeeper constraints: ensure they are enforced by attempting a non-signed deployment (should be denied)
+
+8) Monitoring & Alert testing
+- After applying tuned rules:
+kubectl -n monitoring get prometheusrule
+- Test an alert pathway:
+  - Simulate a metric (if possible) or force a rule to fire using recording rules or pushgateway
+  - Confirm Alertmanager routing to PagerDuty/Slack
+- Check for noisy rules and increase "for" or raise thresholds as needed
+
+9) Replace demo refs & smoke
+- Run replacer:
+./ops/replace_demo_refs_confirm.sh replace_map.tsv
+- Run parallel inference:
+python3 testing/parallel_inference_runner.py --endpoint https://kserve.aegis.example.com/v1/models/aegis-model:predict --concurrency 50 --requests 500
+- Interpret results: success rate close to 100% and duration acceptable; otherwise inspect KServe pods, GPU saturation, and logs
+
+10) Final acceptance checklist (pass/fail)
+- Secrets/IRSA OK
+- Images cosign verified & Rekor entries present
+- Critical pods Ready & Stable for 15+ minutes
+- DR drill RTO within target
+- TLS enabled for KServe ingress
+- MCPx logger authenticates requests and writes to evidence bucket
+- Prometheus alerts tuned and routed
+- No remaining "demo" references in repo
+
+If any item fails, collect:
+- kubectl -n aegis describe pod, logs
+- gh run view <run_id>
+- aws cloudtrail lookup-events --start-time <start> --lookup-attributes AttributeKey=ResourceName,AttributeValue=<value>
+
*** End Patch
*** End Patch
