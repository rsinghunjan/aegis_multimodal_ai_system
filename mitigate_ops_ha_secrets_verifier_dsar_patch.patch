*** Begin Patch
*** Add File:ops/run_one_button.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Operator helper: build & publish images, set GitHub secrets and run the one-button bootstrap.
+# Review and export secrets before running. Intended for interactive operator usage.
+#
+REPO_OWNER=${REPO_OWNER:-$(git config --get remote.origin.url | sed -E 's#.*/([^/]+)\.git#\1#' || echo "org")}
+REPO_NAME=${REPO_NAME:-${GITHUB_REPOSITORY:-owner/repo}}
+GHCR_ORG=${GHCR_ORG:-${REPO_OWNER}}
+KUBECONFIG=${KUBECONFIG:-"$HOME/.kube/config"}
+
+usage() {
+  cat <<EOF
+Usage: $0
+Environment variables (required):
+  GITHUB_TOKEN         - token with repo:write and secrets permissions (or use gh auth login)
+  AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY
+  COSIGN_KMS_ARN       - awskms://... for cosign
+  REKOR_URL
+  EVIDENCE_BUCKET
+  DB_PASSWORD
+  KUBECONFIG_STAGING   - base64-encoded kubeconfig or path to kubeconfig file
+
+Examples:
+  export GITHUB_TOKEN=...
+  export COSIGN_KMS_ARN=awskms://...
+  ./ops/run_one_button.sh
+EOF
+}
+
+if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
+  usage
+  exit 0
+fi
+
+echo "[1/8] Validate environment"
+: "${GITHUB_TOKEN:?set GITHUB_TOKEN}"
+: "${COSIGN_KMS_ARN:?set COSIGN_KMS_ARN}"
+: "${REKOR_URL:?set REKOR_URL}"
+: "${EVIDENCE_BUCKET:?set EVIDENCE_BUCKET}"
+: "${DB_PASSWORD:?set DB_PASSWORD}"
+: "${AWS_ACCESS_KEY_ID:?set AWS_ACCESS_KEY_ID}"
+: "${AWS_SECRET_ACCESS_KEY:?set AWS_SECRET_ACCESS_KEY}"
+
+echo "[2/8] Build and push images to GHCR"
+docker build -t ghcr.io/${GHCR_ORG}/${REPO_NAME}-tools:latest -f tools/Dockerfile . || true
+docker push ghcr.io/${GHCR_ORG}/${REPO_NAME}-tools:latest || true
+docker build -t ghcr.io/${GHCR_ORG}/${REPO_NAME}-train:latest -f train/Dockerfile . || true
+docker push ghcr.io/${GHCR_ORG}/${REPO_NAME}-train:latest || true
+
+echo "[3/8] Populate GitHub secrets (interactive)"
+if ! command -v gh >/dev/null 2>&1; then
+  echo "gh CLI not found; place these secrets in repository settings manually: COSIGN_KMS_ARN, REKOR_URL, EVIDENCE_BUCKET, DB_PASSWORD, KUBECONFIG_STAGING"
+else
+  echo "Setting COSIGN_KMS_ARN, REKOR_URL, EVIDENCE_BUCKET, DB_PASSWORD in repo ${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}"
+  echo -n "$COSIGN_KMS_ARN" | gh secret set COSIGN_KMS_ARN --repo "${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}" --body -
+  echo -n "$REKOR_URL" | gh secret set REKOR_URL --repo "${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}" --body -
+  echo -n "$EVIDENCE_BUCKET" | gh secret set EVIDENCE_BUCKET --repo "${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}" --body -
+  echo -n "$DB_PASSWORD" | gh secret set DB_PASSWORD --repo "${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}" --body -
+  if [ -n "${KUBECONFIG_STAGING:-}" ]; then
+    echo -n "$KUBECONFIG_STAGING" | gh secret set KUBECONFIG_STAGING --repo "${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}" --body -
+  fi
+fi
+
+echo "[4/8] Run one-button bootstrap script (local operator)"
+chmod +x ops/full_auto_provision_and_hardening.sh
+./ops/full_auto_provision_and_hardening.sh
+
+echo "[5/8] Verify ExternalSecrets sync"
+kubectl -n security get secret aegis-cosign || echo "aegis-cosign secret missing - check ExternalSecrets controller logs"
+kubectl -n security get secret aegis-rekor || echo "aegis-rekor secret missing - check ExternalSecrets controller logs"
+
+echo "[6/8] Trigger image CI workflow dispatch (image_scan_sign_rekor_block.yml)"
+if command -v gh >/dev/null 2>&1; then
+  gh api repos/${GITHUB_REPOSITORY:-$REPO_OWNER/$REPO_NAME}/actions/workflows/image_scan_sign_rekor_block.yml/dispatches --raw-field ref=main
+else
+  echo "Please dispatch GitHub workflow image_scan_sign_rekor_block.yml manually."
+fi
+
+echo "[7/8] Run smoke tests & verify MLflow/Rekor"
+python3 -m pytest tests/integration -q || echo "Some integration tests failed; inspect logs"
+
+echo "[8/8] Completed. Review outputs and run DR drills"
+echo "Terraform output saved to /tmp/aegis_tf_output.json (if terraform step was run earlier)"
+echo "If any step failed, inspect logs and rerun appropriate commands."
+
*** End Patch
*** Begin Patch
*** Add File:.github/workflows/bootstrap_publish_and_deploy.yml
+name: Bootstrap Publish & Deploy (operator gated)
+
+on:
+  workflow_dispatch:
+
+permissions:
+  contents: write
+  id-token: write
+
+jobs:
+  build-and-await-approval:
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - name: Set up Docker Buildx
+        uses: docker/setup-buildx-action@v2
+      - name: Build & push images
+        run: |
+          docker build -t ghcr.io/${{ github.repository_owner }}/${{ github.repository }}-tools:latest -f tools/Dockerfile .
+          docker push ghcr.io/${{ github.repository_owner }}/${{ github.repository }}-tools:latest
+          docker build -t ghcr.io/${{ github.repository_owner }}/${{ github.repository }}-train:latest -f train/Dockerfile .
+          docker push ghcr.io/${{ github.repository_owner }}/${{ github.repository }}-train:latest
+      - name: Await operator approval (environment protection)
+        uses: actions/github-script@v6
+        with:
+          github-token: ${{ secrets.GITHUB_TOKEN }}
+          script: |
+            console.log("Waiting for operator approval in GitHub environment 'bootstrap-approve'. Use Environment protection rules to approve.")
+
+  run-bootstrap:
+    needs: build-and-await-approval
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - name: Configure AWS
+        uses: aws-actions/configure-aws-credentials@v2
+        with:
+          aws-region: us-west-2
+          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
+          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
+      - name: Run operator run_one_button.sh
+        env:
+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
+          COSIGN_KMS_ARN: ${{ secrets.COSIGN_KMS_ARN }}
+          REKOR_URL: ${{ secrets.REKOR_URL }}
+          EVIDENCE_BUCKET: ${{ secrets.EVIDENCE_BUCKET }}
+          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
+          KUBECONFIG_STAGING: ${{ secrets.KUBECONFIG_STAGING }}
+        run: |
+          chmod +x ops/run_one_button.sh
+          ./ops/run_one_button.sh
+
*** End Patch
*** Begin Patch
*** Add File:velero/values.yaml
+# Template Velero values for S3/backing-store (edit before use)
+configuration:
+  provider: aws
+  backupStorageLocation:
+    name: default
+    bucket: REPLACE_EVIDENCE_BUCKET
+    config:
+      region: us-west-2
+      s3Url: s3.amazonaws.com
+      signatureVersion: "4"
+      sse: "aws:kms"
+  volumeSnapshotLocation:
+    name: default
+    config:
+      region: us-west-2
+
+initContainers: []
+deployment:
+  resources:
+    requests:
+      cpu: 100m
+      memory: 256Mi
+
*** End Patch
*** Begin Patch
*** Add File:velero/install_velero.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Install Velero for cluster backups. Edit values.yaml before running.
+#
+VALUES=velero/values.yaml
+helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts
+helm repo update
+helm upgrade --install velero vmware-tanzu/velero -n velero --create-namespace -f $VALUES
+echo "Velero installed. Configure credentials via secret according to your cloud provider docs."
+
*** End Patch
*** Begin Patch
*** Add File:k8s/postgres/pg_restore_drill.sh
+#!/usr
î€€
