*** Begin Patch
*** Add File:infra/preflight/run_preflight_and_plan.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# run_preflight_and_plan.sh
+# Orchestrates preflight checks and produces terraform plans for all managed modules.
+# This script is safe-by-default: it runs non-destructive preflight checks and produces plan files.
+#
+# Usage:
+#   ./infra/preflight/run_preflight_and_plan.sh --tf-dir terraform/managed --outdir /tmp/aegis-plans
+#
+TF_DIR="terraform/managed"
+OUTDIR="/tmp/aegis-plans"
+
+while [[ $# -gt 0 ]]; do
+  case "$1" in
+    --tf-dir) TF_DIR="$2"; shift 2;;
+    --outdir) OUTDIR="$2"; shift 2;;
+    -h|--help) echo "Usage: $0 [--tf-dir <dir>] [--outdir <outdir>]"; exit 0;;
+    *) echo "Unknown arg $1"; exit 1;;
+  esac
+done
+
+echo "Running terraform preflight checks in: $TF_DIR"
+./infra/preflight/terraform_preflight.sh "$TF_DIR"
+
+mkdir -p "$OUTDIR"
+echo "Generating terraform plans in $OUTDIR (non-destructive)"
+find "$TF_DIR" -maxdepth 2 -type d | while read d; do
+  if [ -f "$d/main.tf" ] || [ -f "$d/elasticache.tf" ] || [ -f "$d/hardened_lakefs.tf" ]; then
+    echo "Preparing plan for $d"
+    pushd "$d" >/dev/null
+    terraform init -backend=false -input=false >/dev/null 2>&1 || true
+    PLAN_FILE="$OUTDIR/$(basename $d)-plan.out"
+    terraform plan -input=false -no-color -out="$PLAN_FILE" || true
+    echo "Plan written: $PLAN_FILE"
+    popd >/dev/null
+  fi
+done
+
+echo "Preflight & plan generation complete. Review plans in $OUTDIR before apply."
+
*** End Patch
*** Begin Patch
*** Add File:infra/terraform/tfvars_for_run.example
+# Example tfvars for running terraform modules in terraform/managed
+# Replace placeholder values (do not commit secrets)
+account_id = "123456789012"
+region = "us-east-1"
+common_tags = {
+  Owner = "platform-team"
+  Env   = "staging"
+}
+# ElastiCache placeholders
+elasticache_subnet_ids = ["subnet-0123abcd","subnet-0456efgh"]
+elasticache_security_group_ids = ["sg-0123456789abcdef0"]
+# S3 / lakeFS
+lakefs_bucket_name = "aegis-lakefs-staging"
+kms_key_id = "arn:aws:kms:us-east-1:123456789012:key/REPLACE-KEY"
+
*** End Patch
*** Begin Patch
*** Add File:ci/build_push_custom/README.md
+Build & Push CI customization
+=============================
+
+This folder contains a GitHub Actions workflow example and instructions to customize it for your container registry.
+
+Files:
+- build_scan_push.yml : the workflow (copy into .github/workflows/)
+- registry_secrets_template.md : guide to create registry/GH secrets.
+
+Security:
+- Do not store plaintext credentials in repo. Use GitHub Actions repository or organization secrets.
+
*** End Patch
*** Begin Patch
*** Add File:ci/build_push_custom/build_scan_push.yml
+name: Build, Scan & Push Images (Custom)
+
+on:
+  workflow_dispatch:
+    inputs:
+      tag:
+        description: 'Image tag (e.g. v1.2.3 or ${GITHUB_RUN_ID})'
+        required: true
+
+env:
+  IMAGES: |
+    aegis-agent-controller
+    aegis-tool-runner
+    aegis-agent-memory
+    aegis-langchain-adapter
+    aegis-volcano-tools
+
+jobs:
+  build-scan-push:
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+
+      - name: Set up Docker Buildx
+        uses: docker/setup-buildx-action@v2
+
+      - name: Login to registry
+        uses: docker/login-action@v2
+        with:
+          registry: ${{ secrets.REGISTRY_HOST }}
+          username: ${{ secrets.REGISTRY_USERNAME }}
+          password: ${{ secrets.REGISTRY_PASSWORD }}
+
+      - name: Build and push images
+        run: |
+          set -euo pipefail
+          TAG="${{ github.event.inputs.tag }}"
+          for img in $IMAGES; do
+            case "$img" in
+              aegis-agent-controller) CONTEXT=agent-manager/controller ;;
+              aegis-tool-runner) CONTEXT=agent-manager/tool-runner ;;
+              aegis-agent-memory) CONTEXT=agent-memory/service ;;
+              aegis-langchain-adapter) CONTEXT=langchain_adapter ;;
+              aegis-volcano-tools) CONTEXT=prod/autoscale/volcano ;;
+              *) CONTEXT=. ;;
+            esac
+            FULL="${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_NAMESPACE }}/${img}:${TAG}"
+            echo "Building $FULL from $CONTEXT"
+            docker build -t "$FULL" "$CONTEXT"
+            echo "Pushing $FULL"
+            docker push "$FULL"
+            echo "$FULL" >> images_built.txt
+          done
+          cat images_built.txt
+
+      - name: Trivy scan images
+        uses: aquasecurity/trivy-action@v1
+        with:
+          image-ref: |
+            ${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_NAMESPACE }}/aegis-agent-controller:${{ github.event.inputs.tag }}
+            ${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_NAMESPACE }}/aegis-tool-runner:${{ github.event.inputs.tag }}
+            ${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_NAMESPACE }}/aegis-agent-memory:${{ github.event.inputs.tag }}
+            ${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_NAMESPACE }}/aegis-langchain-adapter:${{ github.event.inputs.tag }}
+            ${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_NAMESPACE }}/aegis-volcano-tools:${{ github.event.inputs.tag }}
+          format: 'table'
+          severity: 'CRITICAL,HIGH'
+          exit-code: '1'
+
+      - name: Upload SBOM & scan artifacts
+        if: always()
+        uses: actions/upload-artifact@v4
+        with:
+          name: build-artifacts-${{ github.run_id }}
+          path: |
+            images_built.txt
+
*** End Patch
*** Begin Patch
*** Add File:ci/build_push_custom/registry_secrets_template.md
+Registry & GitHub Secrets Template
+=================================
+
+Create the following repository secrets (use gh CLI or GitHub UI):
+- REGISTRY_HOST : e.g., ghcr.io or registry.hub.docker.com
+- REGISTRY_USERNAME : username (for ghcr, use GITHUB_ACTOR with a PAT if required)
+- REGISTRY_PASSWORD : registry token or PAT (never commit)
+- REGISTRY_NAMESPACE : org or user namespace (e.g., your-org)
+
+To set via gh CLI:
+  gh secret set REGISTRY_HOST --repo your-org/your-repo --body "ghcr.io"
+  gh secret set REGISTRY_USERNAME --repo your-org/your-repo --body "your-username"
+  gh secret set REGISTRY_PASSWORD --repo your-org/your-repo --body "$(cat ~/.registry_token)"
+  gh secret set REGISTRY_NAMESPACE --repo your-org/your-repo --body "your-org"
+
*** End Patch
*** Begin Patch
*** Add File:security/pentest/final_pentest_bundle.sh
+#!/usr/bin/env bash
+set -euo pipefail
+OUTDIR=${OUTDIR:-/tmp/aegis-pentest-final}
+VENDOR=${1:-"vendor@example.com"}
+echo "Preparing final pentest bundle in $OUTDIR"
+mkdir -p "$OUTDIR"
+./prod/security/pentest/prepare_pentest_bundle.sh || true
+cp /tmp/aegis-pentest-bundle.tar.gz "$OUTDIR/" 2>/dev/null || true
+
+echo "Encrypting bundle with vendor public key (if provided)"
+if [ -f "vendor_pub.pem" ]; then
+  gpg --yes --output "$OUTDIR/pentest_bundle.enc" --encrypt --recipient-file vendor_pub.pem /tmp/aegis-pentest-bundle.tar.gz || true
+fi
+
+echo "Creating vendor handoff email template at $OUTDIR/vendor_email.txt"
+cat > "$OUTDIR/vendor_email.txt" <<EOF
+Subject: Pentest Engagement — Aegis Platform (staging)
+
+Hello,
+
+Attached is the pentest intake bundle for the Aegis staging environment. Scope:
+- Kubernetes staging cluster (namespaces: ops, ml, feast, monitoring)
+- Services: Vault (HA), KServe, Feast, lakeFS, MLflow, Agent Manager, Agent Memory, Tool Runner
+
+Bundle location: [provide secure link or attachment]
+Kubeconfig & credentials: will be shared via secure channel (SFTP or vendor portal) and valid for agreed windows only.
+
+Rules of engagement and contact info in README.md inside the bundle.
+
+Please confirm receipt and proposed test window.
+
+Regards,
+Security Team
+EOF
+
+echo "Final pentest bundle ready in $OUTDIR. Deliver via secure channel per vendor agreement."
+
*** End Patch
*** Begin Patch
*** Add File:prod/reliability/drill/executable_drill.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# executable_drill.sh
+# Interactive, operator-driven DR drill runner with approvals and dry-run/live modes.
+#
+# Usage:
+#  ./prod/reliability/drill/executable_drill.sh --mode dry --backup-bucket aegis-lakefs-backups --notify "oncall@example.com"
+
+MODE="dry"
+BACKUP_BUCKET="aegis-lakefs-backups"
+NOTIFY=""
+
+while [[ $# -gt 0 ]]; do
+  case "$1" in
+    --mode) MODE="$2"; shift 2;;
+    --backup-bucket) BACKUP_BUCKET="$2"; shift 2;;
+    --notify) NOTIFY="$2"; shift 2;;
+    -h|--help) echo "Usage: $0 [--mode dry|live] [--backup-bucket <bucket>] [--notify email]"; exit 0;;
+    *) echo "Unknown arg $1"; exit 1;;
+  esac
+done
+
+echo "DR Drill Runner - mode=$MODE"
+echo "Step 1: Create Vault snapshot (local) and sync lakeFS to s3://$BACKUP_BUCKET"
+SNAP="/tmp/vault-$(date -u +%Y%m%dT%H%M%SZ).snap"
+echo "Creating Vault snapshot (requires VAULT_ADDR & token in env)"
+if command -v vault >/dev/null 2>&1; then
+  vault operator raft snapshot save "$SNAP" || echo "vault snapshot failed (check Vault access)"
+  echo "Snapshot saved: $SNAP"
+else
+  echo "vault CLI not found - please install and authenticate before running this script for real runs"
+fi
+
+echo "Syncing lakeFS (S3) to backup bucket (simulation or real if aws creds present)"
+if command -v aws >/dev/null 2>&1; then
+  aws s3 sync "s3://aegis-lakefs" "s3://$BACKUP_BUCKET/$(date -u +%Y%m%dT%H%M%SZ)/" || echo "s3 sync failed or not permitted"
+else
+  echo "aws CLI not found - skip actual sync"
+fi
+
+echo "Step 2: Dry-run verification"
+./prod/hardening/backup/verify_lakefs_backup.sh "$BACKUP_BUCKET" || echo "verify_lakefs_backup failed"
+./prod/hardening/dr/verify_restore.sh "$BACKUP_BUCKET" latest || echo "verify_restore not fully validated"
+
+if [ "$MODE" = "live" ]; then
+  read -p "LIVE restore will proceed. Confirm by typing LIVE (all caps): " confirm
+  if [ "$confirm" != "LIVE" ]; then
+    echo "Confirmation not provided - aborting live restore"
+    exit 1
+  fi
+  echo "Proceeding with live restore steps (operator must follow provider restore guides)"
+  # Example restore hint (do not run automatically)
+  echo "vault operator raft snapshot restore $SNAP"
+  echo "Follow vendor-specific lakeFS restore procedures now."
+fi
+
+echo "DR Drill completed in mode=$MODE. Upload artifacts and fill incident report template."
+if [ -n "$NOTIFY" ]; then
+  echo "Notify oncall: $NOTIFY (operator must send notification)"
+fi
+
*** End Patch
*** Begin Patch
*** Add File:productization/pilot_kickoff/PILOT_KICKOFF_PACK.md
+# Pilot Kickoff Pack
+
+This package contains everything to start a customer pilot quickly:
+- Slide deck skeleton (use for kickoff)
+- Pilot acceptance template
+- Onboarding checklist
+- Grafana dashboard JSON for KPI view
+
+Files:
+- slides_kickoff.md — one-page deck for kickoff
+- pilot_acceptance.md — acceptance criteria & signoff template
+- onboarding_checklist.md — operator tasks before pilot
+- grafana/pilot_dashboard.json — importable Grafana dashboard
+
+Kickoff timeline (sample)
+- Day 0: Kickoff call & access exchange
+- Day 1: Tenant wiring + preflight
+- Day 3: Provision staging infra
+- Day 7: Deploy platform core
+- Day 14: Onboard first model and run validation
+- Day 28: DR dry run + pentest handoff
+- Day 42: Handoff & acceptance
+
*** End Patch
*** Begin Patch
*** Add File:productization/pilot_kickoff/slides_kickoff.md
+# Aegis Pilot — Kickoff
+
+Slide: Problem
+- One line description of customer problem & KPIs
+
+Slide: Our Approach
+- Discovery -> Provision -> Onboard -> Validate -> Handoff
+
+Slide: Success Metrics
+- Time-to-first-inference (staging), P95 latency, Promotion count, Audit completeness
+
+Slide: Timeline & Responsibilities
+- Weeks, owners, weekly sync cadence
+
+Slide: Acceptance & Next steps
+- Pilot acceptance criteria (see pilot_acceptance.md)
+
*** End Patch
*** Begin Patch
*** Add File:productization/pilot_kickoff/pilot_acceptance.md
+# Pilot Acceptance Template
+
+Customer:
+Pilot ID:
+Start Date:
+End Date:
+
+Acceptance Criteria (all must be met)
+- Model promotion to Production stage completed and cosign+Rekor evidence present
+- Inference endpoint returns correct responses and meets P95 latency target (defined)
+- Promoted model has monitoring dashboard and alerting configured
+- DR dry-run completed and validated (snapshots present)
+- Training workshop delivered and at least 1 trainee completed labs successfully
+
+Signoff
+- Customer PM:
+- Aegis Delivery Lead:
+- Security Lead:
+
*** End Patch
*** Begin Patch
*** Add File:productization/pilot_kickoff/onboarding_checklist.md
+# Pilot Onboarding Checklist (operator)
+
+1) Access & IAM
+ - Exchange GH repo access and create GH secrets (see ci/build_push_custom/registry_secrets_template.md)
+ - Create cloud service accounts and OIDC role using tenant-finalization scripts
+
+2) Preflight & infra
+ - Run infra/preflight/run_preflight_and_plan.sh
+ - Review plans and schedule apply in maintenance window
+
+3) Images & CI
+ - Dispatch build workflow (build_scan_push.yml) with tag
+ - Verify trivy scan results and upload SBOM artifacts
+
+4) Deploy core platform
+ - Apply terraform for selected modules
+ - Helm deploy Vault (auto-unseal), lakeFS, Feast, KServe, Agent Operator
+
+5) Onboard model
+ - Import HF model or run example training
+ - Promote+sign via mlflow/scripts/mlflow_promote_and_sign.sh
+
+6) Instrument monitoring
+ - Import grafana/pilot_dashboard.json and validate metrics
+
+7) Security
+ - Prepare pentest bundle and schedule vendor window
+
*** End Patch
*** Begin Patch
*** Add File:dashboards/grafana/pilot_dashboard.json
+{
+  "annotations": { "list": [] },
+  "panels": [
+    {
+      "type": "stat",
+      "title": "Pilot: Deployed Models",
+      "targets": [{ "expr": "count(up{job=\"inference\"})", "refId": "A" }]
+    },
+    {
+      "type": "graph",
+      "title": "P95 Latency (per model)",
+      "targets": [{ "expr": "histogram_quantile(0.95, sum(rate(inference_request_duration_seconds_bucket[5m])) by (le,model))", "refId": "B" }]
+    },
+    {
+      "type": "stat",
+      "title": "Audit Trail Completeness",
+      "targets": [{ "expr": "sum(prometheus_tsdb_head_series) or vector(0)", "refId": "C" }]
+    }
+  ],
+  "schemaVersion": 18,
+  "title": "Aegis Pilot Dashboard",
+  "version": 1
+}
+
*** End Patch
*** Begin Patch
*** Add File:runbooks/execute_steps/execute_all_steps.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# execute_all_steps.sh
+# High-level orchestrator that prints & optionally triggers the main immediate tasks:
+#  A) Infra preflight & plan
+#  B) Dispatch build & push CI
+#  C) Prepare pentest bundle
+#  D) Execute DR dry-run
+#  E) Create pilot kickoff artifacts
+#
+ACTION=${1:-"preview"}  # preview | run-ci | prepare-pentest | dr-dry | kickoff | all
+
+case "$ACTION" in
+  preview)
+    echo "Previewing actions. To run, call: ./execute_all_steps.sh all"
+    echo "1) Preflight & plan: ./infra/preflight/run_preflight_and_plan.sh --tf-dir terraform/managed --outdir /tmp/aegis-plans"
+    echo "2) Build & push images: GitHub Actions workflow dispatch (see .github/workflows/build_scan_push.yml or ci/build_push_custom/build_scan_push.yml)"
+    echo "3) Pentest bundle: ./security/pentest/final_pentest_bundle.sh"
+    echo "4) DR dry-run: ./prod/reliability/drill/executable_drill.sh --mode dry"
+    echo "5) Pilot kickoff: see productization/pilot_kickoff/PILOT_KICKOFF_PACK.md"
+    ;;
+  run-ci)
+    echo "Dispatch CI: you should dispatch the build workflow from GitHub UI or use gh workflow run"
+    echo "Example: gh workflow run build_scan_push.yml -f tag=pilot-$(date +%s)"
+    ;;
+  prepare-pentest)
+    echo "Preparing pentest bundle..."
+    ./security/pentest/final_pentest_bundle.sh "vendor@example.com"
+    echo "Bundle prepared in /tmp/aegis-pentest-final"
+    ;;
+  dr-dry)
+    echo "Running DR dry-run..."
+    ./prod/reliability/drill/executable_drill.sh --mode dry
+    ;;
+  kickoff)
+    echo "Generating pilot kickoff artifacts..."
+    mkdir -p /tmp/aegis-pilot-$(date +%s)
+    cp -r productization/pilot_kickoff/* /tmp/aegis-pilot-$(date +%s)/
+    echo "Pilot pack copied to /tmp/aegis-pilot-*"
+    ;;
+  all)
+    echo "Running all steps in sequence (previewed actions)."
+    ./infra/preflight/run_preflight_and_plan.sh --tf-dir terraform/managed --outdir /tmp/aegis-plans
+    echo "Dispatch CI (manual or via gh): gh workflow run build_scan_push.yml -f tag=pilot-$(date +%s)"
+    ./security/pentest/final_pentest_bundle.sh "vendor@example.com"
+    ./prod/reliability/drill/executable_drill.sh --mode dry
+    mkdir -p /tmp/aegis-pilot-$(date +%s)
+    cp -r productization/pilot_kickoff/* /tmp/aegis-pilot-$(date +%s)/
+    echo "All tasks executed in preview/run mode. Please follow up with manual apply & cloud operations."
+    ;;
+  *)
+    echo "Unknown action. Usage: $0 [preview|run-ci|prepare-pentest|dr-dry|kickoff|all]"
+    exit 1
+    ;;
+esac
+
*** End Patch
*** End Patch
