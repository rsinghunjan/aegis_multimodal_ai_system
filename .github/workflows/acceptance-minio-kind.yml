  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
name: Acceptance â€” MinIO + Kind

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'storage/**'
      - 'docker-compose.dev.yml'
      - 'scripts/local_dev_setup.sh'
      - 'tests/acceptance/**'

jobs:
  acceptance:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start docker-compose dev stack (MinIO + Postgres)
        run: |
          docker compose -f docker-compose.dev.yml up -d
          # wait for MinIO
          for i in $(seq 1 30); do
            if curl -fs http://localhost:9000/minio/health/live >/dev/null 2>&1; then
              echo "MinIO healthy"
              break
            fi
            echo "Waiting for MinIO..."
            sleep 2
          done

      - name: Set envs for MinIO (for tests)
        run: |
          echo "OBJECT_STORE_TYPE=minio" >> $GITHUB_ENV
          echo "OBJECT_STORE_ENDPOINT=http://localhost:9000" >> $GITHUB_ENV
          echo "OBJECT_STORE_ACCESS_KEY=minioadmin" >> $GITHUB_ENV
          echo "OBJECT_STORE_SECRET_KEY=minioadmin" >> $GITHUB_ENV
          echo "OBJECT_STORE_BUCKET=aegis-models" >> $GITHUB_ENV

      - name: Install Python & deps
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install Python packages for acceptance
        run: |
          python -m pip install --upgrade pip
          pip install boto3 pytest

      - name: Create MinIO bucket via script
        run: |
          python3 - <<'PY'
import boto3, os
ep = os.environ.get("OBJECT_STORE_ENDPOINT")
access = os.environ.get("OBJECT_STORE_ACCESS_KEY")
secret = os.environ.get("OBJECT_STORE_SECRET_KEY")
bucket = os.environ.get("OBJECT_STORE_BUCKET")
s3 = boto3.client("s3", aws_access_key_id=access, aws_secret_access_key=secret, endpoint_url=ep)
try:
    s3.head_bucket(Bucket=bucket)
except Exception:
    s3.create_bucket(Bucket=bucket)
print("Bucket ensured:", bucket)
PY

      - name: Run acceptance tests
        run: |
          pytest -q tests/acceptance/test_storage_acceptance.py

      - name: Tear down docker-compose dev stack
        if: always()
        run: |
          docker compose -f docker-compose.dev.yml down --volumes
.github/workflows/acceptance-minio-kind.yml
