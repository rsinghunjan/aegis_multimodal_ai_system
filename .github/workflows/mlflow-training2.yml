name: MLflow training (example)

on:
  workflow_dispatch:
  workflow_call:

jobs:
  mlflow-train:
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: http://localhost:5000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      MLFLOW_S3_ENDPOINT_URL: http://localhost:9000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Compose (start MLflow stack)
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin docker.io
          docker compose -f docker/docker-compose.mlflow.yml up -d --build
          # wait for mlflow to accept connections
          echo "Waiting for MLflow to be ready..."
          until curl -sSf http://localhost:5000/health || true; do sleep 2; done
          echo "MLflow appears reachable"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install mlflow scikit-learn joblib

      - name: Run training script
        run: |
          python examples/train_with_mlflow.py --experiment "ci-demo" --run-name "ci-run-$(date +%s)"
        # optionally capture the run_id from output and pass to registration step

      - name: Optional: register model (no Vault signing in this example)
        run: |
          # This step demonstrates how to register; in CI make sure registry and Vault are accessible
          echo "No-op registration step in example workflow"
