 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
# Reusable workflow that enforces signing (Vault OIDC example) and verifies signatures before final promotion.
          # Then login to Vault (the exact CLI flags depend on your Vault server's config)
          # Example: vault login -method=oidc role="${{ inputs.vault_oidc_role }}"
          vault login -method=oidc role="${{ inputs.vault_oidc_role }}" || (echo "Vault OIDC login failed"; exit 1)
          echo "Vault login succeeded. VAULT_TOKEN is available to Vault CLI."

      - name: Run validation
        id: validation
        run: |
          set -eux
          python scripts/evaluate_model.py \
            --mlflow-run-id "${{ inputs.run_id }}" \
            --mlflow-artifact-path "${{ inputs.artifact_path }}" \
            --mode "${{ inputs.mode }}" \
            --metric "${{ inputs.metric }}" \
            --baseline "${{ inputs.baseline }}" \
            --tolerance "${{ inputs.tolerance }}" \
            --emit-json validation_result.json || true

          cat validation_result.json || echo '{}' > validation_result.json
          STATUS=$(jq -r '.status // "error"' validation_result.json)
          echo "Validation status: $STATUS"
          if [ "$STATUS" != "passed" ]; then
            echo "Validation failed - blocking promotion"
            exit 1
          fi

      - name: Promote (download artifact, sign via Vault API, register)
        id: promote
        env:
          # pass through VAULT_ADDR and VAULT_TOKEN if Vault login ran
          VAULT_ADDR: ${{ secrets.VAULT_ADDR || '' }}
        run: |
          set -eux
          python scripts/promote_mlflow_run.py \
            --run-id "${{ inputs.run_id }}" \
            --artifact-path "${{ inputs.artifact_path }}" \
            --model-name "${{ inputs.model_name }}" \
            --version "${{ inputs.version }}" \
            --sign-key "${{ inputs.sign_key }}" \
            > promote_result.json 2>&1 || (echo "Promotion step failed; see promote_result.json"; cat promote_result.json; exit 2)
          cat promote_result.json

      - name: Verify signed artifact
        id: verify
        run: |
          set -eux
          # parse artifact path and signed_paths from promote_result.json (promote_mlflow_run prints the JSON)
          ARTIFACT=$(jq -r '.artifact_local_path // empty' promote_result.json)
          if [ -z "$ARTIFACT" ] || [ ! -f "$ARTIFACT" ]; then
            echo "Artifact local path missing or not a file: $ARTIFACT"
            cat promote_result.json
            exit 3
          fi
          echo "Artifact found at $ARTIFACT"
          # optional explicit signature file path in signed_paths
          SIGPATH=$(jq -r '.signed_paths[0] // empty' promote_result.json)
          if [ -n "$SIGPATH" ]; then
            echo "Verifying using signature file: $SIGPATH"
            python scripts/verify_signature.py --artifact "$ARTIFACT" --signature "$SIGPATH"
          else
            echo "No explicit signature file path found; attempting verification via repository API or cosign (if configured)"
            python scripts/verify_signature.py --artifact "$ARTIFACT"
          fi

      - name: Promotion complete
        run: |
          echo "Promotion completed and signature verified. See promote_result.json and validation_result.json for audit."
          cat promote_result.json || true
.github/workflows/promote_model_if_valid_signed.yml
