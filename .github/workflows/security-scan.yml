  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
name: Security â€” SBOM, SCA & CodeQL

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - dev

permissions:
  contents: read
  id-token: write

jobs:
  codeql:
    name: CodeQL analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v2
      - name: Perform CodeQL Scan
        uses: github/codeql-action/analyze@v2

  build_and_scan:
    name: Build image, SBOM & scan
    runs-on: ubuntu-latest
    needs: [codeql]
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/aegis-api:${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ env.IMAGE_NAME }}

      - name: Install Syft & Trivy & Grype
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget gnupg lsb-release
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Generate SBOM (syft)
        run: |
          syft ${IMAGE_NAME} -o json > sbom-image.json
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
      - name: Scan image with Trivy (os & libs)
        run: |
          trivy image --no-progress --format json -o trivy-image.json ${IMAGE_NAME} || true
      - name: Scan SBOM with Grype (vuln DB)
        run: |
          grype sbom:sbom-image.json -o json > grype-sbom.json || true

      - name: Upload SCA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: |
            sbom-image.json
            trivy-image.json
            grype-sbom.json

      - name: Fail on high severity (Trivy/Grype)
        run: |
          set -e
          jq -e '.[] | select(.Severity=="CRITICAL" or .Severity=="HIGH")' trivy-image.json >/dev/null 2>&1 && (echo "High/CRITICAL vulnerability found in image" && exit 1) || echo "No high vulnerabilities in trivy image scan"
