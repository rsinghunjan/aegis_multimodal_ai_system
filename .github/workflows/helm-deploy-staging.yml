 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
name: Helm Deploy â€” Staging

# This workflow uses terraform outputs (from infra/terraform/overlays/aws) to deploy
# the Helm chart into an EKS cluster provisioned by that overlay.
#
# Requirements:
# - AWS_ROLE_TO_ASSUME to access cluster and S3 via OIDC
# - terraform outputs must include eks_cluster_name and eks_cluster_region (or adapt)
#
# Note: this is a template. Modify to reflect your actual terraform outputs.

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install kubectl & helm
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Fetch terraform outputs
        working-directory: infra/terraform/overlays/aws
        run: |
          terraform output -json > tf_outputs.json
          cat tf_outputs.json

      - name: Configure kubeconfig for EKS
        run: |
          CLUSTER_NAME=$(jq -r '.eks_cluster_name.value' infra/terraform/overlays/aws/tf_outputs.json)
          aws eks update-kubeconfig --name $CLUSTER_NAME --region ${{ secrets.AWS_REGION }}

      - name: Helm upgrade/install
        run: |
          helm upgrade --install aegis ./helm -n aegis --create-namespace \
            --set image.tag=${{ github.event.inputs.image_tag }} \
            -f helm/values.aws.yaml
