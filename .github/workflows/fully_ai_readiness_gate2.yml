name: Fully AI Readiness Gate

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  readiness-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system tools (kubectl, helm, jq)
        run: |
          sudo apt-get update -y
          # kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          # helm
          curl -fsSL https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz | tar xz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          # jq
          sudo apt-get install -y jq || true
          kubectl version --client
          helm version

      - name: Configure kubeconfig (staging)
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          if [ -z "${KUBE_CONFIG_DATA:-}" ]; then
            echo "KUBE_CONFIG_DATA not provided; aborting."
            exit 2
          fi
          echo "$KUBE_CONFIG_DATA" | base64 --decode > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          # show cluster info for visibility
          kubectl cluster-info || true
        shell: bash

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install requests numpy pymilvus boto3 google-cloud-storage || true

      - name: Milvus deploy & verify
        env:
          MILVUS_VALUES_BASE64: ${{ secrets.MILVUS_VALUES_BASE64 }}
          KUBECONFIG: /tmp/kubeconfig
        run: |
          chmod +x scripts/deploy_milvus_verify.sh
          echo "Running Milvus deploy+verify..."
          ./scripts/deploy_milvus_verify.sh
        shell: bash

      - name: Milvus stress test
        if: ${{ secrets.MILVUS_HOST != '' && secrets.MILVUS_PORT != '' }}
        env:
          MILVUS_HOST: ${{ secrets.MILVUS_HOST }}
          MILVUS_PORT: ${{ secrets.MILVUS_PORT }}
        run: |
          echo "Running Milvus stress test against ${MILVUS_HOST}:${MILVUS_PORT}"
          python scripts/milvus_stress_test.py --host "${MILVUS_HOST}" --port "${MILVUS_PORT}" --collection aegis_docs --inserts 500 --queries 200 --concurrency 8
        shell: bash

      - name: LLM gateway load test & SLO check
        env:
          LLM_GATEWAY_URL: ${{ secrets.LLM_GATEWAY_URL }}
          LLM_GATEWAY_API_KEY: ${{ secrets.LLM_GATEWAY_API_KEY }}
        run: |
          if [ -z "${LLM_GATEWAY_URL:-}" ]; then
            echo "LLM_GATEWAY_URL not configured; failing SLO test."
            exit 2
          fi
          echo "Running load test against gateway..."
          python scripts/llm_load_test.py --url "${LLM_GATEWAY_URL}" --key "${LLM_GATEWAY_API_KEY:-}" --concurrency 10 --requests 200
          echo "Load test finished. (Interpret p95 manually or enhance script to auto-fail on SLO breaches.)"
        shell: bash

      - name: Apply Gatekeeper constraints (staging)
        env:
          KUBECONFIG: /tmp/kubeconfig
        run: |
          if kubectl get pods -n gatekeeper >/dev/null 2>&1; then
            echo "Applying Gatekeeper constraints..."
            kubectl apply -f k8s/gatekeeper_constraints_strict.yaml || true
          else
            echo "Gatekeeper not detected in cluster namespace 'gatekeeper'. Install Gatekeeper in staging before running policy validation."
            exit 2
          fi
        shell: bash

      - name: Gatekeeper policy validation (expect denied creation)
        env:
          KUBECONFIG: /tmp/kubeconfig
        run: |
          set +e
          kubectl apply -f - <<'YAML'
apiVersion: aegis.ai/v1
kind: SuggestedAction
metadata:
  name: gatekeeper-policy-test
  namespace: aegis
spec:
  action: "noop"
  reason: "policy test - should be denied without approval label"
YAML
          RC=$?
          set -e
          if [ $RC -eq 0 ]; then
            echo "Policy test unexpectedly allowed SuggestedAction creation. Gatekeeper may not be enforcing or constraint mismatched."
            exit 2
          else
            echo "Gatekeeper correctly denied SuggestedAction creation without approval label (expected)."
          fi
        shell: bash

      - name: Operator E2E repeat (dry-run → approve → execute → rollback)
        env:
          KUBECONFIG: /tmp/kubeconfig
        run: |
          echo "Running operator E2E repeat to collect FP/rollback stats..."
          python scripts/operator_e2e_repeat.py
        shell: bash

      - name: Audit auto-upload & retention verification (if configured)
        env:
          AUTO_UPLOAD_AUDIT: "true"
          AUDIT_GCS_BUCKET: ${{ secrets.AUDIT_GCS_BUCKET }}
          AUDIT_S3_BUCKET: ${{ secrets.AUDIT_S3_BUCKET }}
          KUBECONFIG: /tmp/kubeconfig
        run: |
          if [ -z "${AUDIT_GCS_BUCKET:-}" ] && [ -z "${AUDIT_S3_BUCKET:-}" ]; then
            echo "No audit bucket configured; skipping audit upload/retention verification."
          else
            chmod +x scripts/audit_auto_upload_and_verify.sh
            ./scripts/audit_auto_upload_and_verify.sh
            python scripts/verify_audit_retention.py || (echo "Audit retention verification failed" && exit 2)
          fi
        shell: bash

      - name: KPI reporter & gating checks (Prometheus)
        env:
          PROM_URL: ${{ secrets.PROM_URL }}
          PROM_TOKEN: ${{ secrets.PROM_TOKEN }}
        run: |
          if [ -z "${PROM_URL:-}" ]; then
            echo "PROM_URL not provided; skipping KPI reporter (consider providing PROM_URL in secrets)."
          else
            echo "Running KPI reporter..."
            python scripts/prometheus_kpi_report.py
            echo "KPI reporter executed (non-zero exit indicates thresholds breached)."
          fi
        shell: bash

      - name: Collect cluster and test artifacts
        if: always()
        env:
          KUBECONFIG: /tmp/kubeconfig
        run: |
          mkdir -p /tmp/aegis-readiness
          kubectl -n aegis get all -o wide > /tmp/aegis-readiness/k8s_aegis_all.txt || true
          kubectl -n monitoring get prometheusrule -o yaml > /tmp/aegis-readiness/prometheusrules.yaml || true
          kubectl -n gatekeeper get pods -o wide > /tmp/aegis-readiness/gatekeeper_pods.txt || true
          tar -czf /tmp/aegis-readiness.tgz /tmp/aegis-readiness || true
        shell: bash

      - name: Upload artifacts for SRE review
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aegis-readiness-artifacts
          path: /tmp/aegis-readiness.tgz
