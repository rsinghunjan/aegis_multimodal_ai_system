 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
name: Postgres restore smoke test

on:
  workflow_dispatch:
    inputs:
      s3_bucket:
        description: 'S3 bucket that contains logical backups'
        required: false
      s3_prefix:
        description: 'Backup prefix/folder in S3'
        required: false
  schedule:
    - cron: '0 4 * * MON'  # weekly Monday 04:00 UTC

permissions:
  contents: read
  id-token: write

jobs:
  restore-test:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      # Provide AWS creds as repository secrets for the runner (or use OIDC role)
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET: ${{ secrets.BACKUP_BUCKET }}
      S3_PREFIX: ${{ secrets.BACKUP_PREFIX }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io awscli
          python3 -m pip install --upgrade pip
      - name: Run restore test
        env:
          S3_BUCKET: ${{ github.event.inputs.s3_bucket || env.S3_BUCKET }}
          S3_PREFIX: ${{ github.event.inputs.s3_prefix || env.S3_PREFIX }}
        run: |
          ./scripts/pg_restore_test.sh "${S3_BUCKET}" "${S3_PREFIX}"
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pg-restore-logs
          path: |
            /var/log/syslog
            /var/log/docker.log
