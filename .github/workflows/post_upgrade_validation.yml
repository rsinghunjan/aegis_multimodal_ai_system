name: Postâ€‘Upgrade Validation (dispatch)

on:
  workflow_dispatch:
    inputs:
      nodes:
        description: 'DeepSpeed nodes'
        required: false
        default: '4'
      train_seconds:
        description: 'Training burst duration (s)'
        required: false
        default: '300'
      simulate_preemption:
        description: 'simulate_preemption (true/false)'
        required: false
        default: 'true'
      s3_bucket:
        description: 'Optional S3 bucket for artifacts upload'
        required: false
        default: ''
      open_issue:
        description: 'Open GitHub issue with report (true/false)'
        required: false
        default: 'true'

jobs:
  post-upgrade-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure tools
        run: |
          python -V
          pip --version || true
          which jq || sudo apt-get update && sudo apt-get install -y jq >/dev/null

      - name: Run post-upgrade validation (requires KUBECONFIG or self-hosted runner)
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG_STAGING || '' }}
          S3_BUCKET: ${{ secrets.ARTIFACT_S3_BUCKET || github.event.inputs.s3_bucket }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Required runner-cluster binding
          if [ -z "${KUBECONFIG:-}" ]; then
            echo "KUBECONFIG not set. This workflow must run on a self-hosted runner with cluster access or provide KUBECONFIG_STAGING secret."
            exit 78
          fi

          chmod +x scripts/run_full_validation.sh
          ./scripts/run_full_validation.sh \
            --nodes "${{ github.event.inputs.nodes }}" \
            --rounds 1 \
            --train-seconds "${{ github.event.inputs.train_seconds }}" \
            --gateway "http://aegis-inference-gateway.aegis-ml.svc.cluster.local/generate" \
            --artifact-dir ./artifacts \
            --s3-bucket "${S3_BUCKET}" \
            --s3-prefix "aegis/post-upgrade" \
            --simulate-preemption "${{ github.event.inputs.simulate_preemption }}" \
            --kubeconfig "${KUBECONFIG}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-upgrade-validation-artifacts
          path: artifacts || .

      - name: Publish report as GitHub issue (optional)
        if: ${{ github.event.inputs.open_issue == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          REPORT_JSON=$(ls validation_report_*.json 2>/dev/null | head -n1 || true)
          if [ -z "$REPORT_JSON" ]; then
            echo "No report found (validation_report_*.json). Skipping issue creation."
            exit 0
          fi
          echo "Found report: $REPORT_JSON"
          # Build readable body using jq
          BODY=$(jq -r '
            def safe(x; d): if x==null then d else x end;
            [
              ("Post-upgrade validation report"),
              ("Repository: " + env.REPO),
              (""),
              ("Summary:"),
              ("  Nodes: " + (.nodes|tostring|safe(.;"N/A"))),
              ("  Rounds: " + (.rounds|tostring|safe(.;"N/A"))),
              ("  Train seconds: " + (.train_seconds|tostring|safe(.;"N/A"))),
              ("  Artifact bundle: " + (.artifact_bundle|safe(.;"none"))),
              ("  S3 upload: " + (.s3_upload|safe(.;"none"))),
              (""),
              ("vLLM CSV Summaries:")
            ]
            + (if (.vllm_csv_summary // []) | length > 0
                 then (.vllm_csv_summary[] | ["  - " + (.csv|safe(.;"unknown")) + " total=" + (.total|tostring) + " success=" + (.success|tostring)])
                 else ["  - no vLLM CSVs found"]
               end)
            | join("\n")
          ' "$REPORT_JSON")

          TITLE="Post-upgrade validation: $(date --iso-8601=seconds)"
          PAYLOAD=$(jq -n --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b}')
          echo "Creating issue in $REPO"
          curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            -X POST "https://api.github.com/repos/${REPO}/issues" \
            -d "$PAYLOAD" > /tmp/issue_resp.json
          jq -r '.html_url // "issue creation failed"' /tmp/issue_resp.json || true
