  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
name: Package and sign artifact using Vault transit

on:
  workflow_dispatch:
    inputs:
      artifact_path:
        description: 'Path to artifact to sign (relative to repo root or workspace)'
        required: true
      upload_bucket:
        description: 'S3 bucket to upload artifact and signature (optional, overrides secret)'
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      VAULT_ADDR: ${{ secrets.VAULT_ADDR }}            # e.g. https://vault.example.internal:8200
      VAULT_AUDIENCE: ${{ secrets.VAULT_AUDIENCE }}    # matches vault role's audience
      OBJECT_STORE_BUCKET: ${{ secrets.OBJECT_STORE_BUCKET }}
      VAULT_ROLE: "aegis-sign-role"
    steps:
      - uses: actions/checkout@v4

      - name: Setup deps
        run: |
          sudo apt-get update && sudo apt-get install -y jq openssl
          python3 -m pip install --upgrade pip

      - name: Build / prepare artifact (optional)
        if: ${{ always() }}
        run: |
          # Example: if artifact needs to be built, do it here.
          # If you already have the artifact, skip this step.
          echo "Artifact path: ${{ github.event.inputs.artifact_path }}"

      - name: Request OIDC token
        id: get_oidc
        run: |
          # Fetch ID token from runner OIDC endpoint with required audience
          TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${VAULT_AUDIENCE}" | jq -r .value)
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to get OIDC token" >&2
            exit 1
          fi
          echo "id_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Login to Vault (OIDC -> client token)
        id: vault_login
        run: |
          set -euo pipefail
          ID_TOKEN="${{ steps.get_oidc.outputs.id_token }}"
          VAULT_ADDR="${VAULT_ADDR%/}"
          LOGIN_RESP=$(curl -sS --request POST --data "{\"jwt\":\"${ID_TOKEN}\",\"role\":\"${VAULT_ROLE}\"}" ${VAULT_ADDR}/v1/auth/jwt/login)
          VAULT_TOKEN=$(echo "$LOGIN_RESP" | jq -r '.auth.client_token')
          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "Vault login failed: $LOGIN_RESP" >&2
            exit 1
          fi
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      - name: Compute digest and ask Vault transit to sign
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          set -euo pipefail
          ART="${{ github.event.inputs.artifact_path }}"
          if [ ! -f "$ART" ]; then
            echo "Artifact not found at $ART" >&2
            exit 2
          fi
          DIGEST_B64=$(openssl dgst -sha256 -binary "$ART" | base64 -w 0)
          # Call Vault transit/sign endpoint; transit key name is 'aegis-cosign' by convention
          SIGN_JSON=$(curl -sS --header "X-Vault-Token: $VAULT_TOKEN" --request POST --data "{\"input\":\"${DIGEST_B64}\"}" "${VAULT_ADDR%/}/v1/transit/sign/aegis-cosign")
          echo "$SIGN_JSON" > "${ART}.sig.json"
          echo "Created signature file: ${ART}.sig.json"

      - name: Upload artifact and signature to S3 (optional)
        if: ${{ always() }}
        env:
          BUCKET: ${{ github.event.inputs.upload_bucket || env.OBJECT_STORE_BUCKET }}
        run: |
          if [ -z "${BUCKET:-}" ]; then
            echo "OBJECT_STORE_BUCKET not configured; leaving files in workspace"
            ls -lh "${{ github.event.inputs.artifact_path }}"* || true
          else
            echo "Uploading to s3://${BUCKET}/model-archives/${{ github.run_id }}/"
            aws s3 cp "${{ github.event.inputs.artifact_path }}" "s3://${BUCKET}/model-archives/${{ github.run_id }}/$(basename "${{ github.event.inputs.artifact_path }}")"
            aws s3 cp "${{ github.event.inputs.artifact_path }}.sig.json" "s3://${BUCKET}/model-archives/${{ github.run_id }}/$(basename "${{ github.event.inputs.artifact_path }}.sig.json")"
          fi
.github/workflows/sign_with_vault.yml
