  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
name: Verify model signatures (remote verification - optional)

# This workflow extends the existing verifier by optionally loading provider credentials from Secrets.
# It runs on PRs touching model_registry/** and attempts to download remote artifacts if CI secrets are present.
on:
  pull_request:
    paths:
      - 'model_registry/**'

jobs:
  verify-signatures-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set provider envs from secrets (optional)
        run: |
          # S3-compatible (AWS or MinIO)
          if [ -n "${{ secrets.OBJECT_STORE_ACCESS_KEY }}" ]; then
            echo "OBJECT_STORE_ACCESS_KEY=${{ secrets.OBJECT_STORE_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "OBJECT_STORE_SECRET_KEY=${{ secrets.OBJECT_STORE_SECRET_KEY }}" >> $GITHUB_ENV
            if [ -n "${{ secrets.OBJECT_STORE_ENDPOINT }}" ]; then
              echo "OBJECT_STORE_ENDPOINT=${{ secrets.OBJECT_STORE_ENDPOINT }}" >> $GITHUB_ENV
            fi
            echo "OBJECT_STORE_TYPE=s3" >> $GITHUB_ENV
          fi

          # GCS: provide JSON credentials as a base64 secret or set GOOGLE_APPLICATION_CREDENTIALS to point to uploaded secret
          if [ -n "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}" ]; then
            echo "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}" | base64 --decode > $GITHUB_WORKSPACE/gcloud_creds.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=$GITHUB_WORKSPACE/gcloud_creds.json" >> $GITHUB_ENV
            echo "OBJECT_STORE_TYPE=gcs" >> $GITHUB_ENV
          fi

          # Azure: connection string
          if [ -n "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" ]; then
            echo "AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" >> $GITHUB_ENV
            echo "OBJECT_STORE_TYPE=azure" >> $GITHUB_ENV
          fi

          # OCI: minimal example for OCI SDK - supply config via env or secrets (advanced)
          if [ -n "${{ secrets.OCI_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.OCI_PRIVATE_KEY }}" > $GITHUB_WORKSPACE/oci_private_key.pem
            echo "OCI_PRIVATE_KEY=$GITHUB_WORKSPACE/oci_private_key.pem" >> $GITHUB_ENV
            echo "OCI_TENANCY_OCID=${{ secrets.OCI_TENANCY_OCID }}" >> $GITHUB_ENV
            echo "OCI_USER_OCID=${{ secrets.OCI_USER_OCID }}" >> $GITHUB_ENV
            echo "OCI_FINGERPRINT=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
            echo "OBJECT_STORE_TYPE=oci" >> $GITHUB_ENV
          fi

      - name: Install deps for verification
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml boto3 google-cloud-storage azure-storage-blob oci

      - name: Compute changed model dirs
        id: changed
        run: |
          echo "Computing changed model dirs..."
          CHANGED=$(git diff --name-only origin/main...HEAD | awk -F/ '/^model_registry\//{print $2}' | sort -u | tr '\n' ' ')
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Run signature verifier (with provider creds if present)
        run: |
          if [ -z "${{ steps.changed.outputs.changed }}" ]; then
            echo "No changed models detected; verifying all model_registry entries"
            python3 scripts/verify_model_signatures.py
          else
            echo "Verifying changed models: ${{ steps.changed.outputs.changed }}"
            python3 scripts/verify_model_signatures.py ${{ steps.changed.outputs.changed }}
          fi
.github/workflows/verify-model-signatures-remote.yml
