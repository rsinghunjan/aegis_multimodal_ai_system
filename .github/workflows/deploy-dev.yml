106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
# CI/CD: Build, test, push image, migrate DB, deploy Helm chart, run smoke tests
          mkdir -p .helm
          cat > .helm/values-dev.yaml <<'YAML'
image:
  repository: ghcr.io/${{ github.repository_owner }}/aegis-api
  tag: "${{ github.sha }}"
  pullPolicy: IfNotPresent
replicaCount: 1
resources:
  requests:
    cpu: "200m"
    memory: "512Mi"
  limits:
    cpu: "1000m"
    memory: "2Gi"
env:
  - name: DATABASE_URL
    value: "postgresql+psycopg2://postgres:password@postgres:5432/aegis"
YAML

      - name: Deploy Helm chart (upgrade/install)
        run: |
          helm upgrade --install aegis-api ${HELM_CHART_PATH} -f .helm/values-dev.yaml --wait --timeout 10m
        env:
          HE L M_CHART_PATH: ${{ env.HELM_CHART_PATH }}

      - name: Run DB migration job (k8s Job)
        run: |
          # Create a migration Job in cluster using the same image; job YAML in k8s/migration-job.yaml
          # Replace image placeholder with actual built image tag
          IMAGE=ghcr.io/${{ github.repository_owner }}/aegis-api:${{ github.sha }}
          sed "s|__IMAGE_PLACEHOLDER__|${IMAGE}|g" k8s/migration-job.yaml | kubectl apply -f -
          kubectl wait --for=condition=complete --timeout=5m job/aegis-migrate || (kubectl logs job/aegis-migrate; exit 1)
          kubectl delete job aegis-migrate --ignore-not-found
        env:
          KUBECONFIG: ./kubeconfig

      - name: Wait for deployment readiness
        run: |
          kubectl rollout status deployment/aegis-api --timeout=5m

      - name: Run smoke tests against deployed service
        env:
          BASE_URL: "http://$(kubectl get svc aegis-api -o jsonpath='{.spec.clusterIP}'):8080"
        run: |
          chmod +x scripts/deploy_smoke_test.sh
          ./scripts/deploy_smoke_test.sh "${BASE_URL}"
        env:
          KUBECONFIG: ./kubeconfig

.github/workflows/deploy-dev.yml
