 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
name: Build & Sign Model Artifact (example)

# This workflow demonstrates how to:
#  - create deterministic archive for a model (uses scripts/make_deterministic_archive.py)
#  - sign the archive with cosign (private key provided as a repo secret)
#  - optionally upload the signature and archive to staging object store (AWS S3 example)
#
# Required secrets:
# - COSIGN_PRIVATE_KEY_B64  (base64-encoded private key)
# - AWS_ROLE_TO_ASSUME (if uploading to S3 via OIDC)
# - AWS_REGION
# - OBJECT_STORE_BUCKET (optional; if uploading)

on:
  workflow_dispatch:
    inputs:
      model_dir:
        description: 'Path to model dir relative to repo (e.g. model_registry/example-tf-model/0.1)'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  sign-model:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deterministic archive
        run: |
          MODEL_DIR="${{ github.event.inputs.model_dir }}"
          python3 scripts/make_deterministic_archive.py "${MODEL_DIR}/saved_model" "/tmp/model.tar.gz"
          ls -l /tmp/model.tar.gz
          sha256sum /tmp/model.tar.gz

      - name: Install cosign
        run: |
          curl -sSLf https://github.com/sigstore/cosign/releases/download/v1.14.1/cosign-linux-amd64 -o /usr/local/bin/cosign
          chmod +x /usr/local/bin/cosign
          cosign version

      - name: Decode cosign private key
        env:
          COSIGN_PRIVATE_KEY_B64: ${{ secrets.COSIGN_PRIVATE_KEY_B64 }}
        run: |
          echo "$COSIGN_PRIVATE_KEY_B64" | base64 --decode > /tmp/cosign_key.pem
          chmod 600 /tmp/cosign_key.pem

      - name: Sign model archive (sign-blob)
        run: |
          cosign sign-blob --key /tmp/cosign_key.pem /tmp/model.tar.gz > /tmp/model.tar.gz.sig
          ls -l /tmp/model.tar.gz.sig

      - name: (Optional) Upload archive & signature to S3
        if: ${{ secrets.OBJECT_STORE_BUCKET != '' }}
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
        run: |
          aws s3 cp /tmp/model.tar.gz s3://${{ secrets.OBJECT_STORE_BUCKET }}/model-archives/${{ github.run_id }}/model.tar.gz
          aws s3 cp /tmp/model.tar.gz.sig s3://${{ secrets.OBJECT_STORE_BUCKET }}/model-archives/${{ github.run_id }}/model.tar.gz.sig

      - name: Upload signature artifact for PR
        uses: actions/upload-artifact@v4
        with:
          name: model-signature
          path: /tmp/model.tar.gz.sig
.github/workflows/build-and-sign.yml
