  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
name: Package -> Vault-transit sign -> upload

on:
  workflow_dispatch:
  push:
    paths:
      - 'training/**'
      - 'model_registry/**'

permissions:
  id-token: write       # required to request OIDC token
  contents: read

jobs:
  build_sign_upload:
    runs-on: ubuntu-latest
    env:
      VAULT_ADDR: ${{ secrets.VAULT_ADDR }}           # e.g. https://vault.example.internal:8200
      VAULT_AUDIENCE: ${{ secrets.VAULT_AUDIENCE }}   # e.g. aegis-vault
      OBJECT_STORE_BUCKET: ${{ secrets.OBJECT_STORE_BUCKET }}
      ARTIFACT_NAME: "cifar-demo-0.1.tar.gz"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python & deps
        run: |
          python -m pip install --upgrade pip
          pip install -r training/full_pipeline/requirements.txt

      - name: Build model artifact
        run: |
          mkdir -p artifacts
          python training/pytorch_lightning_distributed.py --out-dir ./model_registry/demo-models/cifar_demo/0.1 --max-epochs 1
          python3 scripts/make_deterministic_archive.py ./model_registry/demo-models/cifar_demo/0.1 ./artifacts/${ARTIFACT_NAME}

      - name: Request OIDC token (GitHub Actions)
        id: get_oidc
        run: |
          # Use the internal endpoint variables to fetch an OIDC token for Vault.
          # ACTIONS_ID_TOKEN_REQUEST_URL and ACTIONS_ID_TOKEN_REQUEST_TOKEN are provided by Actions runner.
          TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${VAULT_AUDIENCE}" | jq -r .value)
          echo "id_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Vault login via JWT/OIDC
        id: vault_login
        run: |
          set -euxo pipefail
          ID_TOKEN="${{ steps.get_oidc.outputs.id_token }}"
          VAULT_LOGIN_JSON=$(curl -s --request POST --data "{\"jwt\":\"${ID_TOKEN}\",\"role\":\"aegis-sign-role\"}" ${VAULT_ADDR}/v1/auth/jwt/login)
          VAULT_TOKEN=$(echo "$VAULT_LOGIN_JSON" | jq -r '.auth.client_token')
          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "Vault login failed: $VAULT_LOGIN_JSON" >&2
            exit 1
          fi
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      - name: Compute digest, ask Vault transit to sign it, upload artifact + signature
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          set -euxo pipefail
          ARTIFACT=./artifacts/${ARTIFACT_NAME}
          DIGEST_B64=$(openssl dgst -sha256 -binary "$ARTIFACT" | base64 -w 0)
          # Call Vault transit/sign endpoint
          SIGN_JSON=$(curl -s --header "X-Vault-Token: $VAULT_TOKEN" --request POST --data "{\"input\":\"${DIGEST_B64}\"}" ${VAULT_ADDR%/}/v1/transit/sign/aegis-cosign)
          echo "$SIGN_JSON" > ${ARTIFACT}.sig.json
          # Upload artifact and signature to S3 (assumes the runner has AWS creds or OIDC->role configured)
          if [ -n "${OBJECT_STORE_BUCKET:-}" ]; then
            aws s3 cp "$ARTIFACT" "s3://${OBJECT_STORE_BUCKET}/model-archives/demo/${{ github.run_id }}/${ARTIFACT_NAME}"
            aws s3 cp "${ARTIFACT}.sig.json" "s3://${OBJECT_STORE_BUCKET}/model-archives/demo/${{ github.run_id }}/${ARTIFACT_NAME}.sig"
            echo "Uploaded artifact + signature to s3://${OBJECT_STORE_BUCKET}/model-archives/demo/${{ github.run_id }}/"
          else
            echo "OBJECT_STORE_BUCKET not set; signature saved locally at ${ARTIFACT}.sig.json"
          fi
.github/workflows/sign_with_vault.yml
