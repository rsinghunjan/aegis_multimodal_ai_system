  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
name: Scheduled secret rotation (example)
on:
  schedule:
    - cron: "0 3 */30 * *"  # every 30 days at 03:00 UTC (adjust)
  workflow_dispatch:

jobs:
  rotate-keys:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install hvac

      - name: Rotate model_sign_key in Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}        # use short-lived token or AppRole in prod
          ROTATED_BY: "github-actions"
        run: |
          python scripts/vault_rotate_model_sign_key.py --preview=false

      - name: Sync vault -> k8s
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}   # or use actions/setup-kube with cluster creds
        run: |
          chmod +x scripts/k8s_sync_secrets_from_vault.sh
          ./scripts/k8s_sync_secrets_from_vault.sh aegis aegis-secrets

      - name: Annotate release note
        run: echo "Rotation run completed"
