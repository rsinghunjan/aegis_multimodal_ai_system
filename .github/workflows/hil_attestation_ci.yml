name: HIL Attestation CI

on:
  workflow_dispatch:
  pull_request:
    types: [labeled]
    # Trigger when a PR receives the "run-hil" label
    # (requires repository dispatch for cross-repo, simplified here)

jobs:
  run-hil-and-attest:
    if: contains(github.event.pull_request.labels.*.name, 'run-hil') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Run HIL harness (containerized)
        env:
          # Provide any required secrets via repository/organization secrets
          EVIDENCE_BUCKET: ${{ secrets.EVIDENCE_BUCKET }}
        run: |
          # The HIL harness image is expected to exist or you can run inline tests here.
          # For reproducibility we run the hil_attestor on artifacts provided by the harness container.
          mkdir -p artifacts
          docker run --rm -v "$(pwd)/artifacts":/artifacts ghcr.io/yourorg/hil-harness:latest /opt/hil/run_tests.sh --out /artifacts || true
          ls -la artifacts

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install kubernetes boto3

      - name: Create attestation
        env:
          EVIDENCE_BUCKET: ${{ secrets.EVIDENCE_BUCKET }}
          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
          COSIGN_PUB: ${{ secrets.COSIGN_PUB }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          python ops/autonomy/hil_attestor.py --artifacts artifacts --name "pr-${{ github.event.pull_request.number or github.run_id }}" --namespace "aegis-system" --upload-s3

      - name: Comment PR with attestation
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: "HIL attestation created and uploaded. Attestation id: `pr-" + context.payload.pull_request.number + "`"
            })
