 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
name: Canary Test â€” staging rollout validation

# This workflow assumes the cluster already has Argo Rollouts and Prometheus installed,
# and a Rollout object (k8s/argo-rollouts/example-rollout.yaml) is the way models are promoted.
#
# The workflow:
# - updates image tag in a k8s Deployment (or triggers a new Rollout)
# - runs simulate_canary_load to push traffic (with optional error injection)
# - waits and queries Argo Rollouts status to check for automatic rollback (or success)
#
# Require: AWS_ROLE_TO_ASSUME, AWS_REGION to write kubeconfig for EKS (example). Adapt for GKE/AKS.

on:
  workflow_dispatch:
    inputs:
      image_tag:
        required: true
      target_url:
        required: true
      error_rate:
        required: false
        default: '0.0'

permissions:
  id-token: write
  contents: read

jobs:
  run-canary-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update Rollout image (example using kubectl patch)
        run: |
          kubectl -n aegis set image deployment/aegis-model model=aegis/model:${{ github.event.inputs.image_tag }}

      - name: Wait a short time for rollout to start
        run: sleep 15

      - name: Run simulated load
        run: |
          pip install httpx
          python3 scripts/simulate_canary_load.py --url "${{ github.event.inputs.target_url }}" --qps 20 --duration 60 --error-rate ${{ github.event.inputs.error_rate }}

      - name: Check rollout status
        run: |
          # uses argocd rollouts cli or kubectl; check for rollout status and determine if rollback happened
          kubectl -n aegis rollout status deployment/aegis-model --timeout=120s || true
          # check Pods/ReplicaSets for latest image
          kubectl -n aegis get rs -o wide
