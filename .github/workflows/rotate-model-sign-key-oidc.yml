  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
on:
  schedule:
    - cron: "0 3 */30 * *"  # every 30 days (adjust as needed)
  workflow_dispatch:

name: Rotate model-sign key (OIDC -> Vault)

permissions:
  id-token: write            # required for OIDC
  contents: read

jobs:
  rotate-model-sign-key:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PYTHONUNBUFFERED: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install hvac python-dotenv

      - name: Login to Vault via OIDC (ephemeral token)
        id: vault_login
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          role: ${{ secrets.VAULT_OIDC_ROLE }}
          method: oidc
      # vault-action sets VAULT_TOKEN and VAULT_ADDR in the environment for next steps

      - name: Rotate model-sign key (write to Vault)
        id: rotate
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ steps.vault_login.outputs.client_token }}
        run: |
          set -eux
          # run rotation (non-preview); script writes new key_id to stdout in a predictable format
          python scripts/vault_rotate_model_sign_key.py --preview=false | tee rotation.out
          # capture the new key id from rotation.out for verification
          NEW_KEY_ID=$(grep -oP '"key_id":\s*"\K[0-9a-fA-F-]+' rotation.out | head -n1 || true)
          echo "new_key_id=${NEW_KEY_ID}" >> $GITHUB_OUTPUT

      - name: Verify new active key in Vault (lightweight)
        id: verify_vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ steps.vault_login.outputs.client_token }}
        run: |
          set -eux
          NEW_KEY_ID="${{ steps.rotate.outputs.new_key_id }}"
          if [ -z "$NEW_KEY_ID" ]; then
            echo "Failed to parse new_key_id from rotation. Aborting verification." >&2
            exit 1
          fi
          python scripts/vault_verify_rotation.py --key-id "$NEW_KEY_ID"

      - name: Sync secrets to Kubernetes (optional)
        if: ${{ secrets.KUBECONFIG != '' }}
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ steps.vault_login.outputs.client_token }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          set -eux
          chmod +x scripts/k8s_sync_secrets_from_vault.sh
          ./scripts/k8s_sync_secrets_from_vault.sh aegis aegis-secrets
          kubectl get secret aegis-secrets -n aegis -o yaml

      - name: Optional registry validation (if cluster & API reachable)
        if: ${{ secrets.KUBECONFIG != '' }}
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          # attempt to call registry validate for a seeded model if your cluster exposes a Service and DNS
          echo "Skipping model /validate call by default; add invocation if your cluster exposes the registry endpoint and admin token."
