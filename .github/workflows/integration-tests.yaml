
name: Integration tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  integration:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin

      - name: Build and run integration stack
        run: |
          docker compose -f docker/docker-compose.integration.yml up -d --build
          ./scripts/wait_for_services.sh http://localhost:8081/health 120 2

      - name: Run migrations and seed
        run: |
          docker compose -f docker/docker-compose.integration.yml exec -T api alembic upgrade head
          docker compose -f docker/docker-compose.integration.yml exec -T api python scripts/seed_db.py

      - name: Run integration tests
        run: |
          pytest tests/integration -q
.github/workflows/integration-tests.yml
