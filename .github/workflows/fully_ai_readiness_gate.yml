# GitHub Actions workflow: Fully AI Readiness Gate
# Runs the complete staging validation pipeline and fails on any gate failure.
# Gate steps:
#  - Milvus deploy & verify (HA/TLS/auth/backups)
#  - Milvus stress test
#  - LLM gateway load test & SLO check
#  - Gatekeeper policy validation (deny unsafe SuggestedAction)
#  - Operator E2E repeat (dry-run → approve → execute → rollback) and collect metrics
#  - Audit upload & retention verification (GCS/S3)
#  - KPI reporter (Prometheus)
#
# Required repository scripts/manifests (provided in repo):
#  - scripts/deploy_milvus_verify.sh
#  - scripts/milvus_stress_test.py
#  - scripts/llm_load_test.py
#  - k8s/gatekeeper_constraints_strict.yaml
#  - scripts/operator_e2e_repeat.py
#  - scripts/audit_auto_upload_and_verify.sh
#  - scripts/verify_audit_retention.py
#  - scripts/prometheus_kpi_report.py
#
# Required secrets (set per-environment / staging):
#  - KUBE_CONFIG_DATA             (base64 kubeconfig for staging cluster)
#  - MILVUS_VALUES_BASE64         (optional Helm values for Milvus)
#  - MILVUS_HOST, MILVUS_PORT     (for direct stress test)
#  - LLM_GATEWAY_URL
#  - LLM_GATEWAY_API_KEY
#  - AUDIT_GCS_BUCKET / AUDIT_S3_BUCKET (optional)
#  - PROM_URL / PROM_TOKEN (optional)
#
# Run this workflow manually in staging. It will upload artifacts on completion.
name: Fully AI Readiness Gate

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  readiness-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system tools (kubectl, helm, jq)
        run: |
          sudo apt-get update -y
          # kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          # helm
          curl -fsSL https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz | tar xz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          # jq
          sudo apt-get install -y jq || true
          kubectl version --client
          helm version

      - name: Configure kubeconfig (staging)
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          if [ -z "${KUBE_CONFIG_DATA:-}" ]; then
            echo "KUBE_CONFIG_DATA not provided; aborting."
            exit 2
          fi
          echo "$KUBE_CONFIG_DATA" | base64 --decode > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          # show nodes for visibility
          kubectl cluster-info || true
        shell: bash

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install requests numpy pymilvus boto3 google-cloud-storage || true

      - name: Milvus deploy & verify
        env:
          MILVUS_VALUES_BASE64: ${{ secrets.MILVUS_VALUES_BASE64 }}
          KUBECONFIG: /tmp/kubeconfig
        run: |
          chmod +x scripts/deploy_milvus_verify.sh
          echo "Running Milvus deploy+verify..."
          ./scripts/deploy_milvus_verify.sh
        shell: bash

      - name: Milvus stress test
        if: ${{ secrets.MILVUS_HOST != '' && secrets.MILVUS_PORT != '' }}
        env:
          MILVUS_HOST: ${{ secrets.MILVUS_HOST }}
          MILVUS_PORT: ${{ secrets.MILVUS_PORT }}
        run: |
          echo "Running Milvus stress test against ${MILVUS_HOST}:${MILVUS_PORT}"
          python scripts/milvus_stress_test.py --host "${MILVUS_HOST}" --port "${MILVUS_PORT}" --collection aegis_docs --inserts 500 --queries 200 --concurrency 8
        shell: bash

      - name: LLM gateway load test & SLO check
        env:
          LLM_GATEWAY_URL: ${{ secrets.LLM_GATEWAY_URL }}
          LLM_GATEWAY_API_KEY: ${{ secrets.LLM_GATEWAY_API_KEY }}
        run: |
          if [ -z "${LLM_GATEWAY_URL:-}" ]; then
            echo "LLM_GATEWAY_URL not configured; failing SLO test."
            exit 2
          fi
          echo "Running load test against gateway..."
          python scripts/llm_load_test.py --url "${LLM_GATEWAY_URL}" --key "${LLM_GATEWAY_API_KEY:-}" --concurrency 10 --requests 200
          echo "Load test finished. (Interpret p95 manually or enhance script to auto-fail on SLO breaches.)"
        shell: bash

      - name: Apply Gatekeeper constraints (staging)
        env:
          KUBECONFIG: /tmp/kubeconfig
        run: |
          if kubectl get pods -n gatekeeper >/dev/null 2>&1; then
            echo "Applying Gatekeeper constraints..."
            kubectl apply -f k8s/gatekeeper_constraints](#)

