 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
name: Verify model signatures (model_registry)

on:
  pull_request:
    paths:
      - 'model_registry/**'

jobs:
  verify-signatures:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml boto3 google-cloud-storage azure-storage-blob

      - name: Compute changed model dirs
        id: changed
        run: |
          echo "Computing changed model dirs relative to origin/main..."
          CHANGED=$(git diff --name-only origin/main...HEAD | awk -F/ '/^model_registry\//{print $2}' | sort -u | tr '\n' ' ')
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Run signature verifier
        run: |
          if [ -z "${{ steps.changed.outputs.changed }}" ]; then
            echo "No changed models detected; running verification against all model_registry entries."
            python3 scripts/verify_model_signatures.py
          else
            echo "Verifying changed models: ${{ steps.changed.outputs.changed }}"
            python3 scripts/verify_model_signatures.py ${{ steps.changed.outputs.changed }}
          fi
