 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
name: Terraform Apply â€” Staging (AWS OIDC example)

# WARNING: This workflow will run Terraform apply. Only enable/run after reviewing and creating
# the appropriate IAM role trust for GitHub OIDC and confirming variables/approvals.
#
# Required repository secrets:
# - AWS_ROLE_TO_ASSUME (ARN of role that GitHub Actions OIDC will assume)
# - AWS_REGION
# - TF_VAR_db_password (or provide via workspace variables)
#
# Note: Prefer running terraform apply via an approvals gate or manually. This workflow includes
# an "auto-approve" variable; remove or gate it in production.

on:
  workflow_dispatch:
    inputs:
      auto_approve:
        description: "Pass true to auto-approve terraform apply"
        required: false
        default: "false"

permissions:
  id-token: write
  contents: read

jobs:
  terraform-apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: infra/terraform/overlays/aws
        run: |
          terraform init -input=false

      - name: Terraform Plan
        id: plan
        working-directory: infra/terraform/overlays/aws
        run: |
          terraform plan -out=tfplan -input=false

      - name: Terraform Apply (optional auto-approve)
        if: ${{ github.event.inputs.auto_approve == 'true' }}
        working-directory: infra/terraform/overlays/aws
        run: |
          terraform apply -input=false -auto-approve tfplan

      - name: Terraform Show Outputs
        working-directory: infra/terraform/overlays/aws
        run: |
          terraform output -json > tf_outputs.json
          cat tf_outputs.json
        # You can use tf_outputs.json later to feed to helm deploy jobs
