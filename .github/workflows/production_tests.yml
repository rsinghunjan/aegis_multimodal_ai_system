name: Production-style integration + load + chaos tests

on:
  workflow_dispatch:

jobs:
  integration-load-chaos:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin docker.io

      - name: Start integration stack
        run: |
          docker compose -f docker/docker-compose.integration.yml up -d --build
      - name: Wait for API health
        run: |
          ./scripts/wait_for_services.sh http://localhost:8081/health 120 2

      - name: Run migrations and seed DB
        run: |
          docker compose -f docker/docker-compose.integration.yml exec -T api alembic upgrade head
          docker compose -f docker/docker-compose.integration.yml exec -T api python scripts/seed_db.py

      - name: Run light baseline load (k6)
        env:
          API_BASE: http://localhost:8081
          ADMIN_USER: admin
          ADMIN_PASS: adminpass
        run: |
          ./scripts/run_k6_load.sh

      - name: Start sustained background load (k6 in docker)
        env:
          API_BASE: http://localhost:8081
          ADMIN_USER: admin
          ADMIN_PASS: adminpass
        run: |
          docker run --rm -d -v "$PWD":/app -w /app -e API_BASE -e ADMIN_USER -e ADMIN_PASS loadimpact/k6:latest run --vus 20 --duration 3m tests/load/k6/aegis_load_test.js
      - name: Wait 30s for background load to ramp
        run: sleep 30

      - name: Run chaos experiment (kill one API pod)
        # For docker-compose integration we simulate chaos by stopping a container; for k8s cluster you'd use kubectl + scripts/chaos_kill_random_pod.sh
        run: |
          echo "Simulating service interruption: stopping api container for 10s"
          docker compose -f docker/docker-compose.integration.yml pause api || true
          sleep 10
          docker compose -f docker/docker-compose.integration.yml unpause api || true

      - name: Collect simple /metrics snapshot and logs
        run: |
          curl -sfS http://localhost:8081/metrics | head -n 100 > metrics.head || true
          docker compose -f docker/docker-compose.integration.yml logs api > api.logs || true
          tar -czf test-artifacts.tar.gz metrics.head api.logs || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-test-artifacts
          path: test-artifacts.tar.gz
