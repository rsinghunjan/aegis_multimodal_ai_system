  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
name: Demo build -> package -> sign -> upload

on:
  workflow_dispatch:
    inputs:
      model_dir:
        description: 'Model directory to export (relative path)'
        required: false
        default: 'training/full_pipeline'
      artifact_name:
        description: 'Name for artifact tarball'
        required: false
        default: 'cifar-demo-0.1.tar.gz'

jobs:
  build_and_sign:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install deps
      run: |
        python -m pip install --upgrade pip
        pip install -r training/full_pipeline/requirements.txt
        pip install onnx onnxruntime requests

    - name: Train & export model
      run: |
        mkdir -p artifacts
        python training/full_pipeline/train_multimodal_cifar.py --out-dir ./model_registry/demo-models/cifar_demo/0.1 --epochs 1

    - name: Make deterministic archive
      run: |
        python3 scripts/make_deterministic_archive.py ./model_registry/demo-models/cifar_demo/0.1 ./artifacts/${{ github.event.inputs.artifact_name }}

    - name: Create model_signature.json
      run: |
        python3 scripts/create_model_signature.py ./artifacts/${{ github.event.inputs.artifact_name }} ./model_registry/demo-models/cifar_demo/0.1/model_signature.json --artifact-uri s3://${{ secrets.OBJECT_STORE_BUCKET }}/model-archives/demo/${{ github.run_id }}/${{ github.event.inputs.artifact_name }}

    - name: Decode cosign key
      if: secrets.COSIGN_PRIVATE_KEY_B64 != ''
      run: |
        echo "${{ secrets.COSIGN_PRIVATE_KEY_B64 }}" | base64 -d > cosign.key
        chmod 600 cosign.key

    - name: Sign artifact with cosign
      if: secrets.COSIGN_PRIVATE_KEY_B64 != ''
      run: |
        ./cosign-linux-amd64 verify 2>/dev/null || true
        # use cosign that is available in the docker image in your CI or install. This step assumes cosign binary is present or set up via actions.
        cosign sign --key cosign.key ./artifacts/${{ github.event.inputs.artifact_name }}

    - name: Upload artifact to S3 (assumes AWS_ROLE_TO_ASSUME secret and OIDC configured)
      uses: jakejarvis/s3-sync-action@v0.5.1
      with:
        args: --acl private
      env:
        SOURCE_DIR: ./artifacts
        AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        DEST_BUCKET: ${{ secrets.OBJECT_STORE_BUCKET }}
.github/workflows/demo_build_sign.yml
