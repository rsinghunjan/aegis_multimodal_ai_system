name: Azure Finalize → Signoff PR

on:
  workflow_dispatch:

jobs:
  create-signoff-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Require secrets
        run: |
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "GH_TOKEN secret is required to create PRs"
            exit 1
          fi
      - name: Configure git
        run: |
          git config user.name "aegis-bot"
          git config user.email "aegis-bot@example.com"
      - name: Create signoff branch and update docs
        env:
          BRANCH: azure/fully-supported/$(date +%Y%m%d%H%M%S)
        run: |
          git checkout -b "$BRANCH"
          # Update support matrix
          if grep -q "Azure — near‑complete" docs/support_matrix.md 2>/dev/null; then
            sed -i 's/Azure — near‑complete/Azure — fully supported/' docs/support_matrix.md || true
          else
            echo "Azure — fully supported" >> docs/support_matrix.md
          fi
          git add docs/support_matrix.md || true
          git commit -m "chore: mark Azure as fully supported and add signoff artifacts" || true
          git push origin "$BRANCH"
      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh auth login --with-token <<< "$GH_TOKEN"
          gh pr create --title "chore: Azure fully supported — signoff" --body "This PR marks Azure as fully supported after executing finalize+verification steps. Attach artifacts and request SRE+Security signoff." --base main --head "$BRANCH"
