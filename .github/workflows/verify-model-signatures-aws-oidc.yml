 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
name: Verify model signatures (AWS OIDC remote verification)

# This workflow demonstrates how to use GitHub Actions OIDC to assume an AWS role
# with minimal, short-lived credentials. The role should have read-only access to the
# staging S3 bucket(s) that contain model artifacts used for verification.
#
# Required GitHub repository secrets:
# - AWS_ROLE_TO_ASSUME     (arn:aws:iam::123456789012:role/ci-verify-models)
# - AWS_REGION            (us-east-1)
# - COSIGN_PUB_KEY        (optional - cosign public key used to verify signatures)
#
# Prepare the AWS side:
# - Create an IAM role with a trust policy allowing GitHub's OIDC provider and the repository
#   subject as appropriate. Grant minimal S3 GetObject/ListBucket permissions to the staging bucket.
# - See docs/runbook_complete.md for example IAM policy and how to set up trust.

on:
  pull_request:
    paths:
      - 'model_registry/**'

jobs:
  verify-signatures-aws-oidc:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: gha-verify-models

      - name: Set COSIGN key (optional)
        if: ${{ secrets.COSIGN_PUB_KEY != '' }}
        run: |
          echo "${{ secrets.COSIGN_PUB_KEY }}" > $GITHUB_WORKSPACE/cosign_pub.pem
          echo "COSIGN_PUB_KEY_PATH=$GITHUB_WORKSPACE/cosign_pub.pem" >> $GITHUB_ENV

      - name: Install Python deps for verifier
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml boto3 google-cloud-storage azure-storage-blob oci cosign

      - name: Compute changed model dirs
        id: changed
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD | awk -F/ '/^model_registry\//{print $2}' | sort -u | tr '\n' ' ')
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Run verifier (uses AWS creds derived via OIDC)
        env:
          # aws-actions has set AWS_ACCESS_KEY_ID etc in the environment
          OBJECT_STORE_TYPE: s3
        run: |
          if [ -z "${{ steps.changed.outputs.changed }}" ]; then
            echo "No changed models detected; verifying all model_registry entries."
            python3 scripts/verify_model_signatures.py
          else
            echo "Verifying changed models: ${{ steps.changed.outputs.changed }}"
            python3 scripts/verify_model_signatures.py ${{ steps.changed.outputs.changed }}
          fi
