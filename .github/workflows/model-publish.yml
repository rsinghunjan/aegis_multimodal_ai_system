name: Model publish metadata

on:
  push:
    paths:
      - 'model_registry/**'

jobs:
  build-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # to commit metadata.json back if needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed model files
        id: find
        run: |
          echo "::set-output name=files::$(git diff --name-only ${{ github.sha }} ${{ github.event.before }} | tr '\n' '|' )"

      - name: Compute checksum and sign
        id: compute
        run: |
          python - <<'PY'
import os, hashlib, hmac, json, sys
from pathlib import Path
key = os.getenv("MODEL_SIGN_KEY")
if not key:
    print("MODEL_SIGN_KEY not set â€” metadata will not be signed", file=sys.stderr)
# Walk model_registry and produce metadata.json for each version folder
root = Path('model_registry')
for model_dir in root.glob('*'):
    if not model_dir.is_dir(): 
        continue
    for version_dir in model_dir.glob('*'):
        if not version_dir.is_dir():
            continue
        # find artifact: prefer first file that's not metadata.json
        artifact = None
        for f in version_dir.iterdir():
            if f.name == 'metadata.json': 
                continue
            if f.is_file():
                artifact = f
                break
        if not artifact:
            print("no artifact under", version_dir)
            continue
        # compute sha256
        h = hashlib.sha256()
        with artifact.open('rb') as fh:
            for chunk in iter(lambda: fh.read(8192), b''):
                h.update(chunk)
        checksum = h.hexdigest()
        sig = None
        if key:
            sig = hmac.new(key.encode('utf-8'), f"{model_dir.name}|{version_dir.name}|{checksum}".encode('utf-8'), hashlib.sha256).hexdigest()
        meta = {
            "model": model_dir.name,
            "version": version_dir.name,
            "artifact": str(artifact),
            "checksum": checksum,
            "signature": sig,
        }
        meta_path = version_dir / 'metadata.json'
        meta_path.write_text(json.dumps(meta, indent=2))
        print("wrote", meta_path)
PY

      - name: Commit metadata files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore(models): add metadata.json with checksum/signature [ci skip]"
          file_pattern: "model_registry/**/metadata.json"
          author_name: "aegis-ci"
          author_email: "aegis-ci@example.com"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
