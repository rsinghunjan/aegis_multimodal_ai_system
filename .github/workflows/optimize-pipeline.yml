name: Optimize model pipeline (CI smoke)

on:
  workflow_dispatch:
  push:
    paths:
      - 'scripts/optimize_model.py'
      - 'api/optimizer.py'
      - 'examples/**'
      - '.github/workflows/optimize-pipeline.yml'

jobs:
  build-and-optimize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install torch onnx onnxruntime onnxruntime-tools joblib scikit-learn skl2onnx boto3

      - name: Create tiny TorchScript model for smoke
        run: |
          python - <<'PY'
          import torch, torch.nn as nn, torch
          class M(nn.Module):
              def __init__(self):
                  super().__init__()
                  self.conv = nn.Conv2d(3, 4, 3, padding=1)
                  self.fc = nn.Linear(4*32*32, 10)
              def forward(self, x):
                  x = self.conv(x)
                  x = x.view(x.size(0), -1)
                  return self.fc(x)
          m = M()
          example = torch.randn(1,3,32,32)
          scripted = torch.jit.trace(m, example)
          scripted.save('smoke_model.pt')
          print('wrote smoke_model.pt')
          PY

      - name: Run optimizer smoke
        run: |
          python scripts/optimize_model.py --input smoke_model.pt --input-type torchscript --example-input-shape 1,3,32,32 --model-name smoke-model --version ci --quantize dynamic --output-dir optimized_smoke --register || true
        # register may be a no-op in CI if api.registry is not present.

      - name: List outputs
        run: |
          ls -la optimized_smoke || true
