  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
name: Weekly DR Restore Drill

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # weekly on Monday 06:00 UTC

jobs:
  restore-drill:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin docker.io jq

      - name: Start local integration stack (Postgres+MinIO)
        run: |
          docker compose -f docker/docker-compose.integration.yml up -d --build

      - name: Wait for api health
        run: |
          ./scripts/wait_for_services.sh http://localhost:8081/health 120 2

      - name: Prepare DB & push base backup
        env:
          WALG_S3_PREFIX: ${{ secrets.WALG_S3_PREFIX }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          docker compose -f docker/docker-compose.integration.yml exec -T api alembic upgrade head || true
          docker compose -f docker/docker-compose.integration.yml exec -T api python scripts/seed_db.py || true
          # run wal-g backup inside container (container image must have wal-g installed)
          docker compose -f docker/docker-compose.integration.yml exec -T api bash -lc "export WALG_S3_PREFIX='${WALG_S3_PREFIX}' && ./scripts/pg_backup_walg.sh"

      - name: Run restore drill runner (local mode)
        env:
          WALG_S3_PREFIX: ${{ secrets.WALG_S3_PREFIX }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          ./scripts/restore_drill_runner.sh --mode local --pgdata /tmp/aegis_restore_pgdata --listen-port 55432

