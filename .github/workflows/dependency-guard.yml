  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
# Detect major dependency bumps in PRs and annotate PRs when a major bump is present.
# This workflow runs quickly on PRs and will label PRs that perform a major bump so maintainers can require manual review.
#
# Note: This workflow *annotates* PRs and adds a label; branch protection + required checks (CI + staged-integration)
# must be configured separately (see scripts/setup_branch_protection.sh and guidance below).
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-major-bump:
    name: Detect major dependency bumps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install packaging lib
        run: python -m pip install --upgrade pip packaging

      - name: Run major bump detector
        id: detect
        run: |
          python3 scripts/check_major_bump.py || true
          # Script writes JSON to /tmp/major_bumps.json if any major bumps found
          if [ -f /tmp/major_bumps.json ]; then
            echo "::set-output name=major_bumps::true"
          else
            echo "::set-output name=major_bumps::false"
          fi

      - name: Annotate PR if major bump(s) detected
        if: steps.detect.outputs.major_bumps == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/major_bumps.json','utf8');
            const data = JSON.parse(body || '[]');
            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(l => l.name);
            // add label 'major-bump' if not present
            if (!labels.includes('major-bump')) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['major-bump']
              });
            }
            // Post a helpful comment
            const summary = data.map(d => `- ${d.package}: ${d.old_version} -> ${d.new_version}`).join("\n");
            const comment = [
              "⚠️ Detected major dependency version bump(s) in this PR:",
              "",
              summary,
              "",
              "Please note:",
              "- Major dependency upgrades require manual review and a staged integration run before merging.",
              "- Ensure CI (build-and-test) passes and that the `staged-integration` job completes successfully.",
              "",
              "Maintainers: apply a review approval once integration testing has validated the changes."
            ].join("\n");
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });
.github/workflows/dependency-guard.yml
 



