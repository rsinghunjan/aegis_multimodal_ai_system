  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
name: Staged integration tests (runs on dependency file changes)

# This workflow runs heavier integration tests whenever dependency manifest files change,
# or on-demand if a maintainer requests by re-running the workflow for a PR.
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'requirements.in'
      - 'requirements.txt'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'setup.cfg'
      - 'Pipfile'
      - 'Pipfile.lock'

jobs:
  staged-integration:
    name: Staged integration (heavy)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install from lock (requirements.txt)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else echo "requirements.txt missing" && exit 1; fi

      - name: Prepare infra (optional)
        run: |
          # Example: bring up light dependencies if tests require services (Postgres, Redis)
          # docker-compose -f docker-compose.postgres.yml up -d
          echo "No infra boot step defined by default. Add your infra startup here if needed."

      - name: Run integration tests
        run: |
          if [ -d tests/integration ]; then
            python -m pytest -q tests/integration -k "not long" --maxfail=1
          else
            echo "No integration tests found in tests/integration"
          fi

      - name: Tear down infra (optional)
        if: always()
        run: |
          # docker-compose -f docker-compose.postgres.yml down || true
          echo "Tear down step placeholder"
