*** Begin Patch
*** Add File: cloud_tpu/.github/workflows/cloud_tpu_smoke.yml
+name: Cloud TPU Smoke Test
+on:
+  workflow_dispatch:
+    inputs:
+      tpu_name:
+        required: false
+        default: tpuvm-smoke
+      zone:
+        required: false
+        default: us-central1-b
+      accelerator_type:
+        required: false
+        default: v4-8
+      tpu_version:
+        required: false
+        default: v4
+
+jobs:
+  smoke:
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Authenticate to GCP
+        env:
+          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
+        run: |
+          echo "$GCP_SA_KEY" > /tmp/gcp-key.json
+          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
+          gcloud config set project "${{ secrets.GCP_PROJECT }}"
+
+      - name: Create TPU VM
+        env:
+          TPU_NAME: ${{ github.event.inputs.tpu_name }}
+          TPU_ZONE: ${{ github.event.inputs.zone }}
+          TPU_TYPE: ${{ github.event.inputs.accelerator_type }}
+          TPU_VERSION: ${{ github.event.inputs.tpu_version }}
+        run: |
+          echo "Creating TPU VM ${TPU_NAME}..."
+          gcloud compute tpus tpu-vm create "${TPU_NAME}" \
+            --zone="${TPU_ZONE}" \
+            --accelerator-type="${TPU_TYPE}" \
+            --version="${TPU_VERSION}" \
+            --quiet
+
+      - name: Copy smoke test to TPU VM and run
+        env:
+          TPU_NAME: ${{ github.event.inputs.tpu_name }}
+          TPU_ZONE: ${{ github.event.inputs.zone }}
+        run: |
+          gcloud compute tpus tpu-vm scp ./cloud_tpu/tpu_smoke_test.py "${TPU_NAME}":~/ --zone="${TPU_ZONE}"
+          gcloud compute tpus tpu-vm ssh "${TPU_NAME}" --zone="${TPU_ZONE}" --command "python3 ~/tpu_smoke_test.py"
+
+      - name: Delete TPU VM (teardown)
+        env:
+          TPU_NAME: ${{ github.event.inputs.tpu_name }}
+          TPU_ZONE: ${{ github.event.inputs.zone }}
+        run: |
+          echo "Deleting TPU VM ${TPU_NAME}..."
+          gcloud compute tpus tpu-vm delete "${TPU_NAME}" --zone="${TPU_ZONE}" --quiet
+
*** End Patch
*** Begin Patch
*** Add File: cloud_tpu/Dockerfile.tpu
+FROM python:3.10-slim
+
+# Minimal image with JAX and TPU tooling. In practice, pick the official TPU/JAX images.
+RUN apt-get update && apt-get install -y --no-install-recommends \
+    build-essential git curl ca-certificates ssh \
+  && rm -rf /var/lib/apt/lists/*
+
+RUN pip install --no-cache-dir jax jaxlib==0.4.14+cuda11_cudnn86 -f https://storage.googleapis.com/jax-releases/jax_releases.html || true
+
+WORKDIR /workspace
+COPY tpu_smoke_test.py /workspace/tpu_smoke_test.py
+CMD ["python3","/workspace/tpu_smoke_test.py"]
+
*** End Patch
*** Begin Patch
*** Add File: cloud_tpu/tpu_smoke_test.py
+"""
+Simple TPU smoke test.
+- Prints available devices via jax.
+- Exits non-zero if no TPU devices are available.
+"""
+import sys
+import time
+
+try:
+    import jax
+except Exception as e:
+    print("Failed to import jax:", e)
+    sys.exit(2)
+
+devs = jax.devices()
+print("JAX devices:", devs)
+if not devs:
+    print("No TPU devices found")
+    sys.exit(1)
+else:
+    print("TPU smoke test OK")
+    sys.exit(0)
+
*** End Patch
*** Begin Patch
*** Add File: cloud_tpu/README.md
+# Cloud TPU integration (smoke test)
+
+What this provides
+- A GitHub Actions workflow that provisions a TPU VM, copies a small TPU smoke test script, runs it, and tears down the TPU VM.
+
+Prerequisites
+- GCP project with TPU quota enabled.
+- Service account key with appropriate roles stored as `GCP_SA_KEY` in GitHub Secrets.
+- `GCP_PROJECT` secret set to target project.
+
+Notes
+- This workflow is a minimal example for validation. For production training adapt images and launch training processes that use XLA/JAX/TF TPU runtimes and checkpoint to your COMPLIANCE_BUCKET.
+
*** End Patch
*** Begin Patch
*** Add File: edge_tpu/ansible/roles/edge_tpu/tasks/main.yml
+---
+- name: Ensure apt cache updated
+  apt:
+    update_cache: yes
+
+- name: Add Coral APT repository (Debian/Ubuntu)
+  apt_repository:
+    repo: 'deb https://packages.cloud.google.com/apt coral-edgetpu-stable main'
+    state: present
+  when: ansible_os_family == "Debian"
+
+- name: Install libedgetpu runtime (Debian/Ubuntu)
+  apt:
+    name:
+      - libedgetpu1-std
+      - python3-pip
+    state: present
+  when: ansible_os_family == "Debian"
+
+- name: Install Python dependencies for smoke test
+  pip:
+    name:
+      - pycoral
+    executable: pip3
+
+- name: Create directory for edge-tpu test
+  file:
+    path: /opt/edge_tpu
+    state: directory
+    owner: root
+    mode: "0755"
+
+- name: Copy smoke test
+  copy:
+    src: ../../smoke_test.py
+    dest: /opt/edge_tpu/smoke_test.py
+    mode: "0755"
+
+- name: Run smoke test
+  command: python3 /opt/edge_tpu/smoke_test.py
+  register: smoke
+  failed_when: smoke.rc != 0
+
*** End Patch
*** Begin Patch
*** Add File: edge_tpu/ansible/roles/edge_tpu/files/README.txt
+Place any vendor packages or local driver files here if you need offline installation.
+By default this role installs packages from the Coral package repository.
+
*** End Patch
*** Begin Patch
*** Add File: edge_tpu/docker/edge_tpu_test.Dockerfile
+FROM debian:bookworm-slim
+RUN apt-get update && apt-get install -y --no-install-recommends python3 python3-pip ca-certificates \
+  && rm -rf /var/lib/apt/lists/*
+RUN pip3 install pycoral
+WORKDIR /opt/edge_tpu
+COPY smoke_test.py /opt/edge_tpu/smoke_test.py
+CMD ["python3", "/opt/edge_tpu/smoke_test.py"]
+
*** End Patch
*** Begin Patch
*** Add File: edge_tpu/smoke_test.py
+"""
+Edge TPU (Coral) smoke test placeholder using pycoral.
+This script tries to import pycoral and reports success.
+On a real device, you'd run an inference with an edgetpu-compiled model.
+"""
+import sys
+try:
+    from pycoral.utils.edgetpu import list_edge_tpus
+    tpus = list_edge_tpus()
+    print("Edge TPUs found:", tpus)
+    if not tpus:
+        print("No Edge TPU devices found")
+        sys.exit(1)
+    print("Edge TPU smoke test OK")
+    sys.exit(0)
+except Exception as e:
+    print("Edge TPU smoke test failure:", e)
+    sys.exit(2)
+
*** End Patch
*** Begin Patch
*** Add File: docs/tpu_support.md
+# TPU Support in Aegis
+
+This document describes the TPU support we are adding: Cloud TPUs (GCP TPU VMs) and Edge TPUs (Coral).
+
+Cloud TPU (GCP)
+- Workflow: .github/workflows/cloud_tpu_smoke.yml
+- Smoke test: cloud_tpu/tpu_smoke_test.py
+- Image example: cloud_tpu/Dockerfile.tpu
+- Secrets required:
+  - GCP_SA_KEY (service account JSON)
+  - GCP_PROJECT
+  - Optionally GCP_ZONE / TPU type can be passed as workflow inputs
+
+Edge TPU (Coral)
+- Ansible role: edge_tpu/ansible/roles/edge_tpu/
+- Smoke test: edge_tpu/smoke_test.py
+- Container example: edge_tpu/docker/edge_tpu_test.Dockerfile
+- Notes: role installs libedgetpu via Coral APT repository; devices must have network access or you must supply packages in role files.
+
+Validation
+- Cloud TPU: run the workflow (dispatch) to create a TPU VM, run the smoke test, and teardown.
+- Edge TPU: run the Ansible role against a test device in inventory and verify the smoke test passes and artifacts are created.
+
+Costs & cautions
+- Cloud TPUs incur charges while provisioned; workflows tear down resources but be mindful of quotas and accidental long-lived resources.
+- Edge TPU installs require root access and driver installs on devices.
+
*** End Patch
*** Begin Patch
*** Add File: k8s/examples/edge-tpu-job.yaml
+apiVersion: batch/v1
+kind: Job
+metadata:
+  name: edge-tpu-smoke
+  namespace: staging
+spec:
+  template:
+    spec:
+      restartPolicy: Never
+      containers:
+      - name: edge-tpu-test
+        image: ghcr.io/yourorg/edge-tpu-test:latest
+        # If running on a node with hostPath to device, mount as needed:
+        # volumeMounts:
+        # - name: usb
+        #   mountPath: /dev/bus/usb
+        resources:
+          limits:
+            cpu: "500m"
+            memory: "256Mi"
+      # volumes:
+      # - name: usb
+      #   hostPath:
+      #     path: /dev/bus/usb
+
*** End Patch
*** Begin Patch
*** Add File: runbooks/tpu_runbook.md
+# TPU Runbook — smoke tests and validation
+
## Cloud TPU smoke test (GCP)
+Preconditions:
+- GCP project with TPU quota, service account key in GitHub secret `GCP_SA_KEY`.
+
+Dispatch workflow:
+ - Go to Actions → "Cloud TPU Smoke Test" → Run workflow
+ - Provide inputs if needed (tpu_name, zone, accelerator_type)
+
+What it does:
+ - Creates a TPU VM, copies tpu_smoke_test.py, runs it, then deletes the TPU VM.
+ - Check logs in the GitHub Action for success/failure and jax device listing.
+
+Troubleshooting:
+ - If creation fails, verify TPU quota and network/VPC configuration.
+ - If jax import fails on TPU VM, ensure TPU runtime and pip packages are present or use an official TPU image.
+
## Edge TPU smoke test (Coral)
+Preconditions:
+- Device accessible via SSH/Ansible, running Debian/Ubuntu (the role targets Debian family).
+
+Run:
+ - ansible-playbook -i inventory/edge_devices.ini edge_tpu/ansible/roles/edge_tpu/tasks/main.yml
+
+What it does:
+ - Installs libedgetpu and pycoral, copies smoke_test.py and runs it.
+ - On success the playbook completes; on failure Ansible will report failed task and output.
+
+Troubleshooting:
+ - If apt repo is not reachable, place packages in edge_tpu/ansible/roles/edge_tpu/files and adjust the role to install locally.
+ - For Coral Dev Board, check vendor docs for any board-specific steps.
+
*** End Patch
*** End Patch
