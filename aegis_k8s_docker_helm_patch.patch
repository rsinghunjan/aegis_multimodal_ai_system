*** Begin Patch
*** Add File:charts/aegis-core/Chart.yaml
+apiVersion: v2
+name: aegis-core
+description: "Aegis core platform Helm chart (API, controllers, model-serving)"
+type: application
+version: 0.1.0
+appVersion: "0.1.0"
+
*** End Patch
*** Begin Patch
*** Add File:charts/aegis-core/values.yaml
+replicaCount: 2
+
+image:
+  repository: "{{ .Values.registry | default \"registry.example.com/aegis\" }}"
+  pullPolicy: IfNotPresent
+  tag: "latest"
+
+api:
+  enabled: true
+  name: aegis-api
+  image:
+    repository: "{{ .Values.image.repository }}"
+    tag: "{{ .Values.image.tag }}"
+  resources:
+    limits:
+      cpu: "500m"
+      memory: "512Mi"
+    requests:
+      cpu: "200m"
+      memory: "256Mi"
+  livenessProbe:
+    httpGet:
+      path: /healthz
+      port: 8081
+    initialDelaySeconds: 30
+    periodSeconds: 10
+  readinessProbe:
+    httpGet:
+      path: /ready
+      port: 8081
+    initialDelaySeconds: 5
+    periodSeconds: 5
+
+controllers:
+  enabled: true
+  name: modelcontext-controller
+  image:
+    repository: "{{ .Values.image.repository }}"
+    tag: "{{ .Values.image.tag }}"
+  resources:
+    limits:
+      cpu: "300m"
+      memory: "256Mi"
+    requests:
+      cpu: "100m"
+      memory: "128Mi"
+
+serving:
+  enabled: true
+  name: aegis-model
+  image:
+    repository: "{{ .Values.image.repository }}"
+    tag: "{{ .Values.image.tag }}"
+  replicas: 2
+  resources:
+    limits:
+      cpu: "1000m"
+      memory: "1Gi"
+    requests:
+      cpu: "250m"
+      memory: "512Mi"
+
+service:
+  type: ClusterIP
+  port: 8081
+
+pdb:
+  enabled: true
+  minAvailable: 1
+
*** End Patch
*** Begin Patch
*** Add File:charts/aegis-core/templates/service.yaml
+{{- if .Values.api.enabled }}
+apiVersion: v1
+kind: Service
+metadata:
+  name: {{ .Values.api.name }}
+  labels:
+    app: {{ .Values.api.name }}
+spec:
+  type: {{ .Values.service.type }}
+  ports:
+    - port: {{ .Values.service.port }}
+      targetPort: {{ .Values.service.port }}
+      protocol: TCP
+  selector:
+    app: {{ .Values.api.name }}
+{{- end }}
+
*** End Patch
*** Begin Patch
*** Add File:charts/aegis-core/templates/deployment-api.yaml
+{{- if .Values.api.enabled }}
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: {{ .Values.api.name }}
+  labels:
+    app: {{ .Values.api.name }}
+spec:
+  replicas: {{ .Values.replicaCount }}
+  selector:
+    matchLabels:
+      app: {{ .Values.api.name }}
+  template:
+    metadata:
+      labels:
+        app: {{ .Values.api.name }}
+    spec:
+      serviceAccountName: aegis-agent
+      containers:
+        - name: api
+          image: "{{ .Values.api.image.repository }}:{{ .Values.api.image.tag }}"
+          imagePullPolicy: {{ .Values.image.pullPolicy }}
+          ports:
+            - containerPort: {{ .Values.service.port }}
+          resources:
+{{ toYaml .Values.api.resources | indent 12 }}
+          livenessProbe:
+{{ toYaml .Values.api.livenessProbe | indent 12 }}
+          readinessProbe:
+{{ toYaml .Values.api.readinessProbe | indent 12 }}
+          env:
+            - name: AEGIS_ENV
+              value: "production"
+{{- end }}
+
*** End Patch
*** Begin Patch
*** Add File:charts/aegis-core/templates/deployment-controllers.yaml
+{{- if .Values.controllers.enabled }}
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: {{ .Values.controllers.name }}
+  labels:
+    app: {{ .Values.controllers.name }}
+spec:
+  replicas: 1
+  selector:
+    matchLabels:
+      app: {{ .Values.controllers.name }}
+  template:
+    metadata:
+      labels:
+        app: {{ .Values.controllers.name }}
+    spec:
+      serviceAccountName: modelcontext-controller
+      containers:
+        - name: controller
+          image: "{{ .Values.controllers.image.repository }}:{{ .Values.controllers.image.tag }}"
+          imagePullPolicy: {{ .Values.image.pullPolicy }}
+          resources:
+{{ toYaml .Values.controllers.resources | indent 12 }}
+          livenessProbe:
+            httpGet:
+              path: /healthz
+              port: 8080
+            initialDelaySeconds: 20
+            periodSeconds: 15
+          readinessProbe:
+            httpGet:
+              path: /ready
+              port: 8080
+            initialDelaySeconds: 5
+            periodSeconds: 10
+{{- end }}
+
*** End Patch
*** Begin Patch
*** Add File:charts/aegis-core/templates/deployment-serve.yaml
+{{- if .Values.serving.enabled }}
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: {{ .Values.serving.name }}
+  labels:
+    app: {{ .Values.serving.name }}
+spec:
+  replicas: {{ .Values.serving.replicas }}
+  selector:
+    matchLabels:
+      app: {{ .Values.serving.name }}
+  template:
+    metadata:
+      labels:
+        app: {{ .Values.serving.name }}
+    spec:
+      serviceAccountName: aegis-agent
+      containers:
+        - name: model-server
+          image: "{{ .Values.serving.image.repository }}:{{ .Values.serving.image.tag }}"
+          imagePullPolicy: {{ .Values.image.pullPolicy }}
+          ports:
+            - containerPort: 8080
+          resources:
+{{ toYaml .Values.serving.resources | indent 12 }}
+          readinessProbe:
+            httpGet:
+              path: /ready
+              port: 8080
+            initialDelaySeconds: 10
+            periodSeconds: 5
+          livenessProbe:
+            httpGet:
+              path: /healthz
+              port: 8080
+            initialDelaySeconds: 20
+            periodSeconds: 10
+{{- end }}
+
*** End Patch
*** Begin Patch
*** Add File:charts/aegis-core/templates/pdb.yaml
+{{- if .Values.pdb.enabled }}
+apiVersion: policy/v1
+kind: PodDisruptionBudget
+metadata:
+  name: aegis-core-pdb
+spec:
+  minAvailable: {{ .Values.pdb.minAvailable }}
+  selector:
+    matchLabels:
+      app: {{ .Values.api.name }}
+{{- end }}
+
*** End Patch
*** Begin Patch
*** Add File:Makefile
+# Makefile: build, sign, push, helm deploy helpers
+REGISTRY ?= registry.example.com/aegis
+IMAGE_NAME ?= aegis
+TAG ?= latest
+COSIGN_KEY ?= "$(COSIGN_KEY)"
+
+.PHONY: build
+build:
+	docker build -t $(REGISTRY)/$(IMAGE_NAME):$(TAG) .
+
+.PHONY: push
+push: build
+	@echo "Pushing image to $(REGISTRY)"
+	docker push $(REGISTRY)/$(IMAGE_NAME):$(TAG)
+
+.PHONY: sign
+sign:
+	@if [ -z "$(COSIGN_KEY)" ]; then \
+		echo "COSIGN_KEY not set, skipping signing"; \
+	else \
+		echo "Signing image with cosign"; \
+		cosign sign --key $(COSIGN_KEY) $(REGISTRY)/$(IMAGE_NAME):$(TAG); \
+	fi
+
+.PHONY: deploy
+deploy: push sign
+	@echo "Deploying helm chart aegis-core"
+	helm upgrade --install aegis-core charts/aegis-core --set image.repository=$(REGISTRY)/$(IMAGE_NAME) --set image.tag=$(TAG) --wait
+
+.PHONY: clean
+clean:
+	-docker rmi $(REGISTRY)/$(IMAGE_NAME):$(TAG) || true
+
*** End Patch
*** Begin Patch
*** Add File:.github/workflows/build_and_deploy.yml
+name: Build, Sign, Push & Deploy
+on:
+  workflow_dispatch:
+  push:
+    branches:
+      - main
+
+jobs:
+  build-deploy:
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Set up Docker Buildx
+        uses: docker/setup-buildx-action@v2
+
+      - name: Login to Registry
+        uses: docker/login-action@v2
+        with:
+          registry: ${{ secrets.REGISTRY_HOST }}
+          username: ${{ secrets.REGISTRY_USER }}
+          password: ${{ secrets.REGISTRY_PASS }}
+
+      - name: Build and push image
+        run: |
+          IMAGE="${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }}:${GITHUB_SHA::8}"
+          docker build -t $$IMAGE .
+          docker push $$IMAGE
+          echo "image=$$IMAGE" >> $GITHUB_ENV
+
+      - name: Sign image with cosign (if key available)
+        env:
+          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
+        run: |
+          if [ -n "${{ secrets.COSIGN_KEY }}" ]; then
+            echo "${{ secrets.COSIGN_KEY }}" > cosign.key
+            cosign sign --key cosign.key ${{ env.image }}
+          else
+            echo "No COSIGN_KEY provided; skipping cosign"
+          fi
+
+      - name: Configure Kubeconfig
+        env:
+          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
+        run: |
+          echo "$KUBECONFIG_DATA" | base64 --decode > kubeconfig
+          export KUBECONFIG=$PWD/kubeconfig
+          kubectl config current-context
+
+      - name: Helm deploy
+        env:
+          IMAGE: ${{ env.image }}
+        run: |
+          helm upgrade --install aegis-core charts/aegis-core --set image.repository=${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }} --set image.tag=${GITHUB_SHA::8} --wait
+
*** End Patch
*** Begin Patch
*** Add File:k8s/prod/model-serving-deployment.yaml
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: aegis-model
+  namespace: aegis
+  labels:
+    app: aegis-model
+spec:
+  replicas: 3
+  selector:
+    matchLabels:
+      app: aegis-model
+  template:
+    metadata:
+      labels:
+        app: aegis-model
+    spec:
+      serviceAccountName: aegis-agent
+      containers:
+        - name: model-server
+          image: registry.example.com/aegis/aegis-model:stable
+          ports:
+            - containerPort: 8080
+          resources:
+            requests:
+              cpu: "250m"
+              memory: "512Mi"
+            limits:
+              cpu: "1000m"
+              memory: "1Gi"
+          readinessProbe:
+            httpGet:
+              path: /ready
+              port: 8080
+            initialDelaySeconds: 10
+            periodSeconds: 5
+            failureThreshold: 3
+          livenessProbe:
+            httpGet:
+              path: /healthz
+              port: 8080
+            initialDelaySeconds: 30
+            periodSeconds: 10
+            failureThreshold: 3
+
+---
+apiVersion: policy/v1
+kind: PodDisruptionBudget
+metadata:
+  name: aegis-model-pdb
+  namespace: aegis
+spec:
+  minAvailable: 2
+  selector:
+    matchLabels:
+      app: aegis-model
+
*** End Patch
*** Begin Patch
*** Add File:k8s/prod/controllers-deployment.yaml
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: modelcontext-controller
+  namespace: aegis
+  labels:
+    app: modelcontext-controller
+spec:
+  replicas: 1
+  selector:
+    matchLabels:
+      app: modelcontext-controller
+  template:
+    metadata:
+      labels:
+        app: modelcontext-controller
+    spec:
+      serviceAccountName: modelcontext-controller
+      containers:
+        - name: controller
+          image: registry.example.com/aegis/controllers:stable
+          resources:
+            requests:
+              cpu: "100m"
+              memory: "128Mi"
+            limits:
+              cpu: "300m"
+              memory: "256Mi"
+          livenessProbe:
+            httpGet:
+              path: /healthz
+              port: 8080
+            initialDelaySeconds: 20
+            periodSeconds: 15
+          readinessProbe:
+            httpGet:
+              path: /ready
+              port: 8080
+            initialDelaySeconds: 5
+            periodSeconds: 10
+
+---
+apiVersion: policy/v1
+kind: PodDisruptionBudget
+metadata:
+  name: modelcontext-controller-pdb
+  namespace: aegis
+spec:
+  minAvailable: 1
+  selector:
+    matchLabels:
+      app: modelcontext-controller
+
*** End Patch
*** Begin Patch
*** Add File:docs/local_dev/kind_minikube.md
+# Local development with kind / minikube (quick start)
+
+This guide shows how to run Aegis components locally using kind (Kubernetes in Docker) or minikube, iterate on images, and exercise Argo workflows and controllers.
+
+Prereqs
+- Docker
+- kind (https://kind.sigs.k8s.io/)
+- kubectl
+- helm
+- argo CLI (optional; can use kubectl apply for workflows)
+
+1) Create a local cluster (kind example)
+ - kind create cluster --name aegis-dev
+ - kubectl cluster-info --context kind-aegis-dev
+
+2) Load images into kind (after building locally)
+ - docker build -t registry.example.com/aegis/aegis-model:local -f Dockerfile .
+ - kind load docker-image registry.example.com/aegis/aegis-model:local --name aegis-dev
+
+3) Install Argo Workflows (optional)
+ - kubectl create namespace argo || true
+ - kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo-workflows/stable/manifests/install.yaml
+
+4) Install Helm chart in dev
+ - helm upgrade --install aegis-core charts/aegis-core --set image.repository=registry.example.com/aegis/aegis-model --set image.tag=local
+
+5) Deploy CRDs & RBAC
+ - kubectl apply -f k8s/crd/modelcontext_crd.yaml
+ - kubectl apply -f k8s/crd/testrun_crd.yaml
+ - kubectl apply -f k8s/modelcontext_rbac.yaml -n default || true
+ - kubectl apply -f k8s/testrun_rbac.yaml -n default || true
+
+6) Run mock services (locally or in-cluster)
+ - python3 qa/mocks/mock_hsm.py &
+ - python3 qa/mocks/mock_qpu.py &
+
+7) Submit a sample Argo workflow
+ - argo submit qa/argo/qa_e2e.yaml --watch
+
+8) Debugging tips
+ - kubectl -n default get pods
+ - kubectl logs -n default <pod-name>
+ - kubectl port-forward svc/aegis-api 8081:8081
+ - Use `kind load docker-image` to iterate on container builds without pushing to registry.
+
+Notes for minikube
+- Use `minikube image load` to load local images into minikube.
+- If using minikube, enable addons (ingress) as needed: minikube addons enable ingress
+
*** End Patch
*** End Patch
