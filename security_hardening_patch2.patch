*** Begin Patch
*** Add File: .github/workflows/aws_oidc_assume_role_example.yml
+name: AWS OIDC Assume Role Example
+
+on:
+  workflow_dispatch:
+    inputs:
+      run_command:
+        description: "Command to run once AWS creds are configured"
+        required: false
+        default: "aws sts get-caller-identity"
+
+permissions:
+  id-token: write        # required to request OIDC token from GitHub
+  contents: read
+
+jobs:
+  assume-role:
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Configure AWS credentials using OIDC
+        uses: aws-actions/configure-aws-credentials@v2
+        with:
+          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
+          aws-region: ${{ secrets.AWS_REGION }}
+          role-session-name: aegis-oidc-session
+
+      - name: Verify identity
+        run: |
+          echo "Running: ${{ github.event.inputs.run_command }}"
+          ${{ github.event.inputs.run_command }}
+
+      - name: Run KMS dry-run (list keys)
+        run: |
+          echo "Listing KMS keys (permissions must allow:list on KMS)"
+          aws kms list-keys --region "${{ secrets.AWS_REGION }}" || true
+
+      - name: Example: run staging rotation script (optional)
+        if: ${{ secrets.AWS_BACKUP_BUCKET && secrets.AWS_IRSA_ROLE_ARN }}
+        run: |
+          chmod +x scripts/rotate_kms_aws.sh
+          ./scripts/rotate_kms_aws.sh --alias "alias/aegis-backup-$(date +%Y%m%d%H%M%S)" --role-arn "${{ secrets.AWS_IRSA_ROLE_ARN }}" --run-drill no --bucket "${{ secrets.AWS_BACKUP_BUCKET }}"
+
+# Notes:
+# - Provide secret AWS_OIDC_ROLE_ARN pointing to the IAM Role configured with trust for GitHub OIDC.
+# - This workflow demonstrates how to eliminate static AWS_ACCESS_KEY_ID/SECRET usage and require OIDC.
+
*** End Patch
*** Begin Patch
*** Add File: scripts/scan_git_history_gitleaks.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# scan_git_history_gitleaks.sh
+# Run gitleaks across git history to detect any committed secrets.
+# Outputs a JSON report to artifacts/gitleaks-report.json
+#
+OUT_DIR="${OUT_DIR:-artifacts}"
+REPORT="${OUT_DIR}/gitleaks-report.json"
+
+mkdir -p "$OUT_DIR"
+
+if ! command -v gitleaks >/dev/null 2>&1; then
+  echo "gitleaks not found. Install it (https://github.com/zricethezav/gitleaks) or run via Docker."
+  exit 2
+fi
+
+echo "Running gitleaks on repository history..."
+gitleaks detect --source . --report-format json --report-path "$REPORT" || true
+
+if [ -s "$REPORT" ]; then
+  echo "gitleaks found potential secrets. Report: $REPORT"
+  jq '.leaks | length' "$REPORT" || true
+  echo "Please rotate any discovered secrets immediately and mark the findings for security review."
+  exit 1
+else
+  echo "No secrets found in git history by gitleaks."
+fi
+
*** End Patch
*** Begin Patch
*** Add File: scripts/create_kms_deny_alert.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# create_kms_deny_alert.sh
+#
+# Create an SNS topic and EventBridge rule that forwards KMS "AccessDenied" events to SNS.
+# This is a convenience helper — run with AWS CLI credentials that can create SNS/EventBridge/CloudWatch permissions.
+#
+# Usage:
+#   ./scripts/create_kms_deny_alert.sh --sns-topic arn:aws:sns:... --rule-name aegis-kms-deny-rule --region us-west-2
+#
+SNS_TOPIC_ARN=""
+RULE_NAME="${RULE_NAME:-aegis-kms-deny-rule}"
+REGION="${AWS_REGION:-us-west-2}"
+
+while [ $# -gt 0 ]; do
+  case "$1" in
+    --sns-topic) SNS_TOPIC_ARN="$2"; shift 2;;
+    --rule-name) RULE_NAME="$2"; shift 2;;
+    --region) REGION="$2"; shift 2;;
+    -h|--help) sed -n '1,120p' "$0"; exit 0;;
+    *) echo "Unknown arg: $1"; exit 2;;
+  esac
+done
+
+if [ -z "$SNS_TOPIC_ARN" ]; then
+  echo "Creating SNS topic: aegis-kms-alerts"
+  TOPIC_NAME="aegis-kms-alerts-$(date +%s)"
+  SNS_TOPIC_ARN=$(aws sns create-topic --name "$TOPIC_NAME" --region "$REGION" --query TopicArn --output text)
+  echo "Created SNS topic: $SNS_TOPIC_ARN"
+fi
+
+echo "Creating EventBridge rule to match KMS AccessDenied events..."
+# Match CloudTrail events with errorCode AccessDenied for KMS actions
+PATTERN=$(cat <<'JSON'
+{
+  "source": ["aws.kms"],
+  "detail-type": ["AWS API Call via CloudTrail"],
+  "detail": {
+    "errorCode": [{"exists": true}],
+    "eventSource": [{"prefix": "kms."}],
+    "errorMessage": [{"prefix": "AccessDenied"}, {"prefix": "is not authorized"}, {"prefix": "Not authorized"}]
+  }
+}
+JSON
+)
+
+RULE_ARN=$(aws events put-rule --name "$RULE_NAME" --event-pattern "$PATTERN" --region "$REGION" --query "Arn" --output text)
+echo "Created/updated rule: $RULE_ARN"
+
+echo "Granting permissions and adding SNS topic as target"
+TARGET_ID="aegis-kms-deny-target"
+aws events put-targets --rule "$RULE_NAME" --targets "Id=$TARGET_ID,Arn=${SNS_TOPIC_ARN}" --region "$REGION"
+
+echo "Ensure EventBridge can publish to SNS by adding the appropriate resource policy (managed by this script)."
+POLICY=$(cat <<JSON
+{
+  "Version": "2012-10-17",
+  "Statement": [
+    {
+      "Effect": "Allow",
+      "Principal": {
+        "Service": "events.amazonaws.com"
+      },
+      "Action": "sns:Publish",
+      "Resource": "${SNS_TOPIC_ARN}"
+    }
+  ]
+}
+JSON
+)
+
+aws sns set-topic-attributes --topic-arn "$SNS_TOPIC_ARN" --attribute-name Policy --attribute-value "$POLICY" --region "$REGION" || true
+
+echo "KMS deny alert created. Subscribe to the SNS topic to receive notifications."
+echo "SNS_TOPIC_ARN=${SNS_TOPIC_ARN}"
+
*** End Patch
*** Begin Patch
*** Add File: .github/workflows/dangerous_actions_gate.yml
+name: Dangerous Actions Gate
+
+# This workflow demonstrates gating for dangerous operations using Environments.
+# Configure the Environment `dangerous-ops` in repository settings and require manual reviewers there.
+
+on:
+  workflow_dispatch:
+    inputs:
+      operation:
+        description: "Dangerous op to run (create-kms|create-policy|rotate-kms)"
+        required: true
+
+permissions:
+  contents: read
+
+jobs:
+  gated:
+    runs-on: ubuntu-latest
+    environment: dangerous-ops
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Run gated operation (example)
+        run: |
+          echo "Running gated operation: ${{ github.event.inputs.operation }}"
+          case "${{ github.event.inputs.operation }}" in
+            create-kms) echo "Create KMS key in staging (operator must approve environment)";;
+            create-policy) echo "Apply IAM policy change after approval";;
+            rotate-kms) echo "Rotate KMS key workflow (staging)";;
+            *) echo "Unknown operation"; exit 1;;
+          esac
+
+# Notes:
+# - Protect the environment 'dangerous-ops' with required reviewers so operations require manual approval.
+# - Use this pattern when performing IAM/KMS/backups that change security posture.
+
*** End Patch
*** Begin Patch
*** Add File: .github/workflows/nightly_staging_drills.yml
+name: Nightly Staging Drills (per-cloud)
+
+on:
+  schedule:
+    - cron: "0 2 * * *"   # daily at 02:00 UTC
+
+permissions:
+  contents: read
+
+jobs:
+  staging-drill:
+    runs-on: ubuntu-latest
+    strategy:
+      matrix:
+        cloud: [aws, azure, oci, alibaba]
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Setup kubeconfig (if secret provided)
+        run: |
+          if [ -n "${{ secrets.KUBE_CONFIG_DATA }}" ]; then
+            echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > /tmp/kubeconfig
+            mkdir -p $HOME/.kube
+            mv /tmp/kubeconfig $HOME/.kube/config
+          fi
+
+      - name: Run per-cloud drill
+        env:
+          CLOUD: ${{ matrix.cloud }}
+        run: |
+          set -euo pipefail
+          case "$CLOUD" in
+            aws)
+              if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
+                echo "Running AWS drill via static creds"
+                chmod +x scripts/aws_backup_restore_drill.sh scripts/aws_verify_restore_integrity.sh
+                ./scripts/aws_backup_restore_drill.sh --namespace "${{ secrets.STAGING_NAMESPACE }}" --backup-job "${{ secrets.AWS_BACKUP_CRONJOB }}" --s3-bucket "${{ secrets.AWS_BACKUP_BUCKET }}" || echo "AWS drill failed"
+              else
+                echo "Skipping AWS: no static creds configured; prefer OIDC workflows executed manually"
+              fi
+              ;;
+            azure)
+              if [ -n "${{ secrets.AZURE_CREDENTIALS }}" ]; then
+                echo "Running Azure drill"
+                chmod +x scripts/azure_backup_restore_drill.sh scripts/azure_verify_blob_encryption.sh
+                ./scripts/azure_backup_restore_drill.sh --namespace "${{ secrets.STAGING_NAMESPACE }}" --backup-cronjob "${{ secrets.AZURE_BACKUP_CRONJOB }}" --storage-account "${{ secrets.AZ_STORAGE_ACCOUNT }}" --container "${{ secrets.AZ_BACKUP_CONTAINER }}" || echo "Azure drill failed"
+              else
+                echo "Skipping Azure: no creds"
+              fi
+              ;;
+            oci)
+              if [ -n "${{ secrets.OCI_TENANCY }}" ]; then
+                echo "Running OCI drill"
+                chmod +x scripts/oci_backup_restore_drill.sh scripts/oci_verify_objects.sh
+                ./scripts/oci_backup_restore_drill.sh --namespace "${{ secrets.STAGING_NAMESPACE }}" --cronjob "${{ secrets.OCI_BACKUP_CRONJOB }}" --oci-namespace "${{ secrets.OCI_NAMESPACE }}" --bucket "${{ secrets.OCI_BUCKET }}" --compartment "${{ secrets.OCI_COMPARTMENT }}" || echo "OCI drill failed"
+              else
+                echo "Skipping OCI: no creds"
+              fi
+              ;;
+            alibaba)
+              if [ -n "${{ secrets.ALIYUN_ACCESS_KEY }}" ]; then
+                echo "Running Alibaba drill"
+                chmod +x scripts/alibaba_finalize_and_verify.sh scripts/backup_restore_alibaba.sh
+                ./scripts/alibaba_finalize_and_verify.sh --bucket "${{ secrets.ALIYUN_BACKUP_BUCKET }}" --kms "${{ secrets.ALIYUN_KMS }}" --oidc "${{ secrets.ALIYUN_OIDC }}" --annotation "${{ secrets.ALIYUN_SA_ANNOTATION }}" --role "${{ secrets.ALIYUN_ROLE }}" --namespace "${{ secrets.STAGING_NAMESPACE }}" --ksa "${{ secrets.ALIYUN_KSA }}" --use-vault yes || echo "Alibaba drill failed"
+              else
+                echo "Skipping Alibaba: no creds"
+              fi
+              ;;
+            *)
+              echo "Unsupported cloud: $CLOUD"
+              ;;
+          esac
+
+      - name: Upload artifacts
+        if: always()
+        uses: actions/upload-artifact@v4
+        with:
+          name: staging-drill-${{ matrix.cloud }}-logs
+          path: |
+            /tmp/aegis-*-restore*
+            artifacts || true
+
+# Note: To reduce risk, sensitive operations requiring IAM changes should be gated behind protected environments.
+
*** End Patch
*** Begin Patch
*** Add File: scripts/detect_operator_variant.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# detect_operator_variant.sh
+# Detects common pod-identity operator variants in a cluster and prints variant id:
+# - aad-pod-identity-v1
+# - pod-identity-v2
+# - none
+#
+KUBECTL=${KUBECTL:-kubectl}
+
+if ! command -v "$KUBECTL" >/dev/null 2>&1; then
+  echo "none"
+  exit 0
+fi
+
+if $KUBECTL get crd azureidentities.aadpodidentity.k8s.io >/dev/null 2>&1; then
+  echo "aad-pod-identity-v1"
+  exit 0
+fi
+
+if $KUBECTL get crd azureassignedidentities.aadpodidentity.io >/dev/null 2>&1 || $KUBECTL get crd azureassignedidentities.aadpodidentity.k8s.io >/dev/null 2>&1; then
+  echo "pod-identity-v2"
+  exit 0
+fi
+
+echo "none"
+exit 0
+
*** End Patch
*** Begin Patch
*** Add File: docs/security_actionables_quickstart.md
+Security Actionables — Quickstart
+================================
+
+What this patch enables
+- OIDC-first example for AWS via .github/workflows/aws_oidc_assume_role_example.yml
+- Daily/nightly staging drills per-cloud (if secrets present) via .github/workflows/nightly_staging_drills.yml
+- Gated environment example for dangerous IAM/KMS ops via .github/workflows/dangerous_actions_gate.yml
+- Git-history secret scan helper: scripts/scan_git_history_gitleaks.sh
+- KMS Deny alert helper (creates SNS + EventBridge rule): scripts/create_kms_deny_alert.sh
+- Operator variant detection helper: scripts/detect_operator_variant.sh
+
+Immediate steps to enable
+1. Configure GitHub OIDC roles:
+   - Create an IAM role in your cloud (AWS example) trusting GitHub's OIDC provider and limit to specific repo/ref.
+   - Store the role ARN as secret AWS_OIDC_ROLE_ARN for the example workflow.
+2. Enable repository branch protection:
+   - Require status checks: enable `CI Security Checks (pre-merge)` plus any other tests so PRs cannot be merged until security checks pass.
+3. Install gitleaks locally or in CI and run:
+   ./scripts/scan_git_history_gitleaks.sh
+   Rotate any secrets found immediately.
+4. Create alerts:
+   ./scripts/create_kms_deny_alert.sh --region us-west-2
+
+Notes & follow-ups
+- The OIDC example demonstrates removing static keys in workflows — convert other workflows to the OIDC pattern and remove stored cloud API keys.
+- The nightly drills will only run clouds where secrets are configured; prefer OIDC-run workflows for safer operation when possible.
+- Protect the `dangerous-ops` environment in GitHub (Settings → Environments) and require reviewers for any changes.
+
*** End Patch
