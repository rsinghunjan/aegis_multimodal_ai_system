*** Begin Patch
*** Add File:ops/annotate_serviceaccounts.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Annotate Kubernetes ServiceAccounts with IRSA role ARNs so pods can assume IAM roles.
+# Input: a mapping file (tab-separated) with lines: namespace<TAB>serviceaccount<TAB>role-arn
+#
+# Usage:
+#   ./ops/annotate_serviceaccounts.sh irsa_map.tsv [--kubectl-context CONTEXT]
+#
+MAP_FILE=${1:-}
+KCTX_ARG=""
+if [ "${2:-}" = "--kubectl-context" ]; then
+  KCTX_ARG="--context ${3:-}"
+fi
+
+if [ -z "$MAP_FILE" ] || [ ! -f "$MAP_FILE" ]; then
+  echo "Usage: $0 irsa_map.tsv [--kubectl-context CONTEXT]" >&2
+  echo "Each line of irsa_map.tsv must be: namespace<TAB>serviceaccount<TAB>role-arn" >&2
+  exit 2
+fi
+
+while IFS=$'\t' read -r ns sa role; do
+  if [ -z "$ns" ] || [ -z "$sa" ] || [ -z "$role" ]; then
+    echo "Skipping invalid line: $ns $sa $role"
+    continue
+  fi
+  echo "Annotating SA $ns/$sa with role $role"
+  kubectl $KCTX_ARG -n "$ns" annotate serviceaccount "$sa" "eks.amazonaws.com/role-arn=${role}" --overwrite
+done < "$MAP_FILE"
+
+echo "Done. Verify annotations with: kubectl get sa -n <ns> <sa> -o yaml"
+
*** End Patch
*** Begin Patch
*** Add File:ops/run_build_and_verify.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Trigger the GitHub "Build and Push All Images" workflow and verify cosign signatures + Rekor.
+#
+# Usage:
+#   export GITHUB_REPOSITORY=owner/repo
+#   export GHCR_ORG=ghcr.io/yourorg
+#   ./ops/run_build_and_verify.sh [tag]
+#
+TAG=${1:-latest}
+REPO=${GITHUB_REPOSITORY:-}
+ORG=${GHCR_ORG:-}
+
+if [ -z "$REPO" ] || [ -z "$ORG" ]; then
+  echo "Set GITHUB_REPOSITORY and GHCR_ORG environment variables." >&2
+  exit 2
+fi
+
+echo "Triggering build workflow in $REPO..."
+./ops/trigger_github_workflow_and_wait.sh --repo "$REPO" --workflow build_and_push_all_images.yml --ref main
+
+echo "Verifying cosign signatures and Rekor entries for images with tag $TAG..."
+: "${COSIGN_KMS_ARN:-}" >/dev/null 2>&1 || true
+IMAGES=(aegis-spark aegis-flink aegis-train aegis-serve mcpx-logger aegis-gnn)
+for img in "${IMAGES[@]}"; do
+  full="${ORG}/${img}:${TAG}"
+  echo "Verifying $full"
+  if ! command -v cosign >/dev/null 2>&1; then
+    echo "cosign not installed; install it first." >&2
+    exit 3
+  fi
+  # Using Rekor server if provided via env REKOR_URL
+  if [ -n "${REKOR_URL:-}" ]; then
+    cosign verify --rekor-server "$REKOR_URL" "$full" || { echo "cosign verify failed for $full"; exit 4; }
+  else
+    cosign verify "$full" || { echo "cosign verify failed for $full"; exit 4; }
+  fi
+done
+
+echo "All images verified. Next: apply kustomize overlays to point at these images (use ops/wire_images_into_kustomize.sh)."
+
*** End Patch
*** Begin Patch
*** Add File:ops/apply_kustomize_and_deploy.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Apply kustomize overlay for given environment (wires images must already be patched)
+#
+# Usage:
+#   ./ops/apply_kustomize_and_deploy.sh overlays/staging [--kubectl-context CONTEXT]
+OVERLAY=${1:-}
+KCTX=""
+if [ "${2:-}" = "--kubectl-context" ]; then
+  KCTX="--context ${3:-}"
+fi
+
+if [ -z "$OVERLAY" ] || [ ! -d "$OVERLAY" ]; then
+  echo "Usage: $0 path/to/overlay [--kubectl-context CONTEXT]" >&2
+  exit 2
+fi
+
+echo "Applying kustomize overlay $OVERLAY to namespace aegis"
+kubectl $KCTX apply -k "$OVERLAY"
+echo "Kustomize applied. Check deployments: kubectl -n aegis get pods"
+
*** End Patch
*** Begin Patch
*** Add File:ops/deploy_ha_helm.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Apply tuned HA Helm values for stateful components. Operator must review values files before running.
+#
+# Usage:
+#   ./ops/deploy_ha_helm.sh
+#
+echo "Applying HA Helm charts (Postgres, Milvus, Redis) using values in k8s/ha/production_values.yaml"
+echo "Operator: review values before running. Commands are printed and executed."
+
+echo "Upgrading Postgres (bitnami/postgresql)..."
+helm upgrade --install aegis-postgres bitnami/postgresql -n aegis -f k8s/ha/production_values.yaml || true
+
+echo "Upgrading Milvus (milvus/milvus)..."
+helm upgrade --install aegis-milvus milvus/milvus -n aegis -f k8s/ha/production_values.yaml || true
+
+echo "Upgrading Redis (bitnami/redis)..."
+helm upgrade --install aegis-redis bitnami/redis -n aegis -f k8s/ha/production_values.yaml || true
+
+echo "Helm upgrades started. Monitor rollouts with: kubectl -n aegis rollout status sts/<name> or deployment/<name>"
+
*** End Patch
*** Begin Patch
*** Add File:ops/run_dr_and_review.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Run DR drill and summarize key metrics. Expects scripts/dr/full_dr_drill.sh to exist.
+#
+TF_OUT=${1:-/tmp/aegis_tf_output.json}
+REPORT_OUT=${2:-/tmp/dr_final_report.json}
+
+if [ ! -f "$TF_OUT" ]; then
+  echo "Terraform output json required: $TF_OUT" >&2
+  exit 2
+fi
+
+echo "Running DR drill..."
+./scripts/dr/full_dr_drill.sh "$TF_OUT" backups/postgres/latest.sql.gz /tmp/dr_report.json
+echo "Reading /tmp/dr_report.json"
+cat /tmp/dr_report.json
+cp /tmp/dr_report.json "$REPORT_OUT"
+echo "{\"final_report\":\"$REPORT_OUT\"}" | jq . > "${REPORT_OUT}.meta" || true
+echo "DR run complete. Report: $REPORT_OUT"
+
*** End Patch
*** Begin Patch
*** Add File:ops/deploy_security_hardening.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Deploy security hardening items:
+#  - cert-manager (Helm)
+#  - apply cert-manager ClusterIssuer and KServe TLS ingress
+#  - apply MCPx auth sidecar + network policy
+#  - apply Gatekeeper constraint to require signed annotations
+#  - enable CloudTrail (calls helper)
+#
+echo "Installing cert-manager via Helm (namespace cert-manager)..."
+kubectl create namespace cert-manager || true
+helm repo add jetstack https://charts.jetstack.io || true
+helm repo update
+helm upgrade --install cert-manager jetstack/cert-manager --namespace cert-manager --set installCRDs=true --version v1.12.0 || true
+
+echo "Applying cluster issuer & ingress TLS"
+kubectl apply -f k8s/kserve/cert-manager-clusterissuer.yaml || true
+kubectl apply -f k8s/kserve/ingress_tls.yaml || true
+
+echo "Applying MCPx hardened logger & network policy"
+kubectl apply -f k8s/mcpx/mcpx-hardened-auth-sidecar.yaml || true
+kubectl apply -f k8s/mcpx/mcpx-auth-networkpolicy.yaml || true
+
+echo "Applying Gatekeeper templates & constraints"
+kubectl apply -f k8s/gatekeeper/constraint_template_require_signed_annotation.yaml || true
+kubectl apply -f k8s/gatekeeper/constraint_require_signed_images.yaml || true
+
+echo "Calling CloudTrail enable helper (requires AWS creds)"
+./ops/enable_cloudtrail_and_configure.sh "${EVIDENCE_BUCKET:-aegis-evidence-REPLACE}"
+
+echo "Security hardening applied (some actions require manual IAM policy attach). See ops/tighten_iam_apply_hint.sh for guidance."
+
*** End Patch
*** Begin Patch
*** Add File:ops/run_monitoring_tuning.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Generate monitoring baselines and apply tuned Prometheus rules.
+#
+SAMPLE_S3=${1:-}
+if [ -z "$SAMPLE_S3" ]; then
+  echo "Usage: $0 s3://bucket/path/features.parquet" >&2
+  exit 2
+fi
+
+export EVIDENCE_BUCKET=${EVIDENCE_BUCKET:-}
+if [ -z "$EVIDENCE_BUCKET" ]; then
+  echo "Set EVIDENCE_BUCKET env var to upload baseline artifacts." >&2
+  exit 3
+fi
+
+echo "Running baseline generation and applying tuned Prometheus rules..."
+./ops/apply_baseline_and_prometheus.sh "$SAMPLE_S3" monitoring/tuned_prometheus_rules.yaml
+
+echo "Prometheus rules applied. Validate in Prometheus UI and review ops/monitoring_review_checklist.md"
+
*** End Patch
*** Begin Patch
*** Add File:ops/replace_demo_and_smoke.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# Replace demo/synthetic refs using replace map, then run parallel inference smoke tests.
+#
+REPLACE_MAP=${1:-}
+ENDPOINT=${2:-}
+
+if [ -z "$REPLACE_MAP" ]; then
+  echo "Usage: $0 path/to/replace_map.tsv [inference_endpoint]" >&2
+  exit 2
+fi
+
+echo "Running demo ref scanner and applying replacements (interactive confirmation will be requested)..."
+./ops/replace_demo_refs_confirm.sh "$REPLACE_MAP"
+
+if [ -n "$ENDPOINT" ]; then
+  echo "Running parallel inference smoke test against $ENDPOINT"
+  python3 testing/parallel_inference_runner.py --endpoint "$ENDPOINT" --concurrency 50 --requests 500
+else
+  echo "No inference endpoint provided. Skip smoke test."
+fi
+
*** End Patch
*** Begin Patch
*** Add File:ops/finalize_advanced_tracks_notice.md
+Advanced productionization tracks require project-based work:
+
+- Federated secure aggregation (prototype + security review)
+  - Use Flower + MPC secure aggregation; provision client cert issuance and per-client management.
+  - Integrate per-round logs into EVIDENCE_BUCKET; sign aggregates and create Rekor entries.
+
+- Distributed RL orchestration
+  - Deploy RayCluster (k8s) and RLlib; design gang scheduling and checkpoint policies; integrate safety canaries.
+
+- Large LLM serving
+  - Prepare sharded inference (DeepSpeed Inference / Triton / FasterTransformer)
+  - Design adaptive batching, rate limits, and human-in-the-loop safety reviews.
+
+These require separate project plans and capacity / budget approvals. Use docs/advanced_productionization_roadmap.md as starting point.
+
*** End Patch
*** Begin Patch
*** Add File:README_FINALIZE_PRODUCTION.md
+# Finalize Aegis Production Hardening
+
+This set of scripts automates and orchestrates the remaining actions required to take Aegis from "operational" to "production-ready".
+
+Primary tasks automated:
+- Annotate ServiceAccounts with IRSA roles (ops/annotate_serviceaccounts.sh)
+- Trigger image build & verify cosign + Rekor (ops/run_build_and_verify.sh)
+- Apply kustomize overlays (ops/apply_kustomize_and_deploy.sh)
+- Deploy HA Helm charts (ops/deploy_ha_helm.sh)
+- Run DR drill and collect report (ops/run_dr_and_review.sh)
+- Deploy security hardening (cert-manager, ingress TLS, MCPx auth, Gatekeeper) (ops/deploy_security_hardening.sh)
+- Generate monitoring baselines and apply tuned Prometheus rules (ops/run_monitoring_tuning.sh)
+- Replace demo fallbacks and run parallel inference smoke test (ops/replace_demo_and_smoke.sh)
+
+How to use
+1. Prepare inputs:
+   - Terraform output JSON with resource ARNs and bucket names (/tmp/aegis_tf_output.json)
+   - IRSA mapping file (tsv): namespace<TAB>serviceaccount<TAB>role-arn
+   - Replacement mapping file for demo refs (tsv): pattern<TAB>replacement
+   - Ensure environment variables: GITHUB_REPOSITORY, GHCR_ORG, EVIDENCE_BUCKET, REKOR_URL (optional)
+2. Annotate SAs:
+   ./ops/annotate_serviceaccounts.sh irsa_map.tsv
+3. Trigger CI to build images and verify:
+   ./ops/run_build_and_verify.sh latest
+4. Wire images into overlays and apply:
+   ./ops/wire_images_into_kustomize.sh --registry ghcr.io/yourorg --tag latest --overlay k8s/overlays/staging
+   ./ops/apply_kustomize_and_deploy.sh k8s/overlays/staging
+5. Deploy HA components (review values first):
+   ./ops/deploy_ha_helm.sh
+6. Run DR drill:
+   ./ops/run_dr_and_review.sh /tmp/aegis_tf_output.json /tmp/dr_final_report.json
+7. Apply security hardening:
+   ./ops/deploy_security_hardening.sh
+8. Run monitoring tuning:
+   ./ops/run_monitoring_tuning.sh s3://<EVIDENCE_BUCKET>/monitoring/sample.parquet
+9. Replace demo refs and run smoke:
+   ./ops/replace_demo_and_smoke.sh replace_map.tsv https://kserve.aegis.example.com/v1/models/...:predict
+
+Notes & safety
+- Many steps require operator privileges (AWS IAM, Helm, kubectl) and should be run by a cluster/operator admin.
+- IAM changes and policy attachments must be reviewed and applied separately (see ops/tighten_iam_apply_hint.sh).
+- This automation aims to reduce manual steps; however, human review is required at critical points (IAM, Helm values, image trust).
+
*** End Patch
*** End Patch

