*** Begin Patch
*** Add File: scripts/rag_ingest_milvus.py
+#!/usr/bin/env python3
+"""
+Ingest repository docs into Milvus (or fallback to local Chroma) for production RAG.
+
+Requirements:
+  pip install sentence-transformers pymilvus chromadb numpy
+
+Environment:
+  MILVUS_HOST, MILVUS_PORT, MILVUS_COLLECTION (optional)
+  CHROMA_DIR (optional fallback)
+  EMBED_MODEL (optional, default all-MiniLM-L6-v2)
+
+This is a simple, idempotent ingest script:
+ - reads files under docs/, infra/, k8s/, scripts/, .github/workflows/
+ - chunks text, embeds, and upserts to Milvus collection (or local Chroma)
+"""
+import os
+import json
+from pathlib import Path
+from sentence_transformers import SentenceTransformer
+import numpy as np
+
+MILVUS_HOST = os.getenv("MILVUS_HOST", "")
+MILVUS_PORT = os.getenv("MILVUS_PORT", "19530")
+MILVUS_COLLECTION = os.getenv("MILVUS_COLLECTION", "aegis_docs")
+CHROMA_DIR = os.getenv("CHROMA_DIR", "data/chroma")
+EMBED_MODEL = os.getenv("EMBED_MODEL", "all-MiniLM-L6-v2")
+TARGET_DIRS = ["docs", "infra", "k8s", ".github/workflows", "scripts"]
+CHUNK_SIZE = int(os.getenv("RAG_CHUNK_SIZE", "800"))
+OVERLAP = int(os.getenv("RAG_CHUNK_OVERLAP", "200"))
+
+def text_chunks(text, chunk_size=CHUNK_SIZE, overlap=OVERLAP):
+    start = 0
+    L = len(text)
+    while start < L:
+        end = min(L, start + chunk_size)
+        yield text[start:end]
+        start = max(end - overlap, end)
+
+def collect_docs():
+    docs = []
+    root = Path(".")
+    for d in TARGET_DIRS:
+        p = root / d
+        if not p.exists():
+            continue
+        for fp in p.rglob("*"):
+            if fp.is_file():
+                try:
+                    text = fp.read_text(encoding="utf-8")
+                except Exception:
+                    continue
+                for chunk in text_chunks(text):
+                    docs.append({"source": str(fp), "text": chunk})
+    return docs
+
+def ingest_milvus(docs):
+    from pymilvus import connections, FieldSchema, CollectionSchema, DataType, Collection, utility
+    # connect
+    connections.connect(host=MILVUS_HOST or "127.0.0.1", port=str(MILVUS_PORT))
+    # embed
+    model = SentenceTransformer(EMBED_MODEL)
+    texts = [d["text"] for d in docs]
+    embeddings = model.encode(texts, convert_to_numpy=True)
+    dim = embeddings.shape[1]
+    # create schema if not exists
+    if not utility.has_collection(MILVUS_COLLECTION):
+        fields = [
+            FieldSchema(name="pk", dtype=DataType.INT64, is_primary=True, auto_id=True),
+            FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=dim),
+            FieldSchema(name="source", dtype=DataType.VARCHAR, max_length=2048)
+        ]
+        schema = CollectionSchema(fields, description="Aegis doc vectors")
+        col = Collection(MILVUS_COLLECTION, schema)
+        # index
+        col.create_index(field_name="embedding", index_params={"index_type":"IVF_FLAT","metric_type":"L2","params":{"nlist":128}})
+    else:
+        col = Collection(MILVUS_COLLECTION)
+    # prepare insert
+    sources = [d["source"] for d in docs]
+    col.insert([embeddings.tolist(), sources])
+    col.load()
+    print(f"Inserted {len(docs)} docs to Milvus collection {MILVUS_COLLECTION}")
+
+def ingest_chroma(docs):
+    try:
+        import chromadb
+        from chromadb.config import Settings
+    except Exception:
+        print("Chromadb not installed; skipping fallback.")
+        return
+    client = chromadb.Client(Settings(chroma_db_impl="duckdb+parquet", persist_directory=CHROMA_DIR))
+    collection = client.get_or_create_collection("aegis_docs")
+    model = SentenceTransformer(EMBED_MODEL)
+    texts = [d["text"] for d in docs]
+    embeddings = model.encode(texts).tolist()
+    metadatas = [{"source": d["source"]} for d in docs]
+    ids = [f"doc-{i}" for i in range(len(texts))]
+    collection.add(documents=texts, embeddings=embeddings, metadatas=metadatas, ids=ids)
+    client.persist()
+    print(f"Inserted {len(docs)} docs into local Chroma at {CHROMA_DIR}")
+
+def main():
+    docs = collect_docs()
+    if not docs:
+        print("No docs found; exiting.")
+        return
+    if MILVUS_HOST:
+        ingest_milvus(docs)
+    else:
+        print("MILVUS_HOST not set, using local Chroma fallback.")
+        ingest_chroma(docs)
+
+if __name__ == "__main__":
+    main()
+
*** End Patch
*** Begin Patch
*** Add File: scripts/rag_query_milvus.py
+#!/usr/bin/env python3
+"""
+Query Milvus (or Chroma fallback) for RAG contexts.
+Usage:
+  python scripts/rag_query_milvus.py "your query here"
+"""
+import os
+import sys
+from sentence_transformers import SentenceTransformer
+import numpy as np
+
+MILVUS_HOST = os.getenv("MILVUS_HOST", "")
+MILVUS_PORT = os.getenv("MILVUS_PORT", "19530")
+MILVUS_COLLECTION = os.getenv("MILVUS_COLLECTION", "aegis_docs")
+CHROMA_DIR = os.getenv("CHROMA_DIR", "data/chroma")
+EMBED_MODEL = os.getenv("EMBED_MODEL", "all-MiniLM-L6-v2")
+
+def query_milvus(query, top_k=4):
+    from pymilvus import connections, Collection
+    model = SentenceTransformer(EMBED_MODEL)
+    q_emb = model.encode([query], convert_to_numpy=True)
+    connections.connect(host=MILVUS_HOST or "127.0.0.1", port=str(MILVUS_PORT))
+    col = Collection(MILVUS_COLLECTION)
+    results = col.search(q_emb.tolist(), "embedding", param={"metric_type":"L2", "params": {"nprobe": 10}}, limit=top_k)
+    out = []
+    for res in results[0]:
+        # res.id corresponds to pk; milvus doesn't return source by default in this simple API
+        # Try to return raw serialized data via load/ query (simple approach)
+        out.append({"score": float(res.distance), "id": res.id})
+    return out
+
+def query_chroma(query, top_k=4):
+    try:
+        import chromadb
+        from chromadb.config import Settings
+    except Exception:
+        return []
+    client = chromadb.Client(Settings(chroma_db_impl="duckdb+parquet", persist_directory=CHROMA_DIR))
+    collection = client.get_collection("aegis_docs")
+    res = collection.query(query_texts=[query], n_results=top_k, include=["metadatas", "documents"])
+    out = []
+    for i, doc in enumerate(res["documents"][0]):
+        out.append({"score": 0.0, "source": res["metadatas"][0][i], "text": doc})
+    return out
+
+def main():
+    q = " ".join(sys.argv[1:]) or "readme"
+    if MILVUS_HOST:
+        print(query_milvus(q))
+    else:
+        print(query_chroma(q))
+
+if __name__ == "__main__":
+    main()
+
*** End Patch
*** Begin Patch
*** Add File: .github/workflows/rag_ingest.yml
+name: RAG Ingest (Milvus / Chroma)
+
+on:
+  workflow_dispatch:
+
+jobs:
+  ingest:
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Set up Python
+        uses: actions/setup-python@v4
+        with:
+          python-version: '3.10'
+
+      - name: Install deps
+        run: |
+          python -m pip install --upgrade pip
+          pip install sentence-transformers pymilvus chromadb faiss-cpu numpy
+
+      - name: Run RAG ingest
+        env:
+          MILVUS_HOST: ${{ secrets.MILVUS_HOST }}
+          MILVUS_PORT: ${{ secrets.MILVUS_PORT }}
+          MILVUS_COLLECTION: aegis_docs
+          CHROMA_DIR: data/chroma
+          EMBED_MODEL: all-M
î€€
