  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
```markdown
# Production readiness runbook â€” finalize and validate Aegis

This runbook is the single sequence of steps to turn the codebase into production-ready,
end-to-end validated system. It assumes the repository contains the artifacts and templates
generated by the team (scanner, refactor helpers, enforcement patch, cosign helpers, terraform/helm CI).

Select a provider for staging (AWS / GCP / OCI / Azure) and follow provider-specific steps as needed.

1) Code lock & refactor
 - Run strict scanner:
   python3 scripts/scan_cloud_sdk_usage.py --strict
 - If findings:
   python3 scripts/auto_refactor.py --apply
   Review .refactored.py files, adjust, run tests, open PR and merge.
 - Ensure pre-commit and .github/workflows/premerge-checks.yml run scanner --strict.

2) Provision staging overlay
 - Implement provider-specific overlay in infra/terraform/overlays/<provider>.
 - Run terraform apply (locally or via CI with OIDC) and export outputs to staging.env:
   ./scripts/apply_staging.sh infra/terraform/overlays/<provider>

3) CI OIDC & verifier
 - Create a CI role for GitHub Actions using OIDC (trust policy for token.actions.githubusercontent.com).
 - Grant minimal permissions (object store read for verifier, EKS/GKE ops for helm deploy if required).
 - Add secrets/role ARN to repo and update workflows to use OIDC.

4) Cosign signing & key management
 - Generate cosign key pair offline.
 - Store private key securely (HSM/Vault/secure CI secret); place pubkey into Vault or ExternalSecrets.
 - Run build-and-sign workflow to create signed model archive and upload or attach artifact.

5) Orchestrator verification enforcement
 - Merge enforcement patch or explicitly call fetch_and_prepare_model_for_load at load sites.
 - Ensure audit table/model exists and Alembic migration applied.
 - Run tests (tests/test_orchestrator_verify_enforcement.py).

6) Helm deploy to staging
 - Source staging.env (terraform outputs) and set helm values.
 - helm upgrade --install aegis ./helm -n aegis -f helm/values.<provider>.yaml --set image.tag=<tag>

7) Canary test & monitoring
 - Install Argo Rollouts and Prometheus (if not already).
 - Apply Rollout manifest and Prometheus rules.
 - Run canary load generator (scripts/simulate_canary_load.py) and verify automatic rollback on alerts.

8) Backup & restore drill
 - Trigger cronjob or manual backup job.
 - Verify backup uploaded to bucket; run restore job to staging DB and execute smoke tests.

9) Sign-off & evidence
 - Collect scanner output, terraform apply logs, verifier CI run, cosign artifacts, audit table entries, rollout logs, backup/restore logs.
 - Store evidence in ticket for production sign-off.

If you prefer, I can:
 - Run the scanner & prepare a refactor branch (recommended first).
 - Prepare provider-specific Terraform overlays for a chosen provider.
 - Create PRs for enforcement patch import and CI workflows.

Which action should I take next?
```
docs/production_ready_runbook.md
