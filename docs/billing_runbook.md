  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
# Billing & Tenant Flows â€” Runbook (Aegis)

Overview
- Invoices are generated by `api.billing.aggregate_and_invoice` (periodic Celery task).
- `api.billing_collector.process_outstanding_invoices` attempts automated collection using the configured payment gateway (Stripe by default).
- Webhook endpoint `/v1/billing/webhook` receives provider notifications (success/failure) and reconciles invoice state.

Configuration (env)
- STRIPE_API_KEY: secret, used by billing_gateway
- STRIPE_WEBHOOK_SECRET: webhook signing secret
- BILLING_RETRY_LIMIT / BILLING_RETRY_DELAY_HOURS
- BILLING_UNIT_COST etc (existing)

Security & PCI
- Do NOT store raw card numbers. Use a PCI-compliant provider (Stripe) and only store customer IDs / pm tokens.
- Webhook endpoints must be verified using provider signature keys.
- Access to STRIPE_API_KEY should be via Vault/AppRole in CI and in-cluster as K8s Secret (sealed-secret or Vault Agent recommended).

Tenant lifecycle & enforcement
- Soft enforcement:
  - Send email + webhook notifications on invoice.delivery/payment_failed
  - Apply quota reductions: lower daily quota or throttle (via TenantQuota)
- Hard enforcement:
  - Suspend tenant after N days of unpaid invoices:
    - set tenant.billing_suspended = true (or mark tenant as suspended)
    - enforce in auth/rate limiter (deny new requests)
    - notify operations & tenant
- Recommended policy:
  - 0..3 days: send reminders
  - 3..14 days: throttle to read-only or reduced quota
  - >14 days: suspend API access and block new jobs until payment

Reconciliation & accounting
- Periodically reconcile Stripe ledger vs invoices table (daily) and surface differences in an admin report.
- Keep audit logs of every charge attempt and webhook (api.audit.record_audit).

Testing
- Use Stripe test keys and webhook test signing secrets in staging.
- Run a staging collection job to validate successful payments and failures (card decline test tokens).
- Test failure modes: expired card, insufficient funds, webhook replay.

UI & integration
- Expose invoices in admin UI and let tenants download PDF invoices (render from record).
- Provide endpoints to attach/update billing payment methods via secure payment-provider-hosted UI (Stripe Checkout / Elements).

Next steps to implement (suggested)
- Add tenant suspension flag and wire enforcement into rate limiter / auth.
- Add a small admin UI for invoice listing, payment method management, dispute handling.
- Add reconciliation job to compare provider transactions to invoices.

docs/billing_runbook.mddocs
