apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: experiments.aegis.ai
spec:
  group: aegis.ai
  names:
    kind: Experiment
    plural: experiments
    singular: experiment
    shortNames:
      - exp
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                description:
                  type: string
                strategy:
                  type: string
                  enum: ["smi-split","rollout"]
                variants:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      image:
                        type: string
                      replicas:
                        type: integer
                      servicePort:
                        type: integer
                sampling_key:
                  type: string
                  description: "Field in request used for deterministic bucketing (e.g., user_id)"
                primary_metric:
                  type: object
                  properties:
                    name: { type: string }
+                    type: { type: string, enum: ["ratio","mean","count"] }
+                    numerator: { type: string }
+                    denominator: { type: string }
+                guardrail_metrics:
+                  type: array
+                  items:
+                    type: object
+                duration:
+                  type: string
+                  description: "ISO 8601 duration or human-friendly (e.g., 1h)"
+            status:
+              type: object
+              properties:
+                state:
+                  type: string
+                message:
+                  type: string
      subresources:
        status: {}
