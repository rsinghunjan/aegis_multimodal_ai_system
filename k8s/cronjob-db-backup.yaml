apiVersion: batch/v1
kind: CronJob
metadata:
  name: aegis-db-backup
spec:
  schedule: "0 2 * * *"  # daily at 02:00 UTC
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: amazon/aws-cli:2.16.0  # ensure image has pg client or use a custom image
              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: aegis-secrets
                      key: DATABASE_URL
                - name: BACKUP_S3_BUCKET
                  value: "s3://my-aegis-backups"
                - name: BACKUP_RETENTION_DAYS
                  value: "30"
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -eux
                  # install pg client if missing; in production build a custom image with pg & aws
                  apk add --no-cache postgresql-client gzip curl || true
                  /scripts/pg_backup_to_s3.sh
          volumes:
            - name: scripts
              configMap:
                name: aegis-backup-scripts
