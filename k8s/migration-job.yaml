  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
apiVersion: batch/v1
kind: Job
metadata:
  name: aegis-migrate
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: migrate
          image: __IMAGE_PLACEHOLDER__
          imagePullPolicy: IfNotPresent
          command: [ "sh", "-lc" ]
          args:
            - |
              set -eux
              # Wait for DB to be ready (simple retry)
              until python -c "import sys, time; import psycopg2; time.sleep(0.1); sys.exit(0)"; do sleep 1; done || true
              # Run alembic migrations
              alembic upgrade head
              # Seed dev data
              python scripts/seed_db.py
      # ServiceAccount/Secrets can be mounted here if DB credentials are secret
  backoffLimit: 0
k8s/migration-job.yaml
