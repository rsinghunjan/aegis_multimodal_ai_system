  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: aegis-api
  namespace: default
spec:
  # targetRef references the Deployment that will run your canary pods (created by the controller)
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: aegis-api-canary
  # service port to route to
  service:
    port: 8080
  # traffic routing provider -> nginx ingress provider supported by Flagger
  ingressRef:
    name: aegis-api-ingress
    # optional: host to check
    host: aegis.example.com
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    # rollback window: how long to wait for metrics after a step
    metrics:
      # success rate (2xx over total) - require > 99%
      - name: request-success-rate
        interval: 1m
        threshold: 99
        query: |
          (sum(rate(http_requests_total{job="aegis_api", status=~"2.."}[1m])) / sum(rate(http_requests_total{job="aegis_api"}[1m]))) * 100
      # P95 prediction latency - require < 1000ms
      - name: prediction-p95
        interval: 1m
        threshold: 1000
        # Note: histogram_quantile needs the histogram name; adapt if you use bucket metric aegis_prediction_latency_ms_bucket
        query: |
          histogram_quantile(0.95, sum(rate(aegis_prediction_latency_ms_bucket[5m])) by (le))
    webhooks:
      - name: "on-rollout"
        type: "slack"
        url: "https://hooks.slack.com/services/XXX/YYY/ZZZ"
