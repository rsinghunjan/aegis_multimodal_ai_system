apiVersion: batch/v1
kind: CronJob
metadata:
  name: pg-basebackup
  namespace: ops
spec:
  schedule: "0 4 * * *"   # daily at 04:00
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: wal-g-backup
              image: wal-g/wal-g:latest  # build your own image containing wal-g + pg client, or use a custom image
              env:
                - name: WALG_S3_PREFIX
                  valueFrom:
                    secretKeyRef:
                      name: aegis-backups
                      key: WALG_S3_PREFIX
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: aegis-backups
                      key: AWS_ACCESS_KEY_ID
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: aegis-backups
                      key: AWS_SECRET_ACCESS_KEY
                - name: PGHOST
                  value: "postgres"
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: aegis-secrets
                      key: PGUSER
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: aegis-secrets
                      key: PGPASSWORD
              command:
                - "/bin/sh"
                - "-c"
                - |
                  set -eux
                  wal-g backup-push /var/lib/postgresql/data
          # mount PV if needed for postgres data path; use ServiceAccount with appropriate IAM permissions
