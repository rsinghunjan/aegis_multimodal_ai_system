  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: aegissignedpod
spec:
  crd:
    spec:
      names:
        kind: AegisSignedPod
        listKind: AegisSignedPodList
        plural: aegissignedpods
        singular: aegissignedpod
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package aegissignedpod

        # Violation when:
        #  - resource kind is Pod
        #  - pod is in one of the protected namespaces (parameters.namespaces)
        #  - and pod does NOT have both:
        #     * an initContainer with name matching /verify/; and
        #     * a volume that references secretName == "cosign-public-key"
        violation[{"msg": msg}] {
          input.review.kind.kind == "Pod"
          pod := input.review.object
          ns := pod.metadata.namespace
          params := input.parameters
          namespaces := params.namespaces
          namespaces != null
          ns_in_list(ns, namespaces)
          not has_verify_init_and_cosign_secret(pod)
          msg := sprintf("Aegis: Pod in namespace '%v' must include an initContainer with name containing 'verify' and mount the secret 'cosign-public-key'.", [ns])
        }

        ns_in_list(ns, namespaces) {
          some i
          namespaces[i] == ns
        }

        has_verify_init_and_cosign_secret(pod) {
          # init container name contains "verify"
          some i
          init := pod.spec.initContainers[i]
          regex.match("(?i)verify", init.name)

          # and volume referencing secret 'cosign-public-key' exists
          some j
          vol := pod.spec.volumes[j]
          vol.secret.secretName == "cosign-public-key"
        }
k8s/gatekeeper/constrainttemplate_aegis_signed.yaml
