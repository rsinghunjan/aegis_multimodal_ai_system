  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aegis-inference
spec:
  replicas: 2
  selector:
    matchLabels:
      app: aegis-inference
  template:
    metadata:
      labels:
        app: aegis-inference
      # If using the Vault Agent Injector (vault.hashicorp.com/agent-inject: "true"), annotate appropriately:
      # annotations:
      #   vault.hashicorp.com/agent-inject: "true"
      #   vault.hashicorp.com/role: "aegis-role"
      #   vault.hashicorp.com/agent-inject-secret-oidc_jwks_uri: "secret/data/aegis/oidc#JWKS_URI"
    spec:
      serviceAccountName: aegis-service-account
      containers:
        - name: aegis-inference
          image: <your-registry>/aegis-inference:latest
          ports:
            - containerPort: 9000
          env:
            - name: AUTH_MODE
              value: "oidc" # or "mtls"
            - name: OIDC_JWKS_URI
              valueFrom:
                secretKeyRef:
                  name: aegis-runtime-secrets
                  key: oidc_jwks_uri
            - name: MODEL_SIGNING_PUBKEY
              valueFrom:
                secretKeyRef:
                  name: aegis-runtime-secrets
                  key: model_signing_pubkey
            - name: ENROLLED_CLIENTS_SECRET_PATH
              value: "clients/allowed"
      # Example Vault Agent sidecar pattern: run vault agent that writes secrets to a shared volume
      # (Alternatively use Vault CSI provider or Vault Injector to mount secrets directly)
      # volumes and sidecars omitted here; see runbook for sample Vault Agent config
k8s/vault-agent-deployment.yaml
