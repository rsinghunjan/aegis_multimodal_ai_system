  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
apiVersion: batch/v1
kind: CronJob
metadata:
  name: aegis-postgres-walg-backup
  namespace: default
spec:
  schedule: "0 2 * * *" # daily at 02:00 UTC
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: walg-backup
              image: walgalpine/wal-g:latest # replace with validated image for your environment
              env:
                - name: WALG_S3_PREFIX
                  valueFrom:
                    secretKeyRef:
                      name: aegis-backup-secrets
                      key: WALG_S3_PREFIX
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: aegis-backup-secrets
                      key: AWS_ACCESS_KEY_ID
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: aegis-backup-secrets
                      key: AWS_SECRET_ACCESS_KEY
                - name: PGHOST
                  value: "postgres" # service name for primary in-cluster
                - name: PGPORT
                  value: "5432"
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: aegis-db-credentials
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: aegis-db-credentials
                      key: password
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -euo pipefail
                  echo "Running wal-g backup-push"
                  # ensure PGDATA path or use pg_basebackup if needed - depends on wal-g image
                  wal-g backup-push /var/lib/postgresql/data || (echo "wal-g backup-push failed" && exit 2)
          # If a sidecar is required (e.g., for access to PGDATA), adapt mounts/volumes accordingly
          volumes:
            - name: pgdata
              persistentVolumeClaim:
                claimName: postgres-pvc
