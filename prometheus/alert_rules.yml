
groups:
  - name: aegis-alerts
    rules:
      - alert: AegisSafetySpike
        expr: sum(rate(aegis_safety_flags_total[5m])) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Aegis Safety spike ({{ $value }})"
          description: "Safety flags increased above threshold: sum(rate(aegis_safety_flags_total[5m])) = {{ $value }}. Investigate recent audit events."
          runbook: "docs/runbook_oncall.md#safety-spike"

      - alert: AegisHighInferenceLatencyP95
        expr: histogram_quantile(0.95, sum(rate(aegis_inference_latency_seconds_bucket[5m])) by (le)) > 1.5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High inference P95 latency"
          description: "P95 inference latency above 1.5s. Check model, batching, queue depth and pod resource usage."
          runbook: "docs/runbook_oncall.md#high-inference-latency"

      - alert: AegisModelNotLoaded
        expr: sum(aegis_model_loaded{job="aegis-inference"}) == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Model not loaded on inference service"
          description: "Model not loaded across pods. Check registry, signatures and startup logs."
          runbook: "docs/runbook_oncall.md#model-not-loaded"

      - alert: AegisAuditWriteFailures
        expr: increase(aegis_audit_write_errors_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Audit backend write failures"
          description: "Audit backend experienced write errors. Investigate audit backend (S3, DB or filesystem), permissions, and disk space."
          runbook: "docs/runbook_oncall.md#audit-backend-failures"

      - alert: AegisAuthFailureSpike
        expr: increase(aegis_auth_failures_total[5m]) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Spike in authentication failures"
          description: "Many auth failures detected; could be misconfiguration or attack. Check ingress/mTLS and OIDC issuer."
          runbook: "docs/runbook_oncall.md#auth-failures"
prometheus/alert_rules.yml
