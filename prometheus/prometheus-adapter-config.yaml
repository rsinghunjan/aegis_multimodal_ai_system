  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-adapter-config
  namespace: monitoring
data:
  config.yaml: |
    rules:
      # Map P95 prediction latency histogram to an external metric usable by HPA
      - seriesQuery: 'aegis_prediction_latency_ms_bucket{job=~".*"}'
        resources:
          overrides: {}
        name:
          matches: "^(.*)_bucket$"
          as: "aegis_prediction_latency_ms"
        metricsQuery: |
          histogram_quantile(0.95, sum(rate(aegis_prediction_latency_ms_bucket{job!="",instance!=""}[5m])) by (le, model, version))
      # Map predictions per second per model to an external metric
      - seriesQuery: 'aegis_predictions_total{job=~".*"}'
        resources:
          overrides: {}
        name:
          as: "aegis_predictions_per_second"
        metricsQuery: |
          sum(rate(aegis_predictions_total{job!="",instance!=""}[1m])) by (model, version)
      # Map error rate (5xx / total) as percentage metric
      - seriesQuery: 'http_requests_total{job=~".*"}'
        resources: {}
        name:
          as: "aegis_error_rate_percent"
        metricsQuery: >
          (
            sum(rate(http_requests_total{job!="",status=~"5.."}[5m])) by (job) /
            sum(rate(http_requests_total{job!="",status!=""}[5m])) by (job)
          ) * 100
