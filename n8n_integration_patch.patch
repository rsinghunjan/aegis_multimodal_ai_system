*** Begin Patch
*** Add File:infra/n8n/README.md
+# n8n Integration for Aegis
+
+This directory contains manifests, Helm values and helper CI to deploy a self-hosted n8n instance into the Aegis cluster.
+
+Important:
+- Secrets are not included. Use ExternalSecrets/SecretsManager to populate runtime credentials.
+- This integration assumes an internal-only n8n UI protected by SSO or Ingress auth (recommended).
+- Review NetworkPolicy and RBAC before applying in production.
+
+Contents:
+- values.yaml: example Helm values for n8n (chart: n8n/n8n or bitnami/n8n if preferred)
+- postgres-values.yaml: example values for Postgres if using chart-backed DB (optional; you may use managed DB)
+- externalsecret.yaml: ExternalSecret mapping placeholders (populate SECRET_PREFIX)
+- ingress.yaml: Ingress example with cert-manager TLS annotations (replace EXTERNAL_URL)
+- networkpolicy.yaml: default deny egress/ingress constraints for n8n namespace
+- serviceaccount.yaml: ServiceAccount and minimal RBAC
+- gatekeeper/constraint_require_signed_n8n.yaml: Gatekeeper ConstraintTemplate to require model_card-like annotation (example)
+- workflows/sample_workflow.json: sample n8n workflow to seed
+- .github/workflows/seed_n8n_workflows.yml: GitHub Action to import workflows into n8n via API
+- runbook: operator steps for deploying and securing n8n
+
+Read the runbook before applying.
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/values.yaml
+# Example Helm values for n8n chart (adapt for chart you use)
+# This file uses placeholders for secrets that will be provided via ExternalSecrets or Kubernetes Secrets.
+replicaCount: 2
+
+image:
+  repository: n8nio/n8n
+  tag: "0.236.0" # replace with tested tag
+  pullPolicy: IfNotPresent
+
+env:
+  - name: DB_TYPE
+    value: postgres
+  - name: DB_POSTGRESDB_HOST
+    value: "REPLACE_POSTGRES_HOST"
+  - name: DB_POSTGRESDB_PORT
+    value: "5432"
+  - name: DB_POSTGRESDB_DATABASE
+    value: "n8n"
+  - name: DB_POSTGRESDB_USER
+    valueFrom:
+      secretKeyRef:
+        name: n8n-secrets
+        key: POSTGRES_USER
+  - name: DB_POSTGRESDB_PASSWORD
+    valueFrom:
+      secretKeyRef:
+        name: n8n-secrets
+        key: POSTGRES_PASSWORD
+  - name: N8N_BASIC_AUTH_ACTIVE
+    value: "true"
+  - name: N8N_BASIC_AUTH_USER
+    valueFrom:
+      secretKeyRef:
+        name: n8n-secrets
+        key: N8N_BASIC_AUTH_USER
+  - name: N8N_BASIC_AUTH_PASSWORD
+    valueFrom:
+      secretKeyRef:
+        name: n8n-secrets
+        key: N8N_BASIC_AUTH_PASSWORD
+  - name: N8N_ENCRYPTION_KEY
+    valueFrom:
+      secretKeyRef:
+        name: n8n-secrets
+        key: N8N_ENCRYPTION_KEY
+
+service:
+  type: ClusterIP
+  port: 5678
+
+ingress:
+  enabled: true
+  hosts:
+    - host: "REPLACE_N8N_HOST" # e.g., n8n.staging.example.com
+      paths:
+        - path: /
+  tls:
+    - hosts:
+        - "REPLACE_N8N_HOST"
+      secretName: n8n-tls
+
+persistence:
+  enabled: false
+  # If chart-managed DB is used, configure storage class and size in postgres-values.yaml
+
+resources:
+  requests:
+    cpu: "250m"
+    memory: "512Mi"
+  limits:
+    cpu: "1000m"
+    memory: "1Gi"
+
+securityContext:
+  runAsNonRoot: true
+  runAsUser: 1000
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/postgres-values.yaml
+# Optional: example values if you want to deploy Postgres with Helm (bitnami/postgresql)
+global:
+  postgresql:
+    postgresqlUsername: "REPLACE_POSTGRES_USER"
+    postgresqlPassword: "REPLACE_POSTGRES_PASSWORD"
+    postgresqlDatabase: "n8n"
+
+persistence:
+  enabled: true
+  size: 10Gi
+  storageClass: "gp2" # replace with your storage class
+
+resources:
+  requests:
+    cpu: "250m"
+    memory: "512Mi"
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/externalsecret.yaml
+apiVersion: external-secrets.io/v1beta1
+kind: ExternalSecret
+metadata:
+  name: n8n-secrets
+  namespace: n8n
+spec:
+  refreshInterval: "1h"
+  secretStoreRef:
+    name: aws-secrets-manager
+    kind: SecretStore
+  target:
+    name: n8n-secrets
+    creationPolicy: Owner
+  data:
+    - secretKey: POSTGRES_USER
+      remoteRef:
+        key: "REPLACE_SECRET_PREFIX/n8n/postgres/username"
+    - secretKey: POSTGRES_PASSWORD
+      remoteRef:
+        key: "REPLACE_SECRET_PREFIX/n8n/postgres/password"
+    - secretKey: N8N_BASIC_AUTH_USER
+      remoteRef:
+        key: "REPLACE_SECRET_PREFIX/n8n/basic/user"
+    - secretKey: N8N_BASIC_AUTH_PASSWORD
+      remoteRef:
+        key: "REPLACE_SECRET_PREFIX/n8n/basic/password"
+    - secretKey: N8N_ENCRYPTION_KEY
+      remoteRef:
+        key: "REPLACE_SECRET_PREFIX/n8n/encryption_key"
+
+# Operators: populate Secrets Manager keys under REPLACE_SECRET_PREFIX/n8n/* before applying
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/serviceaccount.yaml
+apiVersion: v1
+kind: Namespace
+metadata:
+  name: n8n
+---
+apiVersion: v1
+kind: ServiceAccount
+metadata:
+  name: n8n
+  namespace: n8n
+---
+apiVersion: rbac.authorization.k8s.io/v1
+kind: Role
+metadata:
+  name: n8n-role
+  namespace: n8n
+rules:
+  - apiGroups: [""]
+    resources: ["secrets"]
+    verbs: ["get"]
+---
+apiVersion: rbac.authorization.k8s.io/v1
+kind: RoleBinding
+metadata:
+  name: n8n-rolebinding
+  namespace: n8n
+subjects:
+  - kind: ServiceAccount
+    name: n8n
+    namespace: n8n
+roleRef:
+  kind: Role
+  name: n8n-role
+  apiGroup: rbac.authorization.k8s.io
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/ingress.yaml
+apiVersion: networking.k8s.io/v1
+kind: Ingress
+metadata:
+  name: n8n-ingress
+  namespace: n8n
+  annotations:
+    kubernetes.io/ingress.class: "nginx"
+    cert-manager.io/cluster-issuer: "letsencrypt-prod" # change to your issuer
+    nginx.ingress.kubernetes.io/auth-type: "basic"
+    nginx.ingress.kubernetes.io/auth-secret: "n8n-basic-auth"
+    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
+spec:
+  tls:
+    - hosts:
+        - "REPLACE_N8N_HOST"
+      secretName: n8n-tls
+  rules:
+    - host: "REPLACE_N8N_HOST"
+      http:
+        paths:
+          - path: /
+            pathType: Prefix
+            backend:
+              service:
+                name: n8n
+                port:
+                  number: 5678
+
+# Note: create the nginx basic-auth secret from ExternalSecrets output or create a Kubernetes Secret
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/networkpolicy.yaml
+apiVersion: networking.k8s.io/v1
+kind: NetworkPolicy
+metadata:
+  name: n8n-default-egress
+  namespace: n8n
+spec:
+  podSelector: {}
+  policyTypes:
+    - Egress
+    - Ingress
+  ingress:
+    - from:
+        - podSelector:
+            matchLabels:
+              app: ingress-nginx
+      ports:
+        - protocol: TCP
+          port: 5678
+  egress:
+    - to:
+        - ipBlock:
+            cidr: 10.0.0.0/8
+      ports:
+        - protocol: TCP
+          port: 443
+    - to:
+        - podSelector:
+            matchLabels:
+              app: postgres
+      ports:
+        - protocol: TCP
+          port: 5432
+
+# Adjust ipBlock and allowed destinations per your environment (e.g., S3 endpoints, MLflow).
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/gatekeeper/constraint_require_signed_n8n.yaml
+apiVersion: templates.gatekeeper.sh/v1beta1
+kind: ConstraintTemplate
+metadata:
+  name: require-n8n-signature
+spec:
+  crd:
+    spec:
+      names:
+        kind: RequireN8nSignature
+  targets:
+    - target: admission.k8s.gatekeeper.sh
+      rego: |
+        package require_n8n_signature
+        violation[{"msg": msg}] {
+          input.review.object.kind == "Deployment"
+          input.review.object.metadata.namespace == "n8n"
+          not input.review.object.metadata.annotations["aegis.cosign.signed"]
+          msg := "n8n Deployments must include 'aegis.cosign.signed' annotation linking to cosign signature"
+        }
+
+---
+# Constraint instance: enforce in n8n namespace
+apiVersion: constraints.gatekeeper.sh/v1beta1
+kind: RequireN8nSignature
+metadata:
+  name: require-signed-n8n
+spec:
+  match:
+    namespaces: ["n8n"]
+
*** End Patch
*** Begin Patch
*** Add File:infra/n8n/workflows/sample_workflow.json
+{
+  "name": "Aegis - Example: On S3 object -> Ingest -> Notify",
+  "nodes": [
+    {
+      "id": "1",
+      "name": "S3 Trigger",
+      "type": "n8n-nodes-base.s3",
+      "parameters": {
+        "operation": "getObject",
+        "bucketName": "REPLACE_EVIDENCE_BUCKET",
+        "key": "ingest/incoming/"
+      }
+    },
+    {
+      "id": "2",
+      "name": "Ingest API",
+      "type": "n8n-nodes-base.httpRequest",
+      "parameters": {
+        "requestMethod": "POST",
+        "url": "http://ingest-service.aegis.svc.cluster.local/ingest",
+        "jsonParameters": true,
+        "options": {}
+      }
+    },
+    {
+      "id": "3",
+      "name": "Slack Notify",
+      "type": "n8n-nodes-base.slack",
+      "parameters": {
+        "operation": "sendMessage",
+        "channel": "#aegis-notify",
+        "text": "New artifact ingested by Aegis"
+      }
+    }
+  ],
+  "connections": {
+    "1": {
+      "main": [
+        [
+          {
+            "node": "2",
+            "type": "main",
+            "index": 0
+          }
+        ]
+      ]
+    },
+    "2": {
+      "main": [
+        [
+          {
+            "node": "3",
+            "type": "main",
+            "index": 0
+          }
+        ]
+      ]
+    }
+  }
+}
+
*** End Patch
*** Begin Patch
*** Add File:.github/workflows/seed_n8n_workflows.yml
+name: Seed n8n Workflows
+
+on:
+  push:
+    paths:
+      - 'infra/n8n/workflows/**'
+  workflow_dispatch:
+
+jobs:
+  seed:
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - name: Upload workflows to n8n
+        env:
+          N8N_API_URL: ${{ secrets.N8N_API_URL }}
+          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
+        run: |
+          set -euo pipefail
+          WORKFLOW=infra/n8n/workflows/sample_workflow.json
+          if [ -f "$WORKFLOW" ]; then
+            echo "Importing $WORKFLOW to $N8N_API_URL"
+            curl -sS -X POST "${N8N_API_URL}/workflows?overwrite=true" \
+              -H "Content-Type: application/json" \
+              -H "Authorization: Bearer ${N8N_API_KEY}" \
+              --data-binary @"$WORKFLOW" || (echo "Import failed" && exit 1)
+          else
+            echo "No workflows to seed"
+          fi
+
*** End Patch
*** Begin Patch
*** Add File:runbooks/n8n_runbook.md
+# n8n Operator Runbook (Aegis)
+
+Purpose: How to deploy and secure n8n in the Aegis cluster.
+
+Prereqs:
+- ExternalSecrets configured with SECRET_PREFIX values for n8n.
+- cert-manager installed (for TLS).  
+- A Postgres instance available (managed or Helm chart).
+
+1) Populate secrets in SecretsManager under REPLACE_SECRET_PREFIX/n8n/*:
+   - postgres/username
+   - postgres/password
+   - basic/user
+   - basic/password
+   - encryption_key
+
+2) Install Postgres (if you choose chart-managed):
+   helm repo add bitnami https://charts.bitnami.com/bitnami
+   helm upgrade --install n8n-postgres bitnami/postgresql -n n8n -f infra/n8n/postgres-values.yaml
+
+3) Apply ExternalSecret to create Kubernetes secret:
+   kubectl apply -f infra/n8n/externalsecret.yaml
+
+4) Install n8n via Helm (example):
+   helm repo add n8n https://n8n-io.github.io/n8n/
+   helm repo update
+   helm upgrade --install n8n n8n/n8n -n n8n -f infra/n8n/values.yaml
+
+5) Create Ingress TLS and basic-auth secret:
+   # basic auth secret can be created from ExternalSecrets or htpasswd tool
+   kubectl create secret generic n8n-basic-auth --from-literal=auth="REPLACE_HTPASSWD" -n n8n
+   # cert-manager will provision n8n-tls via cluster-issuer (ensure issuer exists)
+
+6) Apply NetworkPolicy and RBAC:
+   kubectl apply -f infra/n8n/serviceaccount.yaml
+   kubectl apply -f infra/n8n/networkpolicy.yaml
+
+7) Gatekeeper: enforce signed deployment
+   kubectl apply -f infra/n8n/gatekeeper/constraint_require_signed_n8n.yaml
+
+8) Seed workflows via GitHub Action
+   - Add repo secrets: N8N_API_URL (e.g., https://n8n.staging.example.com/rest) and N8N_API_KEY (admin key)
+   - Trigger the workflow or push infra/n8n/workflows
+
+9) Secure the UI:
+   - Restrict ingress to internal CIDR or enable OIDC SSO.
+   - Audit n8n logs and ensure flows do not exfiltrate secrets.
+
+Monitoring & audit:
+- Scrape n8n metrics (if enabled) and push flow run logs to S3 for evidence.
+- Seed flows should log to Aegis audit prefixes for traceability.
+
+Rollback:
+- To rollback to previous flows, revert commit that updated infra/n8n/workflows and re-run seeding action.
+
*** End Patch
*** End Patch
