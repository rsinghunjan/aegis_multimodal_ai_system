*** Begin Patch
*** Add File: scripts/azure_full_finalize_and_verify.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# azure_full_finalize_and_verify.sh
+# Top-level orchestrator to implement Azure support steps:
+#  - detect pod-identity variant
+#  - create or reuse UAMI and apply AzureIdentity/AzureAssignedIdentity CRs
+#  - grant Key Vault key permissions to the UAMI principal
+#  - configure Storage Account to use Key Vault CMK and grant storage identity access
+#  - run staging backup->restore drill
+#  - verify blob encryption metadata and download artifacts
+#  - optionally rotate Key Vault key (KMS rotation test)
+#  - collect verification artifacts
+#
+# Usage:
+#   ./scripts/azure_full_finalize_and_verify.sh \
+#     --uami-name uami-milvus \
+#     --rg my-rg \
+#     --sub my-sub \
+#     --namespace aegis \
+#     --ksa milvus-backup-sa \
+#     --vault my-keyvault \
+#     --key my-key \
+#     --storage-account mystorageacct \
+#     --container milvus-backups \
+#     [--run-rotation yes|no] [--dry-run]
+#
+PROGNAME=$(basename "$0")
+usage() {
+  cat <<EOF
+Usage: $PROGNAME --uami-name NAME --rg RG --sub SUB --namespace NS --ksa KSA --vault VAULT --key KEY --storage-account ACCT --container CONTAINER [--run-rotation yes|no] [--dry-run]
+EOF
+}
+
+UAMI_NAME=""
+RG=""
+SUB=""
+NAMESPACE="aegis"
+KSA="milvus-backup-sa"
+VAULT=""
+KEY=""
+STORAGE_ACCOUNT=""
+CONTAINER=""
+RUN_ROTATION="no"
+DRY_RUN="false"
+
+while [ $# -gt 0 ]; do
+  case "$1" in
+    --uami-name) UAMI_NAME="$2"; shift 2;;
+    --rg) RG="$2"; shift 2;;
+    --sub) SUB="$2"; shift 2;;
+    --namespace) NAMESPACE="$2"; shift 2;;
+    --ksa) KSA="$2"; shift 2;;
+    --vault) VAULT="$2"; shift 2;;
+    --key) KEY="$2"; shift 2;;
+    --storage-account) STORAGE_ACCOUNT="$2"; shift 2;;
+    --container) CONTAINER="$2"; shift 2;;
+    --run-rotation) RUN_ROTATION="$2"; shift 2;;
+    --dry-run) DRY_RUN="true"; shift;;
+    -h|--help) usage; exit 0;;
+    *) echo "Unknown arg: $1"; usage; exit 2;;
+  esac
+done
+
+if [ -z "$UAMI_NAME" ] || [ -z "$RG" ] || [ -z "$SUB" ] || [ -z "$VAULT" ] || [ -z "$KEY" ] || [ -z "$STORAGE_ACCOUNT" ] || [ -z "$CONTAINER" ]; then
+  echo "Missing required args"
+  usage
+  exit 2
+fi
+
+run_or_echo() {
+  if [ "$DRY_RUN" = "true" ]; then
+    echo "[DRY-RUN] $*"
+  else
+    echo "[RUN] $*"
+    eval "$@"
+  fi
+}
+
+set -x
+
+echo "STEP 0: Detect pod-identity variant"
+if [ ! -x scripts/detect_pod_identity_variant.sh ]; then
+  echo "Required script scripts/detect_pod_identity_variant.sh missing"
+  exit 1
+fi
+VARIANT=$(./scripts/detect_pod_identity_variant.sh)
+echo "Detected pod-identity variant: $VARIANT"
+
+echo "STEP 1: Create or ensure UAMI and apply pod identity CRs"
+if [ ! -x scripts/create_uami_and_bind_to_sa.sh ]; then
+  echo "Required script scripts/create_uami_and_bind_to_sa.sh missing"
+  exit 1
+fi
+run_or_echo "./scripts/create_uami_and_bind_to_sa.sh --name ${UAMI_NAME} --resource-group ${RG} --subscription ${SUB} --namespace ${NAMESPACE} --ksa ${KSA} --mode apply --variant ${VARIANT}"
+
+echo "STEP 2: Extract UAMI principalId"
+PRINCIPAL_ID=$(az identity show --name "$UAMI_NAME" --resource-group "$RG" --subscription "$SUB" --query principalId -o tsv)
+echo "UAMI principalId: $PRINCIPAL_ID"
+
+echo "STEP 3: Grant Key Vault key permissions and configure storage account to use the CMK"
+if [ ! -x scripts/configure_keyvault_and_storage_cmk.sh ]; then
+  echo "Required script scripts/configure_keyvault_and_storage_cmk.sh missing"
+  exit 1
+fi
+run_or_echo "./scripts/configure_keyvault_and_storage_cmk.sh --vault \"$VAULT\" --key-name \"$KEY\" --principal-id \"$PRINCIPAL_ID\" --storage-account \"$STORAGE_ACCOUNT\" --resource-group \"$RG\""
+
+echo "STEP 4: Run staging backup->restore drill"
+if [ ! -x scripts/azure_backup_restore_drill.sh ]; then
+  echo "Required script scripts/azure_backup_restore_drill.sh missing"
+  exit 1
+fi
+run_or_echo "./scripts/azure_backup_restore_drill.sh --namespace \"$NAMESPACE\" --backup-cronjob \"${AZURE_BACKUP_CRONJOB:-aegis-milvus-backup}\" --storage-account \"$STORAGE_ACCOUNT\" --container \"$CONTAINER\""
+
+echo "STEP 5: Verify blob encryption metadata and download sample artifacts"
+if [ ! -x scripts/azure_verify_blob_encryption.sh ]; then
+  echo "Required script scripts/azure_verify_blob_encryption.sh missing"
+  exit 1
+fi
+run_or_echo "./scripts/azure_verify_blob_encryption.sh --storage-account \"$STORAGE_ACCOUNT\" --resource-group \"$RG\" --container \"$CONTAINER\""
+
+echo "STEP 6: Collect verification artifacts (kubectl logs, events, pod descriptions)"
+if [ -x scripts/collect_verification_artifacts.sh ]; then
+  run_or_echo "./scripts/collect_verification_artifacts.sh --namespace \"$NAMESPACE\" --ksa \"$KSA\" --bucket \"$CONTAINER\" --out /tmp/aegis-azure-verify-$(date -u +%Y%m%dT%H%M%SZ)"
+else
+  echo "scripts/collect_verification_artifacts.sh not found; skip artifact collection"
+fi
+
+if [ "$RUN_ROTATION" = "yes" ]; then
+  echo "STEP 7: Rotate Key Vault key (KMS rotation test)"
+  if [ ! -x scripts/kms_rotate_azure_key.sh ]; then
+    echo "Required script scripts/kms_rotate_azure_key.sh missing"
+    exit 1
+  fi
+  NEW_KEY_NAME="${KEY}-rotated-$(date -u +%Y%m%dT%H%M%SZ)"
+  run_or_echo "./scripts/kms_rotate_azure_key.sh --vault \"$VAULT\" --key-name \"$NEW_KEY_NAME\" --uami-principal-id \"$PRINCIPAL_ID\" --resource-group \"$RG\""
+  echo "After rotation, update Milvus helm values to point to the new key and run one backup to confirm encryption under the new key."
+fi
+
+echo "AZURE orchestration complete. Inspect artifacts and run the Milvus restore in staging using downloaded artifacts for application-level verification."
+
*** End Patch
*** Add File: scripts/kms_rotate_azure_key.sh
+#!/usr/bin/env bash
+set -euo pipefail
+#
+# kms_rotate_azure_key.sh
+# Create a new Key Vault key and assign required permissions to the backup principal (UAMI).
+#
+# Usage:
+#   ./scripts/kms_rotate_azure_key.sh --vault my-keyvault --key-name my-new-key --uami-principal-id <principal-id> --resource-group RG
+#
+VAULT=""
+KEY_NAME=""
+UAMI_PRINCIPAL_ID=""
+RESOURCE_GROUP=""
+
+while [ $# -gt 0 ]; do
+  case "$1" in
+    --vault) VAULT="$2"; shift 2;;
+    --key-name) KEY_NAME="$2"; shift 2;;
+    --uami-principal-id) UAMI_PRINCIPAL_ID="$2"; shift 2;;
+    --resource-group) RESOURCE_GROUP="$2"; shift 2;;
+    -h|--help) echo "Usage: $0 --vault VAULT --key-name NAME --uami-principal-id PID --resource-group RG"; exit 0;;
+    *) echo "Unknown arg: $1"; exit 2;;
+  esac
+done
+
+if [ -z "$VAULT" ] || [ -z "$KEY_NAME" ] || [ -z "$UAMI_PRINCIPAL_ID" ]; then
+  echo "Missing args"
+  exit 2
+fi
+
+echo "Creating new key $KEY_NAME in vault $VAULT"
+az keyvault key create --vault-name "$VAULT" --name "$KEY_NAME" --ops encrypt decrypt wrapKey unwrapKey sign verify --kty RSA --size 2048 -o json
+
+echo "Granting wrapKey/unwrapKey/get to principal $UAMI_PRINCIPAL_ID"
+az keyvault set-policy --name "$VAULT" --object-id "$UAMI_PRINCIPAL_ID" --key-permissions wrapKey unwrapKey get || true
+
+NEW_KEY_URI=$(az keyvault key show --vault-name "$VAULT" --name "$KEY_NAME" --query key.kid -o tsv)
+echo "New key created: $NEW_KEY_URI"
+echo "Return value: $NEW_KEY_URI"
+
*** End Patch
*** Add File: scripts/update_milvus_azure_values.py
+#!/usr/bin/env python3
+"""
+update_milvus_azure_values.py
+
+Update infra/overrides/azure/milvus-values-aks.yaml with provided storage account, container and Key Vault key (values used by the Helm chart).
+"""
+import argparse, os, yaml
+
+VALUES_FILE = "infra/overrides/azure/milvus-values-aks.yaml"
+
+def main():
+    p = argparse.ArgumentParser()
+    p.add_argument("--storage-account", required=True)
+    p.add_argument("--container", required=True)
+    p.add_argument("--region", required=False, default="")
+    p.add_argument("--keyvault-name", required=True)
+    p.add_argument("--key-name", required=True)
+    p.add_argument("--service-account", default="milvus-backup-sa")
+    p.add_argument("--out", default=VALUES_FILE)
+    args = p.parse_args()
+
+    vals = {}
+    if os.path.exists(args.out):
+        with open(args.out) as fh:
+            vals = yaml.safe_load(fh) or {}
+
+    vals.setdefault("backup", {})
+    vals["backup"]["enabled"] = True
+    vals["backup"].setdefault("azure", {})
+    vals["backup"]["azure"]["storageAccount"] = args.storage_account
+    vals["backup"]["azure"]["container"] = args.container
+    vals["backup"].setdefault("backup", {})
+    vals.setdefault("backup", {}).setdefault("encryption", {}).setdefault("keyVault", {})
+    vals["backup"]["encryption"]["keyVault"]["vaultName"] = args.keyvault_name
+    vals["backup"]["encryption"]["keyVault"]["keyName"] = args.key_name
+    vals.setdefault("serviceAccount", {})
+    vals["serviceAccount"]["create"] = False
+    vals["serviceAccount"]["name"] = args.service_account
+
+    with open(args.out, "w") as fh:
+        yaml.safe_dump(vals, fh, default_flow_style=False)
+    print("Updated", args.out)
+
+if __name__ == "__main__":
+    main()
+
*** End Patch
*** Add File: .github/workflows/azure_full_finalize_and_verify.yml
+name: Azure Full Finalize & Verify
+
+on:
+  workflow_dispatch:
+    inputs:
+      run_rotation:
+        description: "Run KMS rotation test after drill"
+        required: false
+        default: "false"
+
+permissions:
+  contents: read
+
+jobs:
+  azure-full-finalize:
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Configure Azure CLI
+        uses: azure/login@v1
+        with:
+          creds: ${{ secrets.AZURE_CREDENTIALS }}
+
+      - name: Setup kubeconfig (if provided)
+        run: |
+          if [ -n "${{ secrets.KUBE_CONFIG_DATA }}" ]; then
+            echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > /tmp/kubeconfig
+            mkdir -p $HOME/.kube
+            mv /tmp/kubeconfig $HOME/.kube/config
+          fi
+
+      - name: Run Azure finalize & verify
+        env:
+          AZ_UAMI_NAME: ${{ secrets.AZ_UAMI_NAME }}
+          AZ_RESOURCE_GROUP: ${{ secrets.AZ_RESOURCE_GROUP }}
+          AZ_SUBSCRIPTION: ${{ secrets.AZ_SUBSCRIPTION }}
+          STAGING_NAMESPACE: ${{ secrets.STAGING_NAMESPACE }}
+          AZ_BACKUP_KSA: ${{ secrets.AZ_BACKUP_KSA }}
+          AZ_KEYVAULT: ${{ secrets.AZ_KEYVAULT }}
+          AZ_KEY_NAME: ${{ secrets.AZ_KEY_NAME }}
+          AZ_STORAGE_ACCOUNT: ${{ secrets.AZ_STORAGE_ACCOUNT }}
+          AZ_BACKUP_CONTAINER: ${{ secrets.AZ_BACKUP_CONTAINER }}
+        run: |
+          chmod +x scripts/azure_full_finalize_and_verify.sh \
+                   scripts/create_uami_and_bind_to_sa.sh \
+                   scripts/configure_keyvault_and_storage_cmk.sh \
+                   scripts/azure_backup_restore_drill.sh \
+                   scripts/azure_verify_blob_encryption.sh \
+                   scripts/kms_rotate_azure_key.sh \
+                   scripts/collect_verification_artifacts.sh
+          ./scripts/azure_full_finalize_and_verify.sh \
+            --uami-name "${AZ_UAMI_NAME}" \
+            --rg "${AZ_RESOURCE_GROUP}" \
+            --sub "${AZ_SUBSCRIPTION}" \
+            --namespace "${STAGING_NAMESPACE}" \
+            --ksa "${AZ_BACKUP_KSA}" \
+            --vault "${AZ_KEYVAULT}" \
+            --key "${AZ_KEY_NAME}" \
+            --storage-account "${AZ_STORAGE_ACCOUNT}" \
+            --container "${AZ_BACKUP_CONTAINER}" \
+            --run-rotation "${{ github.event.inputs.run_rotation }}"
+
*** End Patch
*** Add File: docs/azure_finish_quickstart.md
+Azure â€” Implementation & Testing Quickstart
+==========================================
+
+Goal
+----
+Bring Azure to "fully supported" status by:
+- Ensuring pod-identity binding works (v1 or v2)
+- Granting Key Vault key permissions (wrapKey/unwrapKey/get) to the backup identity
+- Configuring Storage Account to use Key Vault CMK and granting storage identity access
+- Running a staging backup->restore drill, verifying blob encryption metadata, and performing a KMS rotation test
+
+Prereqs
+-------
+- Azure CLI authenticated with permissions to create user-assigned managed identities and modify Key Vault and Storage Account policies.
+- kubectl access to staging cluster and ability to apply CRs.
+- Repo contains helper scripts (this patch adds an orchestrator and helper scripts).
+- GitHub Actions secrets if running in CI:
+  AZURE_CREDENTIALS, KUBE_CONFIG_DATA, AZ_UAMI_NAME, AZ_RESOURCE_GROUP, AZ_SUBSCRIPTION, STAGING_NAMESPACE, AZ_BACKUP_KSA, AZ_KEYVAULT, AZ_KEY_NAME, AZ_STORAGE_ACCOUNT, AZ_BACKUP_CONTAINER
+
+Quick local run
+--------------
1. Create / ensure UAMI and bind it to backup SA (script will also apply CR)
   ./scripts/create_uami_and_bind_to_sa.sh --name uami-milvus --resource-group my-rg --subscription my-sub --namespace aegis --ksa milvus-backup-sa --mode apply --variant aad-pod-identity-v1
2. Configure Key Vault & Storage CMK:
   ./scripts/configure_keyvault_and_storage_cmk.sh --vault my-keyvault --key-name my-key --principal-id <UAMI_PRINCIPAL_ID> --storage-account mystorageacct --resource-group my-rg
3. Run orchestrator (will run drill & verify):
   ./scripts/azure_full_finalize_and_verify.sh --uami-name uami-milvus --rg my-rg --sub my-sub --namespace aegis --ksa milvus-backup-sa --vault my-keyvault --key my-key --storage-account mystorageacct --container milvus-backups --run-rotation yes
4. Inspect artifacts (logs, blob metadata, downloaded artifacts) and run Milvus restore in staging using the downloaded artifacts.
5. After successful restore & security review, sign off and update support matrix.
+
+Notes
+-----
- The orchestrator calls the existing drill and verification scripts. If your cluster uses a pod-identity operator with different CR names, adapt create_uami_and_bind_to_sa.sh or apply CRs manually.
- KMS rotation creates a new Key Vault key and grants wrap/unwrap/get permissions to the UAMI; update Helm values to use the new key before re-testing.
+
*** End Patch
