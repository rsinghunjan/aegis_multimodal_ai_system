*** Begin Patch
*** Add File:.github/workflows/safety_track_gate_and_promotion.yml
+name: Safety Track Gate & Promotion
+on:
+  pull_request:
+    types: [opened, synchronize, reopened]
+  workflow_dispatch:
+    inputs:
+      model:
+        description: 'Model name (for manual promotion)'
+        required: false
+      model_dir:
+        description: 'Path to model dir (for manual promotion)'
+        required: false
+      artifact:
+        description: 'Path to artifact (for manual promotion)'
+        required: false
+      tests:
+        description: 'Path to tests/battery (for manual promotion)'
+        required: false
+
+jobs:
+  enforce-evidence:
+    name: Enforce evidence metadata for model changes (PR gate)
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+        with:
+          fetch-depth: 0
+      - name: Setup Python
+        uses: actions/setup-python@v4
+        with:
+          python-version: '3.11'
+      - name: Install deps
+        run: pip install --upgrade pip && pip install requests
+      - name: Run evidence requirement checks
+        run: |
+          python ops/ci/require_evidence_check.py
+
+  promote-manual:
+    name: Manual Promote to Safety (human-trigger)
+    runs-on: ubuntu-latest
+    if: github.event_name == 'workflow_dispatch'
+    needs: enforce-evidence
+    steps:
+      - uses: actions/checkout@v4
+      - name: Setup Python
+        uses: actions/setup-python@v4
+        with:
+          python-version: '3.11'
+      - name: Install deps
+        run: pip install --upgrade pip && pip install requests
+      - name: Promote model to safety
+        run: |
+          python ops/ci/promote_to_safety.py \
+            --model "${{ github.event.inputs.model }}" \
+            --model-dir "${{ github.event.inputs.model_dir }}" \
+            --artifact "${{ github.event.inputs.artifact }}" \
+            --tests "${{ github.event.inputs.tests }}" \
+            --safety-registry "safety-registry/"
+
*** End Patch
*** Begin Patch
*** Add File:docs/safety_evidence_template.md
+# Safety Evidence Template (mapped to ISO 26262 / UL 4600 style artifacts)
+
+Purpose
+-------
+This template lists the required evidence artifacts and metadata to promote a model from the research track into the safety-certified track. Use this checklist to populate `models/<name>/metadata.json` and to assemble the `evidence/` bundle created by the CI promotion workflow.
+
+Required metadata fields (models/<name>/metadata.json)
+- model_name: string
+- owner: email
+- approver: email
+- git_commit: commit SHA of training code + config
+- dataset_snapshot: URI or S3 path to dataset snapshot used for training
+- training_config: path or inline config (hyperparams, seed, runtime)
+- tests: path to test battery (SIL tests)
+- release_id: optional release tag
+- instance_type: the target instance for on-device validation (if applicable)
+- region: region where heavy jobs were run
+
+Evidence bundle structure (evidence ZIP)
+- provenance.json
+  - git_commit, dataset_snapshot, model_artifact_hash, training_config, builder_image
+- verification.json
+  - verifier outputs (NLI+CAS results), pass/fail, failing cases, logs
+- prover_results.json (if targeted prover ran)
+  - SMT/Z3/Prover outputs and status
+- tests/
+  - SIL run logs, scenario definitions, failing scenario traces (if any)
+- hil/
+  - HIL run logs, device identifiers, build/config used
+- metrics/
+  - per-job carbon report (if applicable), performance metrics, latency profiles
+- monitors/
+  - runtime monitor config used in production (invariants.json)
+- metadata.json
+  - includes owner/approver/timestamps and signed approval (or approval pointer)
+- signature (sig)
+  - cryptographic signature of the bundle or HSM-backed signature pointer
+
+Mapping to ISO/UL
+- Requirement traceability: each test in tests/ must reference the system-level requirement it validates.
+- Test coverage matrix: include mapping tests → requirements → pass/fail in verification.json.
+- Evidence for configuration management: include builder image hashes and runtime env in provenance.json.
+- Safety case notes: include a short human-readable rationale document (safety_case.md) describing limits, assumptions and open items.
+
+How to use
+- Populate models/<name>/metadata.json before requesting promotion.
+- Run the "Promote Model to Safety Track" workflow; it will generate the evidence bundle and place it in safety registry on success.
+- Keep the evidence bundle and produce a separate audit package using ops/carbon/audit_packager.py if third-party review is required.
+
*** End Patch
*** Begin Patch
*** Add File:k8s/argo/workflows/safety_pipeline.yaml
+apiVersion: argoproj.io/v1alpha1
+kind: Workflow
+metadata:
+  generateName: safety-pipeline-
+  namespace: aegis-retriever
+spec:
+  entrypoint: safety-pipeline
+  templates:
+    - name: safety-pipeline
+      inputs:
+        parameters:
+          - name: model-name
+          - name: model-dir
+          - name: artifact-path
+          - name: tests-path
+          - name: invariants-path
+      steps:
+        - - name: run-sil
+            template: sil-run
+            arguments:
+              parameters:
+                - name: model-name
+                  value: "{{inputs.parameters.model-name}}"
+                - name: model-dir
+                  value: "{{inputs.parameters.model-dir}}"
+                - name: tests-path
+                  value: "{{inputs.parameters.tests-path}}"
+        - - name: verify-with-cas
+            template: verification
+            arguments:
+              parameters:
+                - name: artifact
+                  value: "{{inputs.parameters.artifact-path}}"
+                - name: tests
+                  value: "{{inputs.parameters.tests-path}}"
+        - - name: run-hil
+            template: hil-run
+            when: "{{inputs.parameters.invariants-path}} != ''"
+            arguments:
+              parameters:
+                - name: model-name
+                  value: "{{inputs.parameters.model-name}}"
+                - name: artifact
+                  value: "{{inputs.parameters.artifact-path}}"
+        - - name: package-evidence
+            template: package-evidence
+            arguments:
+              parameters:
+                - name: model-name
+                  value: "{{inputs.parameters.model-name}}"
+                - name: artifact
+                  value: "{{inputs.parameters.artifact-path}}"
+                - name: prov
+                  value: '{}'
+        - - name: promote
+            template: promote
+            arguments:
+              parameters:
+                - name: model-name
+                  value: "{{inputs.parameters.model-name}}"
+                - name: model-dir
+                  value: "{{inputs.parameters.model-dir}}"
+                - name: artifact
+                  value: "{{inputs.parameters.artifact-path}}"
+                - name: tests
+                  value: "{{inputs.parameters.tests-path}}"
+                - name: invariants
+                  value: "{{inputs.parameters.invariants-path}}"
+
+    - name: sil-run
+      inputs:
+        parameters:
+          - name: model-name
+          - name: model-dir
+          - name: tests-path
+      container:
+        image: aegis/sil-runner:latest
+        command: ["/bin/sh", "-c"]
+        args:
+          - |
+            echo "Running SIL for {{inputs.parameters.model-name}}"
+            python ops/simulation/run_sil.py --model-dir "{{inputs.parameters.model-dir}}" --tests "{{inputs.parameters.tests-path}}" || exit 1
+
+    - name: verification
+      inputs:
+        parameters:
+          - name: artifact
+          - name: tests
+      container:
+        image: aegis/carbon-tools:latest
+        command: ["/bin/sh", "-c"]
+        args:
+          - |
+            echo "Running verification service"
+            python ops/safety/verification_service.py --model "work" --artifact "{{inputs.parameters.artifact}}" --tests "{{inputs.parameters.tests}}" || exit 1
+
+    - name: hil-run
+      inputs:
+        parameters:
+          - name: model-name
+          - name: artifact
+      container:
+        image: aegis/hil-runner:latest
+        command: ["/bin/sh", "-c"]
+        args:
+          - |
+            echo "Running HIL for {{inputs.parameters.model-name}}"
+            python ops/hil/run_hil.py --artifact "{{inputs.parameters.artifact}}" || exit 1
+
+    - name: package-evidence
+      inputs:
+        parameters:
+          - name: model-name
+          - name: artifact
+          - name: prov
+      container:
+        image: aegis/carbon-tools:latest
+        command: ["/bin/sh", "-c"]
+        args:
+          - |
+            python ops/evidence/evidence_packager.py --model "{{inputs.parameters.model-name}}" --artifact "{{inputs.parameters.artifact}}" --evidence "/tmp/fake_verification.json" --prov '{{inputs.parameters.prov}}' --meta '{}' || exit 1
+
+    - name: promote
+      inputs:
+        parameters:
+          - name: model-name
+          - name: model-dir
+          - name: artifact
+          - name: tests
+          - name: invariants
+      container:
+        image: aegis/carbon-tools:latest
+        command: ["/bin/sh", "-c"]
+        args:
+          - |
+            python ops/ci/promote_to_safety.py --model "{{inputs.parameters.model-name}}" --model-dir "{{inputs.parameters.model-dir}}" --artifact "{{inputs.parameters.artifact}}" --tests "{{inputs.parameters.tests}}" --invariants "{{inputs.parameters.invariants}}" --safety-registry "/artifacts/safety-registry" || exit 1
+
*** End Patch
*** End Patch
