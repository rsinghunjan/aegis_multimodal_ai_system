*** Begin Patch
*** Add File:ops/ci/run_end_to_end_safety_check.py
+#!/usr/bin/env python3
+"""
+End-to-end safety check orchestrator (SIL -> verification -> SMT proof -> proof certificate -> sign -> package)
+
+Purpose:
+ - Demonstrate and exercise the full safety evidence pipeline on a toy model.
+ - Steps:
+   1. Run SIL (software-in-loop) scenario battery
+   2. Run verification_service to produce verification evidence
+   3. Author a simple invariant and emit SMT stub
+   4. Run targeted_prover_z3 to attempt discharge of SMT
+   5. Collect proof artifacts via proof_certifier
+   6. Package evidence with evidence_packager and sign the artifact
+
+Usage:
+  python ops/ci/run_end_to_end_safety_check.py --model toy-model
+
+Outputs:
+ - Evidence ZIP and signature written under EVIDENCE_ROOT (default /tmp/safety_evidence)
+ - Proof artifacts in VERIFIER_LOG_DIR (default /tmp/verifier_logs)
+ - Prover summary at PROVER_SUMMARY_OUT (/tmp/prover_summary.json)
+ - Final printed locations for artifacts
+"""
+import os
+import sys
+import json
+import subprocess
+from datetime import datetime
+
+# defaults (can be overridden via env)
+MODEL = os.environ.get("E2E_MODEL", "toy-model")
+MODEL_DIR = os.environ.get("E2E_MODEL_DIR", f"models/{MODEL}")
+ARTIFACT = os.environ.get("E2E_ARTIFACT", f"{MODEL_DIR}/artifact.txt")
+TESTS = os.environ.get("E2E_TESTS", f"{MODEL_DIR}/tests")
+INVAR_ID = os.environ.get("E2E_INVARIANT_ID", f"{MODEL}_inv_1")
+INVAR_EXPR = os.environ.get("E2E_INVARIANT_EXPR", "stopping_dist <= 100")  # toy invariant
+SMT_TACTIC = os.environ.get("E2E_INVARIANT_TACTIC", "interval")
+
+# modules we will call
+from ops.simulation.run_sil import run as run_sil
+from ops.safety.verification_service import verify_model
+from ops.formal.invariant_authoring_tool import add_invariant
+from ops.formal.targeted_prover_z3 import prove_all
+from ops.formal.prover_orchestrator import run_and_annotate
+from ops.verifier.proof_certifier import write_and_sign
+from ops.evidence.evidence_packager import package
+
+def run():
+    print("E2E Safety Check Start:", datetime.utcnow().isoformat()+"Z")
+    # 1) SIL
+    print("1) Running SIL...")
+    try:
+        run_sil(MODEL_DIR, TESTS)
+    except Exception as e:
+        print("SIL failed:", e)
+        # continue to gather evidence of failure
+
+    # 2) Verification service
+    print("2) Running verification_service...")
+    try:
+        ver = verify_model(MODEL, ARTIFACT, TESTS, invariants_path=None)
+        # verify_model returns dict with verdict and evidence path
+        print("Verification result:", ver.get("verdict"))
+        verification_evidence = ver.get("evidence")
+    except Exception as e:
+        print("verification_service failed:", e)
+        verification_evidence = None
+
+    # 3) Author a toy invariant (writes SMT scaffold)
+    print("3) Adding invariant via invariant_authoring_tool...")
+    try:
+        smt_path = add_invariant(INVAR_ID, {"expr": INVAR_EXPR}, tactic_hint=SMT_TACTIC)
+        print("Wrote SMT stub to", smt_path)
+    except Exception as e:
+        print("Failed to add invariant:", e)
+        smt_path = None
+
+    # 4) Run targeted prover (Z3) on SMT stubs
+    print("4) Running targeted prover (Z3) on SMT stubs...")
+    try:
+        prover_results = prove_all(timeout_s=20)
+        print("Prover attempted", len(prover_results), "files")
+    except Exception as e:
+        print("targeted_prover_z3 failed:", e)
+        prover_results = []
+
+    # 5) Annotate registry and produce prover summary (prover_orchestrator run does this)
+    print("5) Orchestrating prover annotation...")
+    try:
+        summary = run_and_annotate()
+        print("Prover summary written to", os.environ.get("PROVER_SUMMARY_OUT", "/tmp/prover_summary.json"))
+    except Exception as e:
+        print("prover_orchestrator failed:", e)
+        summary = {}
+
+    # 6) Collect proof cert and optionally sign
+    print("6) Collecting proofs & producing certificate...")
+    try:
+        cert_path = write_and_sign()
+        print("Certificate:", cert_path)
+    except Exception as e:
+        print("proof_certifier failed:", e)
+        cert_path = None
+
+    # 7) Package the evidence bundle (use evidence_packager)
+    print("7) Packaging evidence bundle...")
+    prov = {"git_commit": "example-deadbeef", "generated_at": datetime.utcnow().isoformat()+"Z"}
+    metadata = {"owner": "ops@example.com", "notes": "E2E safety check run"}
+    try:
+        # use verification evidence if present, else use proof cert as evidence
+        ev = verification_evidence or cert_path or "/dev/null"
+        bundle, sig = package(MODEL, ARTIFACT, ev, prov, metadata)
+        print("Evidence bundle:", bundle)
+        print("Signature:", sig)
+    except Exception as e:
+        print("evidence_packager failed:", e)
+        bundle = None
+        sig = None
+
+    print("E2E Safety Check Completed.")
+    return {"verification_evidence": verification_evidence, "smt_path": smt_path, "prover_summary": summary, "cert": cert_path, "bundle": bundle, "sig": sig}
+
+if __name__ == "__main__":
+    import argparse
+    p = argparse.ArgumentParser()
+    p.add_argument("--model", default=MODEL)
+    p.add_argument("--model-dir", default=MODEL_DIR)
+    p.add_argument("--artifact", default=ARTIFACT)
+    p.add_argument("--tests", default=TESTS)
+    p.add_argument("--inv-id", default=INVAR_ID)
+    p.add_argument("--inv-expr", default=INVAR_EXPR)
+    args = p.parse_args()
+    # override global names from args
+    MODEL = args.model
+    MODEL_DIR = args.model_dir
+    ARTIFACT = args.artifact
+    TESTS = args.tests
+    INVAR_ID = args.inv_id
+    INVAR_EXPR = args.inv_expr
+    res = run()
+    print(json.dumps(res, indent=2))
+
*** End Patch
*** Begin Patch
*** Add File:.github/workflows/safety_e2e_prover.yml
+name: Safety E2E Proof & Evidence CI
+on:
+  workflow_dispatch:
+  schedule:
+    - cron: '0 6 * * 0' # weekly
+
+jobs:
+  safety-e2e:
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - name: Set up Python
+        uses: actions/setup-python@v4
+        with:
+          python-version: '3.11'
+      - name: Install dependencies
+        run: |
+          python -m pip install --upgrade pip
+          pip install requests cryptography sentence-transformers transformers datasets
+      - name: Run end-to-end safety check (SIL->verify->prover->cert->package)
+        run: |
+          python ops/ci/run_end_to_end_safety_check.py --model toy-model
+      - name: Upload artifacts
+        uses: actions/upload-artifact@v4
+        with:
+          name: safety-e2e-artifacts
+          path: |
+            /tmp/safety_evidence
+            /tmp/verifier_logs
+            /tmp/prover_summary.json
+            /tmp/proof_certificate.json
+
*** End Patch
*** Begin Patch
*** Add File:ops/formal/sample_smt_examples/README.md
+Sample SMT examples & notes
+--------------------------
+
+This directory is populated at runtime by ops/formal/invariant_authoring_tool.py when you add an invariant.
+The SMT stubs produced are scaffolds and must be replaced with proper SMT-LIB encodings for your domain.
+
+Example workflow:
+  python ops/formal/invariant_authoring_tool.py --id toy_inv_1 --expr "stopping_dist <= 100" --tactic interval
+  # emits /tmp/invariant_smt/toy_inv_1.smt2 (SMT stub)
+  python ops/formal/targeted_prover_z3.py --timeout 20
+
*** End Patch
*** End Patch
