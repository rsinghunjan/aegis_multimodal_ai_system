*** Begin Patch
*** Add File:policy/opa/constrainttemplate_mcp.yaml
+apiVersion: templates.gatekeeper.sh/v1
+kind: ConstraintTemplate
+metadata:
+  name: k8srequiredmcp
+spec:
+  crd:
+    spec:
+      names:
+        kind: K8sRequiredMCP
+  targets:
+    - target: admission.k8s.gatekeeper.sh
+      rego: |
+        package k8srequiredmcp
+
+        violation[{"msg": msg}] {
+          input.review.object.kind == "Deployment"
+          ns := input.review.object.metadata.namespace
+          # only enforce in aegis namespaces (adjust as needed)
+          ns == "aegis" or ns == "aegis-prod" or ns == "aegis-staging"
+          not has_mcp_annotation
+          msg := "Deployment blocked by MCP policy: missing annotation 'aegis/mcp-uri' pointing to the Model Context Protocol (MCP) document"
+        }
+
+        has_mcp_annotation {
+          anno := input.review.object.metadata.annotations
+          anno["aegis/mcp-uri"]
+        }
+
*** End Patch
*** Begin Patch
*** Add File:policy/opa/constraint_mcp.yaml
+apiVersion: constraints.gatekeeper.sh/v1beta1
+kind: K8sRequiredMCP
+metadata:
+  name: require-mcp-for-deployments
+spec:
+  match:
+    kinds:
+      - apiGroups: [""]
+        kinds: ["Deployment"]
+    namespaces: ["aegis","aegis-staging","aegis-prod"]
+
*** End Patch
*** Begin Patch
*** Add File:tools/mcp_validate_cli.py
+#!/usr/bin/env python3
+"""
+mcp_validate_cli.py
+--------------------
+Simple CLI that validates presence of an MCP (Model Context Protocol) document for a model.
+Checks either:
+ - explicit MCP URI (--mcp-uri)
+ - or S3 bucket path convention: s3://<bucket>/mcp/<model_id>-<model_version>.json
+ - or MCP API endpoint (AEGIS API) /api/mcp/<model_id>/<model_version>
+
+Exits:
+  0 when MCP found
+  1 for usage / missing params
+  2 when MCP not found or invalid
+
+Usage examples:
+  python3 tools/mcp_validate_cli.py --model-id mymodel --model-version v1 --s3-bucket aegis-models
+  python3 tools/mcp_validate_cli.py --mcp-uri https://s3.amazonaws.com/aegis-models/mcp/mymodel-v1.json
+  python3 tools/mcp_validate_cli.py --model-id mymodel --model-version v1 --api-url http://aegis-api:8081/api
+"""
+import argparse, sys, os, requests
+
+def check_mcp_uri(uri):
+    try:
+        # support s3:// by converting to https if needed; for s3 we rely on presigned or public; otherwise use HEAD
+        if uri.startswith("s3://"):
+            # try to use AWS SDK if available (boto3) for authenticated access
+            try:
+                import boto3
+                from urllib.parse import urlparse
+                p = urlparse(uri)
+                bucket = p.netloc
+                key = p.path.lstrip("/")
+                s3 = boto3.client("s3")
+                s3.head_object(Bucket=bucket, Key=key)
+                return True
+            except Exception:
+                # fallback to http/https try (not guaranteed)
+                pass
+        # try HTTP head/get
+        r = requests.head(uri, timeout=10)
+        if r.status_code == 200:
+            return True
+        # try GET as last resort
+        r = requests.get(uri, timeout=10)
+        return r.status_code == 200
+    except Exception:
+        return False
+
+def check_api(api_url, model_id, model_version):
+    try:
+        url = api_url.rstrip("/") + f"/mcp/{model_id}/{model_version}"
+        r = requests.get(url, timeout=10)
+        return r.status_code == 200
+    except Exception:
+        return False
+
+def main():
+    p = argparse.ArgumentParser()
+    p.add_argument("--mcp-uri", help="Explicit URI to MCP JSON (s3:// or https://)")
+    p.add_argument("--model-id", help="Model id (used with --s3-bucket or --api-url)")
+    p.add_argument("--model-version", help="Model version")
+    p.add_argument("--s3-bucket", help="S3 bucket where MCPs are stored under mcp/<model>-<ver>.json")
+    p.add_argument("--api-url", help="AEGIS API base URL to query MCP (e.g., http://aegis-api:8081/api)")
+    args = p.parse_args()
+
+    if args.mcp_uri:
+        ok = check_mcp_uri(args.mcp_uri)
+        if ok:
+            print("MCP found at", args.mcp_uri)
+            sys.exit(0)
+        else:
+            print("MCP not reachable at", args.mcp_uri, file=sys.stderr)
+            sys.exit(2)
+
+    if args.api_url and args.model_id and args.model_version:
+        if check_api(args.api_url, args.model_id, args.model_version):
+            print("MCP exists via API")
+            sys.exit(0)
+        else:
+            print("MCP not found via API", args.api_url, file=sys.stderr)
+            sys.exit(2)
+
+    if args.s3_bucket and args.model_id and args.model_version:
+        key = f"s3://{args.s3_bucket}/mcp/{args.model_id}-{args.model_version}.json"
+        if check_mcp_uri(key):
+            print("MCP found in S3 at", key)
+            sys.exit(0)
+        else:
+            print("MCP not found in S3 at", key, file=sys.stderr)
+            sys.exit(2)
+
+    print("Usage: provide --mcp-uri OR (--model-id --model-version and --s3-bucket OR --api-url)", file=sys.stderr)
+    sys.exit(1)
+
+if __name__ == "__main__":
+    main()
+
*** End Patch
*** Begin Patch
*** Update File:ci/serving/promote_and_verify.sh
@@
 - err_ok=$(awk "BEGIN{print (${err} <= ${MAX_ERROR_RATE}) ? 1 : 0}")
 if [ "${lat_ok}" -eq 1 ] && [ "${err_ok}" -eq 1 ]; then
   echo "SLI check passed. Promotion complete."
   exit 0
 else
   echo "SLI check failed. Rolling back to ${old_image}"
   kubectl -n "${NAMESPACE}" set image deployment/"${DEPLOY}" "${DEPLOY}"="${old_image}"
   kubectl -n "${NAMESPACE}" rollout status deployment/"${DEPLOY}" --timeout=120s
   echo "Rollback complete."
   exit 2
 fi
+
+# --- MCP validation hook: ensure Model Context Protocol (MCP) exists before promoting ---
+# Environment variables required for MCP validation (set in CI or before calling promote script):
+# - MODEL_ID, MODEL_VERSION, MCP_S3_BUCKET or MCP_API_URL
+if [ -n "${MODEL_ID:-}" ] && [ -n "${MODEL_VERSION:-}" ]; then
+  echo "Validating MCP for ${MODEL_ID}:${MODEL_VERSION}"
+  python3 tools/mcp_validate_cli.py --model-id "${MODEL_ID}" --model-version "${MODEL_VERSION}" --s3-bucket "${MCP_S3_BUCKET:-}" --api-url "${MCP_API_URL:-}" || (echo "MCP validation failed; aborting promotion" && exit 3)
+else
+  echo "MODEL_ID / MODEL_VERSION not set; skipping MCP validation hook (ci/policy may require it)"
+fi
+
*** End Patch
*** Begin Patch
*** Add File:tools/check_testrun_status.py
+#!/usr/bin/env python3
+"""
+Check TestRun CR status using kubectl. Waits until status.state is one of Completed/Failed or times out.
+
+Usage:
+  python3 tools/check_testrun_status.py --name qa-testrun-example --namespace aegis-test --timeout 600
+"""
+import argparse, subprocess, time, json, sys
+
+def get_status(name, ns):
+    try:
+        out = subprocess.check_output(["kubectl","-n",ns,"get","testrun",name,"-o","json"], stderr=subprocess.DEVNULL)
+        obj = json.loads(out)
+        return obj.get("status",{}).get("state","")
+    except subprocess.CalledProcessError:
+        return ""
+
+def main():
+    p = argparse.ArgumentParser()
+    p.add_argument("--name", required=True)
+    p.add_argument("--namespace", default="aegis-test")
+    p.add_argument("--timeout", type=int, default=600)
+    args = p.parse_args()
+    start = time.time()
+    while time.time() - start < args.timeout:
+        s = get_status(args.name, args.namespace)
+        print("Status:", s)
+        if s in ("Completed","Failed"):
+            print("Final status:", s)
+            sys.exit(0 if s=="Completed" else 2)
+        time.sleep(5)
+    print("Timed out waiting for TestRun", args.name, file=sys.stderr)
+    sys.exit(3)
+
+if __name__ == "__main__":
+    main()
+
*** End Patch
*** Begin Patch
*** Add File:.github/workflows/require_testrun_and_mcp.yml
+name: Require TestRun & MCP for PRs
+
+on:
+  pull_request:
+    types: [opened, synchronize, reopened]
+
+jobs:
+  run-qa-and-validate-mcp:
+    runs-on: ubuntu-latest
+    timeout-minutes: 60
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Set up kubectl
+        uses: azure/setup-kubectl@v3
+        with:
+          version: 'v1.27.0'
+
+      - name: Configure Kubeconfig
+        env:
+          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
+        run: |
+          echo "$KUBECONFIG_DATA" | base64 --decode > kubeconfig
+          export KUBECONFIG=$PWD/kubeconfig
+
+      - name: Create TestRun CR for PR
+        env:
+          KUBECONFIG: ${{ github.workspace }}/kubeconfig
+        run: |
+          NAME="qa-testrun-${GITHUB_SHA::8}"
+          cat <<EOF | kubectl apply -f -
+          apiVersion: aegis.ai/v1
+          kind: TestRun
+          metadata:
+            name: $NAME
+            namespace: aegis-test
+          spec:
+            test_type: "pr-e2e"
+            parameters:
+              pr: "${{ github.event.number }}"
+              image_tag: "qa"
+          EOF
+          echo "Created TestRun $NAME"
+          echo "TESTRUN_NAME=$NAME" >> $GITHUB_ENV
+
+      - name: Wait for TestRun completion
+        env:
+          KUBECONFIG: ${{ github.workspace }}/kubeconfig
+        run: |
+          python3 tools/check_testrun_status.py --name "${{ env.TESTRUN_NAME }}" --namespace aegis-test --timeout 1800
+
+      - name: Validate MCP exists (S3)
+        env:
+          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
+          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
+          AWS_REGION: ${{ secrets.AWS_REGION }}
+        run: |
+          # MODEL_ID and MODEL_VERSION should be determined by your CI/callers; set via repo config or PR labels
+          MODEL_ID="${{ github.event.pull_request.title }}" || true
+          MODEL_VERSION="${{ github.sha::8 }}" || true
+          # For PR-level enforcement, you may want to set these via PR body/label or infer from pipeline output
+          echo "Attempting MCP validation for model ${MODEL_ID}:${MODEL_VERSION}"
+          python3 tools/mcp_validate_cli.py --model-id "${MODEL_ID}" --model-version "${MODEL_VERSION}" --s3-bucket "${{ secrets.MODEL_ARTIFACT_BUCKET }}" || (echo "MCP validation failed" && exit 1)
+
+      - name: Report success
+        run: echo "TestRun passed and MCP validated. PR may proceed."
+
*** End Patch
*** End Patch
